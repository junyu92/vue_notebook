<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.26">
    <title>PCI | Notebook</title><meta name="description" content="">
    <link rel="preload" href="/vue_notebook/assets/js/runtime~app.47f1fcf0.js" as="script"><link rel="preload" href="/vue_notebook/assets/css/styles.799329ce.css" as="style"><link rel="preload" href="/vue_notebook/assets/js/1812.154fe714.js" as="script"><link rel="preload" href="/vue_notebook/assets/js/app.1f287e75.js" as="script">
    <link rel="stylesheet" href="/vue_notebook/assets/css/styles.799329ce.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/vue_notebook/" class=""><!----><span class="site-name">Notebook</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><!----><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><!----><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item active">Kernel</p><ul class=""><li><!--[--><p class="sidebar-item">Booting and Initialization</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/boot/entry.html" class="nav-link sidebar-item" aria-label="Kernel entry point"><!--[--><!--]--> Kernel entry point <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/boot/kaslr.html" class="nav-link sidebar-item" aria-label="Kernel Address Space Layout Randomization"><!--[--><!--]--> Kernel Address Space Layout Randomization <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Memory Management</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/memory/memory_order.html" class="nav-link sidebar-item" aria-label="Memory Ordering"><!--[--><!--]--> Memory Ordering <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/memory/cache.html" class="nav-link sidebar-item" aria-label="Cache"><!--[--><!--]--> Cache <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/memory/memory_tagging_extension.html" class="nav-link sidebar-item" aria-label="Memory Tagging Extension"><!--[--><!--]--> Memory Tagging Extension <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/memory/arm64_fault.html" class="nav-link sidebar-item" aria-label="ARM64 Fault"><!--[--><!--]--> ARM64 Fault <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/memory/virtualization.html" class="nav-link sidebar-item" aria-label="Memory Virtualization"><!--[--><!--]--> Memory Virtualization <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Task</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/task/idle.md" class="nav-link sidebar-item" aria-label="/kernel/task/idle.md"><!--[--><!--]--> /kernel/task/idle.md <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/task/thread_info.html" class="nav-link sidebar-item" aria-label="Thread Info"><!--[--><!--]--> Thread Info <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Scheduler</p><!----><!--]--></li><li><!--[--><p class="sidebar-item">Syscall</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/syscall/vdso.md" class="nav-link sidebar-item" aria-label="/kernel/syscall/vdso.md"><!--[--><!--]--> /kernel/syscall/vdso.md <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Interrupt Management</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/interrupt/interrupt_in_linux.html" class="nav-link sidebar-item" aria-label="Interrupt in Linux"><!--[--><!--]--> Interrupt in Linux <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/interrupt/gic.html" class="nav-link sidebar-item" aria-label="GIC"><!--[--><!--]--> GIC <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/interrupt/its.html" class="nav-link sidebar-item" aria-label="Interrupt Translation Service"><!--[--><!--]--> Interrupt Translation Service <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Time Management</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/time/time_in_linux.html" class="nav-link sidebar-item" aria-label="Time Framework in Linux"><!--[--><!--]--> Time Framework in Linux <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/time/clocksource_and_timekeeping.html" class="nav-link sidebar-item" aria-label="Clocksource and Timerkeeping"><!--[--><!--]--> Clocksource and Timerkeeping <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/time/jiffies.html" class="nav-link sidebar-item" aria-label="Jiffies"><!--[--><!--]--> Jiffies <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/time/clockevents.html" class="nav-link sidebar-item" aria-label="Clockevents"><!--[--><!--]--> Clockevents <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/time/timer.html" class="nav-link sidebar-item" aria-label="(Hardware) Timer"><!--[--><!--]--> (Hardware) Timer <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/time/hrtimer.html" class="nav-link sidebar-item" aria-label="High resolution timers"><!--[--><!--]--> High resolution timers <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/time/dynamic_timer.html" class="nav-link sidebar-item" aria-label="Dynamic Timer"><!--[--><!--]--> Dynamic Timer <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/time/tick_broadcast.html" class="nav-link sidebar-item" aria-label="Tick Broadcast"><!--[--><!--]--> Tick Broadcast <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">IPC</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/ipc/signal.md" class="nav-link sidebar-item" aria-label="/kernel/ipc/signal.md"><!--[--><!--]--> /kernel/ipc/signal.md <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/ipc/wait.html" class="nav-link sidebar-item" aria-label="Wait"><!--[--><!--]--> Wait <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/ipc/eventfd.html" class="nav-link sidebar-item" aria-label="eventfd"><!--[--><!--]--> eventfd <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Synchronization</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/sync/spinlock.md" class="nav-link sidebar-item" aria-label="/kernel/sync/spinlock.md"><!--[--><!--]--> /kernel/sync/spinlock.md <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/sync/mutex.md" class="nav-link sidebar-item" aria-label="/kernel/sync/mutex.md"><!--[--><!--]--> /kernel/sync/mutex.md <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/sync/semaphore.md" class="nav-link sidebar-item" aria-label="/kernel/sync/semaphore.md"><!--[--><!--]--> /kernel/sync/semaphore.md <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/sync/rcu.md" class="nav-link sidebar-item" aria-label="/kernel/sync/rcu.md"><!--[--><!--]--> /kernel/sync/rcu.md <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item active">Device Driver</p><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/vue_notebook/kernel/driver/pci.html" class="router-link-active router-link-exact-active nav-link router-link-active sidebar-item active" aria-label="PCI"><!--[--><!--]--> PCI <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Power Management</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/power/psci.html" class="nav-link sidebar-item" aria-label="PSCI"><!--[--><!--]--> PSCI <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Trace</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/trace/lockup.html" class="nav-link sidebar-item" aria-label="lockup detection"><!--[--><!--]--> lockup detection <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/trace/walk_stack_on_arm.html" class="nav-link sidebar-item" aria-label="Walk stack on ARM"><!--[--><!--]--> Walk stack on ARM <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/trace/aarch64_debug.html" class="nav-link sidebar-item" aria-label="AArch64 Debug"><!--[--><!--]--> AArch64 Debug <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/trace/pmu.html" class="nav-link sidebar-item" aria-label="Performance Monitor Unit"><!--[--><!--]--> Performance Monitor Unit <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/trace/spe.html" class="nav-link sidebar-item" aria-label="Statistical Profiling Extension"><!--[--><!--]--> Statistical Profiling Extension <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/trace/kprobes.html" class="nav-link sidebar-item" aria-label="kprobes"><!--[--><!--]--> kprobes <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/trace/ftrace.html" class="nav-link sidebar-item" aria-label="ftrace"><!--[--><!--]--> ftrace <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Misc</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/misc/rseq.html" class="nav-link sidebar-item" aria-label="Restartable Sequences"><!--[--><!--]--> Restartable Sequences <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/misc/export_symbol.html" class="nav-link sidebar-item" aria-label="Export Kernel Symbol"><!--[--><!--]--> Export Kernel Symbol <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/misc/uefi.html" class="nav-link sidebar-item" aria-label="UEFI"><!--[--><!--]--> UEFI <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/misc/dtb.html" class="nav-link sidebar-item" aria-label="Device Tree"><!--[--><!--]--> Device Tree <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Virtualization</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/virtualization/vfio.html" class="nav-link sidebar-item" aria-label="VFIO"><!--[--><!--]--> VFIO <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/virtualization/secure_virt.html" class="nav-link sidebar-item" aria-label="Secure Virtualization"><!--[--><!--]--> Secure Virtualization <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">Rust</p><ul class=""><li><!--[--><a href="/vue_notebook/rust/" class="nav-link sidebar-item" aria-label="Rust"><!--[--><!--]--> Rust <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/rust/trait.html" class="nav-link sidebar-item" aria-label="Trait"><!--[--><!--]--> Trait <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/rust/pin.html" class="nav-link sidebar-item" aria-label="Pin"><!--[--><!--]--> Pin <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/rust/kernel_module_in_rust.html" class="nav-link sidebar-item" aria-label="Kernel Module in Rust"><!--[--><!--]--> Kernel Module in Rust <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">Debug</p><ul class=""><li><!--[--><a href="/vue_notebook/debug/gdb_python.html" class="nav-link sidebar-item" aria-label="GDB Python"><!--[--><!--]--> GDB Python <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">Qemu</p><ul class=""><li><!--[--><a href="/vue_notebook/qemu/pci.html" class="nav-link sidebar-item" aria-label="PCI"><!--[--><!--]--> PCI <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">trusted computing</p><ul class=""><li><!--[--><a href="/vue_notebook/trusted_computing/sgx.html" class="nav-link sidebar-item" aria-label="Intel SGX"><!--[--><!--]--> Intel SGX <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="pci" tabindex="-1"><a class="header-anchor" href="#pci" aria-hidden="true">#</a> PCI</h1><nav class="table-of-contents"><ul><li><a aria-current="page" href="/vue_notebook/kernel/driver/pci.html#architecture" class="router-link-active router-link-exact-active">Architecture</a><ul><li><a aria-current="page" href="/vue_notebook/kernel/driver/pci.html#host-bridge" class="router-link-active router-link-exact-active">Host Bridge</a></li><li><a aria-current="page" href="/vue_notebook/kernel/driver/pci.html#pci-bus" class="router-link-active router-link-exact-active">PCI Bus</a></li><li><a aria-current="page" href="/vue_notebook/kernel/driver/pci.html#pci-device" class="router-link-active router-link-exact-active">PCI Device</a></li></ul></li><li><a aria-current="page" href="/vue_notebook/kernel/driver/pci.html#type-0-pci-configuration-space-non-bridge" class="router-link-active router-link-exact-active">Type 0 PCI Configuration Space (Non-bridge)</a><ul><li><a aria-current="page" href="/vue_notebook/kernel/driver/pci.html#standardized-registers" class="router-link-active router-link-exact-active">Standardized registers</a></li></ul></li><li><a aria-current="page" href="/vue_notebook/kernel/driver/pci.html#type-1-pci-configuration-space" class="router-link-active router-link-exact-active">Type 1 PCI Configuration Space</a></li><li><a aria-current="page" href="/vue_notebook/kernel/driver/pci.html#msi-and-msi-x" class="router-link-active router-link-exact-active">MSI and MSI-X</a><ul><li><a aria-current="page" href="/vue_notebook/kernel/driver/pci.html#msi-capability" class="router-link-active router-link-exact-active">MSI capability</a></li><li><a aria-current="page" href="/vue_notebook/kernel/driver/pci.html#msi-x-table" class="router-link-active router-link-exact-active">MSI-X Table</a></li><li><a aria-current="page" href="/vue_notebook/kernel/driver/pci.html#msi-x-capability" class="router-link-active router-link-exact-active">MSI-X capability</a></li></ul></li><li><a aria-current="page" href="/vue_notebook/kernel/driver/pci.html#linux" class="router-link-active router-link-exact-active">Linux</a><ul><li><a aria-current="page" href="/vue_notebook/kernel/driver/pci.html#pci-bus-1" class="router-link-active router-link-exact-active">PCI Bus</a></li><li><a aria-current="page" href="/vue_notebook/kernel/driver/pci.html#msi-desc" class="router-link-active router-link-exact-active">msi_desc</a></li><li><a aria-current="page" href="/vue_notebook/kernel/driver/pci.html#pci-device-1" class="router-link-active router-link-exact-active">PCI Device</a></li></ul></li><li><a aria-current="page" href="/vue_notebook/kernel/driver/pci.html#pci-structure-from-qemu-view" class="router-link-active router-link-exact-active">PCI Structure from QEMU view</a></li><li><a aria-current="page" href="/vue_notebook/kernel/driver/pci.html#msi" class="router-link-active router-link-exact-active">MSI</a><ul><li><a aria-current="page" href="/vue_notebook/kernel/driver/pci.html#introduction" class="router-link-active router-link-exact-active">Introduction</a></li><li><a aria-current="page" href="/vue_notebook/kernel/driver/pci.html#msi-and-msix" class="router-link-active router-link-exact-active">MSI and MSIX</a></li><li><a aria-current="page" href="/vue_notebook/kernel/driver/pci.html#how-to-use-msis" class="router-link-active router-link-exact-active">How to use MSIs</a></li><li><a aria-current="page" href="/vue_notebook/kernel/driver/pci.html#implementation" class="router-link-active router-link-exact-active">Implementation</a></li></ul></li><li><a aria-current="page" href="/vue_notebook/kernel/driver/pci.html#reference" class="router-link-active router-link-exact-active">Reference</a></li></ul></nav><h2 id="architecture" tabindex="-1"><a class="header-anchor" href="#architecture" aria-hidden="true">#</a> Architecture</h2><h3 id="host-bridge" tabindex="-1"><a class="header-anchor" href="#host-bridge" aria-hidden="true">#</a> Host Bridge</h3><h3 id="pci-bus" tabindex="-1"><a class="header-anchor" href="#pci-bus" aria-hidden="true">#</a> PCI Bus</h3><h3 id="pci-device" tabindex="-1"><a class="header-anchor" href="#pci-device" aria-hidden="true">#</a> PCI Device</h3><h2 id="type-0-pci-configuration-space-non-bridge" tabindex="-1"><a class="header-anchor" href="#type-0-pci-configuration-space-non-bridge" aria-hidden="true">#</a> Type 0 PCI Configuration Space (Non-bridge)</h2><p>PCI configuration space is the underlying way that the <em>Conventional PCI</em>, <em>PCI-X</em> and <em>PCI Express</em> perform auto configuration of cards into their bus.</p><h3 id="standardized-registers" tabindex="-1"><a class="header-anchor" href="#standardized-registers" aria-hidden="true">#</a> Standardized registers</h3><p><img src="/vue_notebook/assets/img/Pci-config-space.6dee84cd.svg" alt="PCI Standardized registers"></p><h4 id="vendor-id-and-device-id" tabindex="-1"><a class="header-anchor" href="#vendor-id-and-device-id" aria-hidden="true">#</a> Vendor ID and Device ID</h4><p>identify the device.</p><p>The 16-bit vendor ID is allocated by the <em>PCI-SIG</em>. The 16-bit device ID is then assigned by the vendor.</p><blockquote><p>https://pcisig.com/membership/member-companies?combine=&amp;order=field_vendor_id&amp;sort=asc</p></blockquote><h4 id="revision-id" tabindex="-1"><a class="header-anchor" href="#revision-id" aria-hidden="true">#</a> Revision ID</h4><p>the version number of the device</p><h4 id="status" tabindex="-1"><a class="header-anchor" href="#status" aria-hidden="true">#</a> Status</h4><p>is used to report which features are supported and whether certain kinds of errors have occurred.</p><table><thead><tr><th>Bit</th><th>Description</th></tr></thead><tbody><tr><td>Bit 15</td><td>Detected Parity Error</td></tr><tr><td>Bit 14</td><td>Signaled System Error</td></tr><tr><td>Bit 13</td><td>Received Master Abort</td></tr><tr><td>Bit 12</td><td>Received Target Abort</td></tr><tr><td>Bit 11</td><td>Signaled Target Abort</td></tr><tr><td>Bits [10:9]</td><td>DEVSEL Timing</td></tr><tr><td>Bit 8</td><td>Master Data Parity Error</td></tr><tr><td>Bit 7</td><td>Fast Back-to-Back Capable</td></tr><tr><td>Bit 6</td><td>Reserved</td></tr><tr><td>Bit 5</td><td>66 MHZ Capable</td></tr><tr><td>Bit 4</td><td>Capabilities List</td></tr><tr><td>Bit 3</td><td>Interrupt Status</td></tr><tr><td>Bits [2:0]</td><td>Reserved</td></tr></tbody></table><h4 id="command" tabindex="-1"><a class="header-anchor" href="#command" aria-hidden="true">#</a> Command</h4><h4 id="class-code" tabindex="-1"><a class="header-anchor" href="#class-code" aria-hidden="true">#</a> Class Code</h4><p>This identifies the type of device that this is. There are standard classes for every sort of device; video, scsi and so on. The class code for SCSI is 0x0100.</p><table><thead><tr><th>Class</th><th>Description</th></tr></thead><tbody><tr><td>0x00</td><td>Devices built before class codes (i.e. pre PCI 2.0)</td></tr><tr><td>0x01</td><td>Mass storage controller</td></tr><tr><td>0x02</td><td>Network controller</td></tr><tr><td>0x03</td><td>Display controller</td></tr><tr><td>0x04</td><td>Multimedia device</td></tr><tr><td>0x05</td><td>Memory Controller</td></tr><tr><td>0x06</td><td>Bridge Device</td></tr><tr><td>0x07</td><td>Simple communications controllers</td></tr><tr><td>0x08</td><td>Base system peripherals</td></tr><tr><td>0x09</td><td>Inupt devices</td></tr><tr><td>0x0A</td><td>Docking Stations</td></tr><tr><td>0x0B</td><td>Processorts</td></tr><tr><td>0x0C</td><td>Serial bus controllers</td></tr><tr><td>0x0D-0xFE</td><td>Reserved</td></tr><tr><td>0xFF</td><td>Misc</td></tr></tbody></table><h4 id="header-type" tabindex="-1"><a class="header-anchor" href="#header-type" aria-hidden="true">#</a> Header Type</h4><ul><li>bit[7]: 1 represents multi-function device; 0 represents single-function device</li><li>bits[6:0]: The Header Type register values determine the different layouts of remaining 48 bytes (64-16) of the header, depending on the function of the device. Type 0 for endpoints, Type for Root Complex, switches, and bridges.</li></ul><h4 id="cache-line-size" tabindex="-1"><a class="header-anchor" href="#cache-line-size" aria-hidden="true">#</a> Cache Line Size</h4><p>The Cache Line Size register must be programmed before the device is told it can use the memory-write-and-invalidate transaction. This should normally match the CPU&#39;s cache line size, but the correct setting is system dependent. This register does not apply to PCI Express.</p><h4 id="base-address-register-bar" tabindex="-1"><a class="header-anchor" href="#base-address-register-bar" aria-hidden="true">#</a> Base Address Register (BAR)</h4><p>It&#39;s used to</p><ul><li>specify how much memory a device wants to be mapped into main memory</li><li>after device enumeration, it holds the (base) addresses, where the mapped memory block begins</li></ul><h4 id="subsystem-id-and-subsystem-vendor-id" tabindex="-1"><a class="header-anchor" href="#subsystem-id-and-subsystem-vendor-id" aria-hidden="true">#</a> Subsystem ID and Subsystem Vendor ID</h4><p>While the Vendor ID is that of the chipset manufacturer, the Subsystem Vendor ID is that of the card manufacturer. The Subsystem ID is assigned by the subsystem vendor from the same number space as the Device ID.</p><h4 id="expansion-rom-base-address" tabindex="-1"><a class="header-anchor" href="#expansion-rom-base-address" aria-hidden="true">#</a> Expansion ROM Base Address</h4><h4 id="cap-pointer" tabindex="-1"><a class="header-anchor" href="#cap-pointer" aria-hidden="true">#</a> Cap. Pointer</h4><p>points to a linked list of new capabilities implemented by the device.</p><h4 id="interrupt-line-and-interrupt-pin" tabindex="-1"><a class="header-anchor" href="#interrupt-line-and-interrupt-pin" aria-hidden="true">#</a> Interrupt Line and Interrupt Pin</h4><ul><li>Interrupt Line: is used to pass an interrupt handle between the PCI initialisation code, the device&#39;s driver and Linux&#39;s interrupt handling subsystem. The number written there is meaningless to the the device driver but it allows the interrupt handler to correctly route an interrupt from the PCI device to the correct device driver&#39;s interrupt handling code within the Linux operating system.</li><li>Interrupt Pin: Specifies which interrupt pin the device uses. Where a value of 0x01 is INTA#, 0x02 is INTB#, 0x03 is INTC#, 0x04 is INTD#, and 0x00 means the device does not use an interrupt pin.</li></ul><h2 id="type-1-pci-configuration-space" tabindex="-1"><a class="header-anchor" href="#type-1-pci-configuration-space" aria-hidden="true">#</a> Type 1 PCI Configuration Space</h2><h2 id="msi-and-msi-x" tabindex="-1"><a class="header-anchor" href="#msi-and-msi-x" aria-hidden="true">#</a> MSI and MSI-X</h2><h3 id="msi-capability" tabindex="-1"><a class="header-anchor" href="#msi-capability" aria-hidden="true">#</a> MSI capability</h3><p>There are 4 kinds of MSI capabilities:</p><ul><li>32b Message Address</li><li>64b Message Address</li><li>32b Message Address and Per-vector Masking</li><li>64b Message Address and Per-vector Masking</li></ul><p>Registers:</p><h4 id="capability-id" tabindex="-1"><a class="header-anchor" href="#capability-id" aria-hidden="true">#</a> Capability ID</h4><p>should be <code>0x05</code></p><h4 id="next-pointer" tabindex="-1"><a class="header-anchor" href="#next-pointer" aria-hidden="true">#</a> Next Pointer</h4><p>the address of next capability</p><h4 id="message-control" tabindex="-1"><a class="header-anchor" href="#message-control" aria-hidden="true">#</a> Message Control</h4><p>Status</p><table><thead><tr><th>Bits</th><th>Definition</th><th></th></tr></thead><tbody><tr><td>15:9</td><td>Reserved</td><td></td></tr><tr><td>8</td><td>Pre-vector Masking Capable</td><td></td></tr><tr><td>7</td><td>64 bit Address Capable</td><td></td></tr><tr><td>6:4</td><td>Multiple Message Enable</td><td>interrupt count allocated by system</td></tr><tr><td>3:1</td><td>Multiple Message Capable</td><td>max irq num the device can use</td></tr><tr><td>0</td><td>MSI Enable</td><td></td></tr></tbody></table><h4 id="message-upper-address" tabindex="-1"><a class="header-anchor" href="#message-upper-address" aria-hidden="true">#</a> Message (Upper) Address</h4><p>the destination address of the MSI memory write transaction</p><h4 id="mask-bits" tabindex="-1"><a class="header-anchor" href="#mask-bits" aria-hidden="true">#</a> Mask Bits</h4><h4 id="pending-bits" tabindex="-1"><a class="header-anchor" href="#pending-bits" aria-hidden="true">#</a> Pending Bits</h4><h3 id="msi-x-table" tabindex="-1"><a class="header-anchor" href="#msi-x-table" aria-hidden="true">#</a> MSI-X Table</h3><p>MSI-X Table contains multiple entries. An entry represents a irq request.</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>+----------------+----------+----------------+----------+
| Vector Control | Msg Data | Msg Upper Addr | Msg Addr | Entry 0
| Vector Control | Msg Data | Msg Upper Addr | Msg Addr | Entry 1
| Vector Control | Msg Data | Msg Upper Addr | Msg Addr | Entry 2
| ...            | ...      | ...            | ...      | Entry 2
| Vector Control | Msg Data | Msg Upper Addr | Msg Addr | Entry n-1
+----------------+----------+----------------+----------+
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="msi-x-capability" tabindex="-1"><a class="header-anchor" href="#msi-x-capability" aria-hidden="true">#</a> MSI-X capability</h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>| 31                       | 15                        | 7     | 2 | 0 |
| ------------------------ | ------------------------- | ----- | ----- |
|       Message Control    |  Next Capability Pointer  | Capability ID |
|                                Table Offset                  |  BIR  |
|                                PBA Offset                    |  BIR  |
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="msi-x-control-register" tabindex="-1"><a class="header-anchor" href="#msi-x-control-register" aria-hidden="true">#</a> MSI-X Control Register</h4><ul><li>Bits[10:0]: MSI-X Table Size, Encoded as (Table Size - 1)</li><li>Bit[14]: Function Mask. <ul><li>1: All vectors associated with the function are masked</li><li>0: Each vector&#39;s Mask bit determines whether the vector is masked or not</li></ul></li><li>Bit[15]: MSI-X Enable</li></ul><h4 id="table-offset-and-bir" tabindex="-1"><a class="header-anchor" href="#table-offset-and-bir" aria-hidden="true">#</a> Table Offset and BIR</h4><ul><li>Bits[2:0]: Table BAR Indicator Register(BIR), indicates which BAR is used to map the MSI-X Table into memory space: <ul><li>000: BAR0</li><li>001: BAR1</li><li>010: BAR2</li><li>011: BAR3</li><li>100: BAR4</li><li>101: BAR5</li><li>110: Reserved</li><li>111: Reserved</li></ul></li><li>Bits[31:3]: Table Offset, which is the base address of the MSI-X Table, as an offset from the base address of the BAR indicated by the Table BIT bits</li></ul><p>Linux returns the physical address of <strong>MSI-X Table</strong> and maps it to virtual address via method <code>msix_map_region</code>.</p><h4 id="pba-offset-and-bir" tabindex="-1"><a class="header-anchor" href="#pba-offset-and-bir" aria-hidden="true">#</a> PBA Offset and BIR</h4><p>the address of pending table</p><h2 id="linux" tabindex="-1"><a class="header-anchor" href="#linux" aria-hidden="true">#</a> Linux</h2><h3 id="pci-bus-1" tabindex="-1"><a class="header-anchor" href="#pci-bus-1" aria-hidden="true">#</a> PCI Bus</h3><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">pci_bus</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span> node<span class="token punctuation">;</span>          <span class="token comment">/* Node in list of buses */</span>
        <span class="token keyword">struct</span> <span class="token class-name">pci_bus</span>  <span class="token operator">*</span>parent<span class="token punctuation">;</span>        <span class="token comment">/* Parent bus this bridge is on */</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span> children<span class="token punctuation">;</span>      <span class="token comment">/* List of child buses */</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span> devices<span class="token punctuation">;</span>       <span class="token comment">/* List of devices on this bus */</span>
        <span class="token keyword">struct</span> <span class="token class-name">pci_dev</span>  <span class="token operator">*</span>self<span class="token punctuation">;</span>          <span class="token comment">/* Bridge device as seen by parent */</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span> slots<span class="token punctuation">;</span>         <span class="token comment">/* List of slots on this bus;
                                           protected by pci_slot_mutex */</span>
        <span class="token keyword">struct</span> <span class="token class-name">resource</span> <span class="token operator">*</span>resource<span class="token punctuation">[</span>PCI_BRIDGE_RESOURCE_NUM<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span> resources<span class="token punctuation">;</span>     <span class="token comment">/* Address space routed to this bus */</span>
        <span class="token keyword">struct</span> <span class="token class-name">resource</span> busn_res<span class="token punctuation">;</span>       <span class="token comment">/* Bus numbers routed to this bus */</span>

        <span class="token keyword">struct</span> <span class="token class-name">pci_ops</span>  <span class="token operator">*</span>ops<span class="token punctuation">;</span>           <span class="token comment">/* Configuration access functions */</span>
        <span class="token keyword">struct</span> <span class="token class-name">msi_controller</span> <span class="token operator">*</span>msi<span class="token punctuation">;</span>     <span class="token comment">/* MSI controller */</span>
        <span class="token keyword">void</span>            <span class="token operator">*</span>sysdata<span class="token punctuation">;</span>       <span class="token comment">/* Hook for sys-specific extension */</span>
        <span class="token keyword">struct</span> <span class="token class-name">proc_dir_entry</span> <span class="token operator">*</span>procdir<span class="token punctuation">;</span> <span class="token comment">/* Directory entry in /proc/bus/pci */</span>

        <span class="token keyword">unsigned</span> <span class="token keyword">char</span>   number<span class="token punctuation">;</span>         <span class="token comment">/* Bus number */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">char</span>   primary<span class="token punctuation">;</span>        <span class="token comment">/* Number of primary bridge */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">char</span>   max_bus_speed<span class="token punctuation">;</span>  <span class="token comment">/* enum pci_bus_speed */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">char</span>   cur_bus_speed<span class="token punctuation">;</span>  <span class="token comment">/* enum pci_bus_speed */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_PCI_DOMAINS_GENERIC</span></span>
        <span class="token keyword">int</span>             domain_nr<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

        <span class="token keyword">char</span>            name<span class="token punctuation">[</span><span class="token number">48</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">unsigned</span> <span class="token keyword">short</span>  bridge_ctl<span class="token punctuation">;</span>     <span class="token comment">/* Manage NO_ISA/FBB/et al behaviors */</span>
        <span class="token class-name">pci_bus_flags_t</span> bus_flags<span class="token punctuation">;</span>      <span class="token comment">/* Inherited by child buses */</span>
        <span class="token keyword">struct</span> <span class="token class-name">device</span>           <span class="token operator">*</span>bridge<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">device</span>           dev<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">bin_attribute</span>    <span class="token operator">*</span>legacy_io<span class="token punctuation">;</span>     <span class="token comment">/* Legacy I/O for this bus */</span>
        <span class="token keyword">struct</span> <span class="token class-name">bin_attribute</span>    <span class="token operator">*</span>legacy_mem<span class="token punctuation">;</span>    <span class="token comment">/* Legacy mem */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>            is_added<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h3 id="msi-desc" tabindex="-1"><a class="header-anchor" href="#msi-desc" aria-hidden="true">#</a> msi_desc</h3><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/**
 * struct msi_desc - Descriptor structure for MSI based interrupts
 * @list:       List head for management
 * @irq:        The base interrupt number
 * @nvec_used:  The number of vectors used
 * @dev:        Pointer to the device which uses this descriptor
 * @msg:        The last set MSI message cached for reuse
 * @affinity:   Optional pointer to a cpu affinity mask for this descriptor
 *
 * @masked:     [PCI MSI/X] Mask bits
 * @is_msix:    [PCI MSI/X] True if MSI-X
 * @multiple:   [PCI MSI/X] log2 num of messages allocated
 * @multi_cap:  [PCI MSI/X] log2 num of messages supported
 * @maskbit:    [PCI MSI/X] Mask-Pending bit supported?
 * @is_64:      [PCI MSI/X] Address size: 0=32bit 1=64bit
 * @entry_nr:   [PCI MSI/X] Entry which is described by this descriptor
 * @default_irq:[PCI MSI/X] The default pre-assigned non-MSI irq
 * @mask_pos:   [PCI MSI]   Mask register position
 * @mask_base:  [PCI MSI-X] Mask register base address
 * @platform:   [platform]  Platform device specific msi descriptor data
 * @fsl_mc:     [fsl-mc]    FSL MC device specific msi descriptor data
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">msi_desc</span> <span class="token punctuation">{</span>
        <span class="token comment">/* Shared device/bus type independent data */</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span>                list<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>                    irq<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>                    nvec_used<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">device</span>                   <span class="token operator">*</span>dev<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">msi_msg</span>                  msg<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">irq_affinity_desc</span>        <span class="token operator">*</span>affinity<span class="token punctuation">;</span>

        <span class="token keyword">union</span> <span class="token punctuation">{</span>
                <span class="token comment">/* PCI MSI/X specific data */</span>
                <span class="token keyword">struct</span> <span class="token punctuation">{</span>
                        u32 masked<span class="token punctuation">;</span>
                        <span class="token keyword">struct</span> <span class="token punctuation">{</span>
                                __u8    is_msix         <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
                                __u8    multiple        <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">;</span>
                                __u8    multi_cap       <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">;</span>
                                __u8    maskbit         <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
                                __u8    is_64           <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
                                __u16   entry_nr<span class="token punctuation">;</span>
                                <span class="token keyword">unsigned</span> default_irq<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> msi_attrib<span class="token punctuation">;</span>
                        <span class="token keyword">union</span> <span class="token punctuation">{</span>
                                u8      mask_pos<span class="token punctuation">;</span>
                                <span class="token keyword">void</span> __iomem <span class="token operator">*</span>mask_base<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>

                <span class="token comment">/*
                 * Non PCI variants add their data structure here. New
                 * entries need to use a named structure. We want
                 * proper name spaces for this. The PCI part is
                 * anonymous for now as it would require an immediate
                 * tree wide cleanup.
                 */</span>
                <span class="token keyword">struct</span> <span class="token class-name">platform_msi_desc</span> platform<span class="token punctuation">;</span>
                <span class="token keyword">struct</span> <span class="token class-name">fsl_mc_msi_desc</span> fsl_mc<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><h3 id="pci-device-1" tabindex="-1"><a class="header-anchor" href="#pci-device-1" aria-hidden="true">#</a> PCI Device</h3><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* The pci_dev structure describes PCI devices */</span>
<span class="token keyword">struct</span> <span class="token class-name">pci_dev</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span> bus_list<span class="token punctuation">;</span>      <span class="token comment">/* Node in per-bus list */</span>
        <span class="token keyword">struct</span> <span class="token class-name">pci_bus</span>  <span class="token operator">*</span>bus<span class="token punctuation">;</span>           <span class="token comment">/* Bus this device is on */</span>
        <span class="token keyword">struct</span> <span class="token class-name">pci_bus</span>  <span class="token operator">*</span>subordinate<span class="token punctuation">;</span>   <span class="token comment">/* Bus this device bridges to */</span>

        <span class="token keyword">void</span>            <span class="token operator">*</span>sysdata<span class="token punctuation">;</span>       <span class="token comment">/* Hook for sys-specific extension */</span>
        <span class="token keyword">struct</span> <span class="token class-name">proc_dir_entry</span> <span class="token operator">*</span>procent<span class="token punctuation">;</span> <span class="token comment">/* Device entry in /proc/bus/pci */</span>
        <span class="token keyword">struct</span> <span class="token class-name">pci_slot</span> <span class="token operator">*</span>slot<span class="token punctuation">;</span>          <span class="token comment">/* Physical slot this device is in */</span>

        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    devfn<span class="token punctuation">;</span>          <span class="token comment">/* Encoded device &amp; function index */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">short</span>  vendor<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">short</span>  device<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">short</span>  subsystem_vendor<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">short</span>  subsystem_device<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    class<span class="token punctuation">;</span>          <span class="token comment">/* 3 bytes: (base,sub,prog-if) */</span>
        u8              revision<span class="token punctuation">;</span>       <span class="token comment">/* PCI revision, low byte of class word */</span>
        u8              hdr_type<span class="token punctuation">;</span>       <span class="token comment">/* PCI header type (`multi&#39; flag masked out) */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_PCIEAER</span></span>
        u16             aer_cap<span class="token punctuation">;</span>        <span class="token comment">/* AER capability offset */</span>
        <span class="token keyword">struct</span> <span class="token class-name">aer_stats</span> <span class="token operator">*</span>aer_stats<span class="token punctuation">;</span>    <span class="token comment">/* AER stats for this device */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        u8              pcie_cap<span class="token punctuation">;</span>       <span class="token comment">/* PCIe capability offset */</span>
        u8              msi_cap<span class="token punctuation">;</span>        <span class="token comment">/* MSI capability offset */</span>
        u8              msix_cap<span class="token punctuation">;</span>       <span class="token comment">/* MSI-X capability offset */</span>
        u8              pcie_mpss<span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">;</span>    <span class="token comment">/* PCIe Max Payload Size Supported */</span>
        u8              rom_base_reg<span class="token punctuation">;</span>   <span class="token comment">/* Config register controlling ROM */</span>
        u8              pin<span class="token punctuation">;</span>            <span class="token comment">/* Interrupt pin this device uses */</span>
        u16             pcie_flags_reg<span class="token punctuation">;</span> <span class="token comment">/* Cached PCIe Capabilities Register */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span>   <span class="token operator">*</span>dma_alias_mask<span class="token punctuation">;</span><span class="token comment">/* Mask of enabled devfn aliases */</span>

        <span class="token keyword">struct</span> <span class="token class-name">pci_driver</span> <span class="token operator">*</span>driver<span class="token punctuation">;</span>      <span class="token comment">/* Driver bound to this device */</span>
        u64             dma_mask<span class="token punctuation">;</span>       <span class="token comment">/* Mask of the bits of bus address this
                                           device implements.  Normally this is
                                           0xffffffff.  You only need to change
                                           this if your device has broken DMA
                                           or supports 64-bit transfers.  */</span>

        <span class="token keyword">struct</span> <span class="token class-name">device_dma_parameters</span> dma_parms<span class="token punctuation">;</span>

        <span class="token class-name">pci_power_t</span>     current_state<span class="token punctuation">;</span>  <span class="token comment">/* Current operating state. In ACPI,
                                           this is D0-D3, D0 being fully
                                           functional, and D3 being off. */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    imm_ready<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token comment">/* Supports Immediate Readiness */</span>
        u8              pm_cap<span class="token punctuation">;</span>         <span class="token comment">/* PM capability offset */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    pme_support<span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">;</span>  <span class="token comment">/* Bitmask of states from which PME#
                                           can be generated */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    pme_poll<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>     <span class="token comment">/* Poll device&#39;s PME status bit */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    d1_support<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>   <span class="token comment">/* Low power state D1 is supported */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    d2_support<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>   <span class="token comment">/* Low power state D2 is supported */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    no_d1d2<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>      <span class="token comment">/* D1 and D2 are forbidden */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    no_d3cold<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token comment">/* D3cold is forbidden */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    bridge_d3<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token comment">/* Allow D3 for bridge */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    d3cold_allowed<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>       <span class="token comment">/* D3cold is allowed by user */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    mmio_always_on<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>       <span class="token comment">/* Disallow turning off io/mem
                                                   decoding during BAR sizing */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    wakeup_prepared<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    runtime_d3cold<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>       <span class="token comment">/* Whether go through runtime
                                                   D3cold, not set for devices
                                                   powered on/off by the
                                                   corresponding bridge */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    ignore_hotplug<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>       <span class="token comment">/* Ignore hotplug events */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    hotplug_user_indicators<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">/* SlotCtl indicators
                                                      controlled exclusively by
                                                      user sysfs */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    d3_delay<span class="token punctuation">;</span>       <span class="token comment">/* D3-&gt;D0 transition time in ms */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    d3cold_delay<span class="token punctuation">;</span>   <span class="token comment">/* D3cold-&gt;D0 transition time in ms */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_PCIEASPM</span></span>
        <span class="token keyword">struct</span> <span class="token class-name">pcie_link_state</span>  <span class="token operator">*</span>link_state<span class="token punctuation">;</span>    <span class="token comment">/* ASPM link state */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    ltr_path<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>     <span class="token comment">/* Latency Tolerance Reporting
                                           supported from root to here */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    eetlp_prefix_path<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token comment">/* End-to-End TLP Prefix */</span>

        <span class="token class-name">pci_channel_state_t</span> error_state<span class="token punctuation">;</span>        <span class="token comment">/* Current connectivity state */</span>
        <span class="token keyword">struct</span> <span class="token class-name">device</span>   dev<span class="token punctuation">;</span>                    <span class="token comment">/* Generic device interface */</span>

        <span class="token keyword">int</span>             cfg_size<span class="token punctuation">;</span>               <span class="token comment">/* Size of config space */</span>

        <span class="token comment">/*
         * Instead of touching interrupt line and base address registers
         * directly, use the values stored here. They might be different!
         */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    irq<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">resource</span> resource<span class="token punctuation">[</span>DEVICE_COUNT_RESOURCE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/* I/O and memory regions + expansion ROMs */</span>

        bool            match_driver<span class="token punctuation">;</span>           <span class="token comment">/* Skip attaching driver */</span>

        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    transparent<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>          <span class="token comment">/* Subtractive decode bridge */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    multifunction<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token comment">/* Multi-function device */</span>

        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    is_busmaster<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>         <span class="token comment">/* Is busmaster */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    no_msi<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>               <span class="token comment">/* May not use MSI */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    no_64bit_msi<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>         <span class="token comment">/* May only use 32-bit MSIs */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    block_cfg_access<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>     <span class="token comment">/* Config space access blocked */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    broken_parity_status<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">/* Generates false positive parity */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    irq_reroute_variant<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">/* Needs IRQ rerouting variant */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    msi_enabled<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    msix_enabled<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    ari_enabled<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>          <span class="token comment">/* ARI forwarding */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    ats_enabled<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>          <span class="token comment">/* Address Translation Svc */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    pasid_enabled<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token comment">/* Process Address Space ID */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    pri_enabled<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>          <span class="token comment">/* Page Request Interface */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    is_managed<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    needs_freset<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>         <span class="token comment">/* Requires fundamental reset */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    state_saved<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    is_physfn<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    is_virtfn<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    reset_fn<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    is_hotplug_bridge<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    shpc_managed<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>         <span class="token comment">/* SHPC owned by shpchp */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    is_thunderbolt<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>       <span class="token comment">/* Thunderbolt controller */</span>
        <span class="token comment">/*
         * Devices marked being untrusted are the ones that can potentially
         * execute DMA attacks and similar. They are typically connected
         * through external ports such as Thunderbolt but not limited to
         * that. When an IOMMU is enabled they should be getting full
         * mappings to make sure they cannot access arbitrary memory.
         */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    untrusted<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    __aer_firmware_first_valid<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    __aer_firmware_first<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    broken_intx_masking<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">/* INTx masking can&#39;t be used */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    io_window_1k<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>         <span class="token comment">/* Intel bridge 1K I/O windows */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    irq_managed<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    has_secondary_link<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    non_compliant_bars<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>   <span class="token comment">/* Broken BARs; ignore them */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    is_probed<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>            <span class="token comment">/* Device probing in progress */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    link_active_reporting<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">/* Device capable of reporting link active */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    no_vf_scan<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>           <span class="token comment">/* Don&#39;t scan for VFs after IOV enablement */</span>
        <span class="token class-name">pci_dev_flags_t</span> dev_flags<span class="token punctuation">;</span>
        <span class="token class-name">atomic_t</span>        enable_cnt<span class="token punctuation">;</span>     <span class="token comment">/* pci_enable_device has been called */</span>

        u32             saved_config_space<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/* Config space saved at suspend time */</span>
        <span class="token keyword">struct</span> <span class="token class-name">hlist_head</span> saved_cap_space<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">bin_attribute</span> <span class="token operator">*</span>rom_attr<span class="token punctuation">;</span>         <span class="token comment">/* Attribute descriptor for sysfs ROM entry */</span>
        <span class="token keyword">int</span>             rom_attr_enabled<span class="token punctuation">;</span>       <span class="token comment">/* Display of ROM attribute enabled? */</span>
        <span class="token keyword">struct</span> <span class="token class-name">bin_attribute</span> <span class="token operator">*</span>res_attr<span class="token punctuation">[</span>DEVICE_COUNT_RESOURCE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/* sysfs file for resources */</span>
        <span class="token keyword">struct</span> <span class="token class-name">bin_attribute</span> <span class="token operator">*</span>res_attr_wc<span class="token punctuation">[</span>DEVICE_COUNT_RESOURCE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/* sysfs file for WC mapping of resources */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_HOTPLUG_PCI_PCIE</span></span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    broken_cmd_compl<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>     <span class="token comment">/* No compl for some cmds */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_PCIE_PTM</span></span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    ptm_root<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    ptm_enabled<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
        u8              ptm_granularity<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_PCI_MSI</span></span>
        <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">attribute_group</span> <span class="token operator">*</span><span class="token operator">*</span>msi_irq_groups<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        <span class="token keyword">struct</span> <span class="token class-name">pci_vpd</span> <span class="token operator">*</span>vpd<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_PCI_ATS</span></span>
        <span class="token keyword">union</span> <span class="token punctuation">{</span>
                <span class="token keyword">struct</span> <span class="token class-name">pci_sriov</span>        <span class="token operator">*</span>sriov<span class="token punctuation">;</span>         <span class="token comment">/* PF: SR-IOV info */</span>
                <span class="token keyword">struct</span> <span class="token class-name">pci_dev</span>          <span class="token operator">*</span>physfn<span class="token punctuation">;</span>        <span class="token comment">/* VF: related PF */</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        u16             ats_cap<span class="token punctuation">;</span>        <span class="token comment">/* ATS Capability offset */</span>
        u8              ats_stu<span class="token punctuation">;</span>        <span class="token comment">/* ATS Smallest Translation Unit */</span>
        <span class="token class-name">atomic_t</span>        ats_ref_cnt<span class="token punctuation">;</span>    <span class="token comment">/* Number of VFs with ATS enabled */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_PCI_PRI</span></span>
        u32             pri_reqs_alloc<span class="token punctuation">;</span> <span class="token comment">/* Number of PRI requests allocated */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_PCI_PASID</span></span>
        u16             pasid_features<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_PCI_P2PDMA</span></span>
        <span class="token keyword">struct</span> <span class="token class-name">pci_p2pdma</span> <span class="token operator">*</span>p2pdma<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        <span class="token class-name">phys_addr_t</span>     rom<span class="token punctuation">;</span>            <span class="token comment">/* Physical address if not from BAR */</span>
        <span class="token class-name">size_t</span>          romlen<span class="token punctuation">;</span>         <span class="token comment">/* Length if not from BAR */</span>
        <span class="token keyword">char</span>            <span class="token operator">*</span>driver_override<span class="token punctuation">;</span> <span class="token comment">/* Driver name to force a match */</span>

        <span class="token keyword">unsigned</span> <span class="token keyword">long</span>   priv_flags<span class="token punctuation">;</span>     <span class="token comment">/* Private flags for the PCI driver */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br></div></div><h2 id="pci-structure-from-qemu-view" tabindex="-1"><a class="header-anchor" href="#pci-structure-from-qemu-view" aria-hidden="true">#</a> PCI Structure from QEMU view</h2><p>Let&#39;s create a VM and see its topology.</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>qemu-system-aarch64 <span class="token punctuation">\</span>
	-machine virt-2.12,accel<span class="token operator">=</span>kvm,usb<span class="token operator">=</span>off,dump-guest-core<span class="token operator">=</span>off,gic-version<span class="token operator">=</span>host <span class="token punctuation">\</span>
	-device pcie-root-port,port<span class="token operator">=</span>0x8,chassis<span class="token operator">=</span><span class="token number">1</span>,id<span class="token operator">=</span>pci.1,bus<span class="token operator">=</span>pcie.0,multifunction<span class="token operator">=</span>on,addr<span class="token operator">=</span>0x1 <span class="token punctuation">\</span>
	-device pcie-root-port,port<span class="token operator">=</span>0x9,chassis<span class="token operator">=</span><span class="token number">2</span>,id<span class="token operator">=</span>pci.2,bus<span class="token operator">=</span>pcie.0,addr<span class="token operator">=</span>0x1.0x1 <span class="token punctuation">\</span>
	-device pcie-root-port,port<span class="token operator">=</span>0xa,chassis<span class="token operator">=</span><span class="token number">3</span>,id<span class="token operator">=</span>pci.3,bus<span class="token operator">=</span>pcie.0,addr<span class="token operator">=</span>0x1.0x2 <span class="token punctuation">\</span>
	-device pcie-root-port,port<span class="token operator">=</span>0xb,chassis<span class="token operator">=</span><span class="token number">4</span>,id<span class="token operator">=</span>pci.4,bus<span class="token operator">=</span>pcie.0,addr<span class="token operator">=</span>0x1.0x3 <span class="token punctuation">\</span>
	-device pcie-root-port,port<span class="token operator">=</span>0xc,chassis<span class="token operator">=</span><span class="token number">5</span>,id<span class="token operator">=</span>pci.5,bus<span class="token operator">=</span>pcie.0,addr<span class="token operator">=</span>0x1.0x4 <span class="token punctuation">\</span>
	-device virtio-scsi-pci,id<span class="token operator">=</span>scsi0,bus<span class="token operator">=</span>pci.3,addr<span class="token operator">=</span>0x0 <span class="token punctuation">\</span>
	-device vfio-pci,host<span class="token operator">=</span><span class="token number">82</span>:00.0,id<span class="token operator">=</span>hostdev0,bus<span class="token operator">=</span>pci.5,addr<span class="token operator">=</span>0x0
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>$ lshw

machine
    description: Computer
    width: 64 bits
    capabilities: cp15_barrier setend swp tagged_addr_disabled
  *-core
       description: Motherboard
       physical id: 0
     *-memory
          description: System memory
          physical id: 0
          size: 4GiB
     *-cpu
          physical id: 1
          bus info: cpu@0
          capabilities: fp asimd evtstrm aes pmull sha1 sha2 crc32 atomics fphp asimdhp cpuid asimdrdm jscvt fcma dcpop asimddp asimdfhm
     *-pci
          description: Host bridge
          product: QEMU PCIe Host bridge
          vendor: Red Hat, Inc.
          physical id: 100
          bus info: pci@0000:00:00.0
          version: 00
          width: 32 bits
          clock: 33MHz
        *-pci:0
             description: PCI bridge
             product: QEMU PCIe Root port
             vendor: Red Hat, Inc.
             physical id: 1
             bus info: pci@0000:00:01.0
             version: 00
             width: 32 bits
             clock: 33MHz
             capabilities: pci normal_decode bus_master cap_list
             configuration: driver=pcieport
             resources: irq:38 memory:10a00000-10a00fff ioport:1000(size=4096) memory:10000000-101fffff ioport:8000000000(size=2097152)
        *-pci:1
             description: PCI bridge
             product: QEMU PCIe Root port
             vendor: Red Hat, Inc.
             physical id: 1.1
             bus info: pci@0000:00:01.1
             version: 00
             width: 32 bits
             clock: 33MHz
             capabilities: pci normal_decode bus_master cap_list
             configuration: driver=pcieport
             resources: irq:38 memory:10a01000-10a01fff ioport:2000(size=4096) memory:10200000-103fffff ioport:8000200000(size=2097152)
        *-pci:2
             description: PCI bridge
             product: QEMU PCIe Root port
             vendor: Red Hat, Inc.
             physical id: 1.2
             bus info: pci@0000:00:01.2
             version: 00
             width: 32 bits
             clock: 33MHz
             capabilities: pci normal_decode bus_master cap_list
             configuration: driver=pcieport
             resources: irq:38 memory:10a02000-10a02fff ioport:3000(size=4096) memory:10400000-105fffff ioport:8000400000(size=2097152)
           *-scsi
                description: SCSI storage controller
                product: Virtio SCSI
                vendor: Red Hat, Inc.
                physical id: 0
                bus info: pci@0000:03:00.0
                version: 01
                width: 64 bits
                clock: 33MHz
                capabilities: scsi bus_master cap_list
                configuration: driver=virtio-pci latency=0
                resources: iomemory:800-7ff irq:38 memory:10400000-10400fff memory:8000400000-8000403fff
              *-virtio0 UNCLAIMED
                   description: Virtual I/O device
                   physical id: 0
                   bus info: virtio@0
                   configuration: driver=virtio_scsi
        *-pci:3
             description: PCI bridge
             product: QEMU PCIe Root port
             vendor: Red Hat, Inc.
             physical id: 1.3
             bus info: pci@0000:00:01.3
             version: 00
             width: 32 bits
             clock: 33MHz
             capabilities: pci normal_decode bus_master cap_list
             configuration: driver=pcieport
             resources: irq:38 memory:10a03000-10a03fff ioport:4000(size=4096) memory:10600000-107fffff ioport:8000600000(size=2097152)
        *-pci:4
             description: PCI bridge
             product: QEMU PCIe Root port
             vendor: Red Hat, Inc.
             physical id: 1.4
             bus info: pci@0000:00:01.4
             version: 00
             width: 32 bits
             clock: 33MHz
             capabilities: pci normal_decode bus_master cap_list
             configuration: driver=pcieport
             resources: irq:38 memory:10a04000-10a04fff ioport:5000(size=4096) memory:10800000-109fffff ioport:8000800000(size=2097152)
           *-storage
                description: Non-Volatile memory controller
                product: NVMe SSD Controller SM981/PM981/PM983
                vendor: Samsung Electronics Co Ltd
                physical id: 0
                bus info: pci@0000:05:00.0
                version: 00
                width: 64 bits
                clock: 33MHz
                capabilities: storage nvm_express bus_master cap_list rom
                configuration: driver=nvme latency=0
                resources: irq:38 memory:10810000-10813fff memory:10800000-1080ffff
              *-nvme0
                   description: NVMe device
                   product: SAMSUNG MZQLB1T9HAJR-00003
                   physical id: 0
                   logical name: /dev/nvme0
                   version: EDA5700Q
                   serial: S480NE0MB00360
                   configuration: nqn=nqn.2014.08.org.nvmexpress:144d144dS480NE0MB00360      SAMSUNG MZQLB1T9HAJR-00003 state=live
                 *-namespace
                      description: NVMe namespace
                      physical id: 1
                      logical name: /dev/nvme0n1
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br></div></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>        +-----------------------------------------------------------------+
        |                   PCI Host bridge                               |
        +-----------------------------------------------------------------+
            ^             ^              ^              ^             ^
            |             |              |              |             |
            V             V              V              V             V
    +---------------------------------------------------------------------------+
    |                               Bus                                         |
    +---------------------------------------------------------------------------+
            ^             ^              ^              ^             ^
            |             |              |              |             |
            V             V              V              V             V
      +-----------+ +-----------+  +-----------+  +-----------+  +-----------+
      | root port | | root port |  | root port |  | root port |  | root port |
      |   pci.0   | |   pci.1   |  |   pci.2   |  |   pci.3   |  |   pci.4   |
      +-----------+ +-----------+  +-----------+  +-----------+  +-----------+
                                                                       ^
                                                                       |
                                                                       V
                                                                 +-----------+
                                                                 |  Bus      |
                                                                 +-----------+
                                                                       ^
                                                                       |
                                                                       V
                                                                 +-----------+
                                                                 |  storage  |
                                                                 +-----------+
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h2 id="msi" tabindex="-1"><a class="header-anchor" href="#msi" aria-hidden="true">#</a> MSI</h2><h3 id="introduction" tabindex="-1"><a class="header-anchor" href="#introduction" aria-hidden="true">#</a> Introduction</h3><p>A Message Signaled Interrupt is a write from the device to a special address which causes an interrupt to be received by the CPU.</p><p>The MSI capability was first specified in PCI 2.2 and was later enhanced in PCI 3.0 to allow each interrupt to be masked individually. The MSI-X capability was also introduced with PCI 3.0. It supports more interrupts per device than MSI and allows interrupts to be independently configured.</p><p>Devices may support both MSI and MSI-X, <strong>but only one can be enabled at a time.</strong></p><h3 id="msi-and-msix" tabindex="-1"><a class="header-anchor" href="#msi-and-msix" aria-hidden="true">#</a> MSI and MSIX</h3><p>MSI and MSI-X are PCI capabilities. Both are &quot;Message Signaled Interrupts&quot; which deliver interrupts to the CPU via a DMA write to a Local APIC. The fundamental difference between MSI and MSI-X is how multiple &quot;vectors&quot; get allocated. MSI requires contiguous blocks of vectors while MSI-X can allocate several individual ones.</p><p>MSI capability can be enabled by calling <code>pci_alloc_irq_vectors()</code> with the <code>PCI_IRQ_MSI</code> and/or <code>PCI_IRQ_MSIX</code> flags before calling request_irq(). This causes the PCI support to program CPU vector data into the PCI device capability registers.</p><p>Advantages:</p><ul><li>MSI is an exclusive interrupt vector by definition. This means the interrupt handler doesn&#39;t have to verify its device caused the interrupt.</li><li>MSI avoids DMA/IRQ race conditions. DMA to host memory is guaranteed to be visible to the host CPU(s) when the MSI is delivered. This is important for both data conherency and avoiding state control data. This guarantee allows the driver to omit MMIO reads to flush the DMA stream.</li><li>PCI devices can only support a single pin-based interrupt per function. Often drivers have to query the devices to find out what event has occurred, slowing down interrupt handling for the common case.</li></ul><h3 id="how-to-use-msis" tabindex="-1"><a class="header-anchor" href="#how-to-use-msis" aria-hidden="true">#</a> How to use MSIs</h3><p>The driver simply has to request that the PCI layer set up the MSI capability for this device.</p><p>To automatically use MSI or MSI-X interrupt vectors, use the following function:</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">pci_alloc_irq_vectors</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pci_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> min_vecs<span class="token punctuation">,</span>
              <span class="token keyword">unsigned</span> <span class="token keyword">int</span> max_vecs<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>which allocates up to max_vecs interrupt vectors for a PCI device. It returns the number of vectors allocated or a negative error. If the device has a requirements for a minimum number of vectors the driver can pass a min_vecs argument set to this limit, and the PCI core will return -ENOSPC if it cant meet the minimum number of vectors.</p><p>To get the Linux IRQ number passed to <code>request_irq()</code> and <code>free_irq()</code> and the vectors, use the following function:</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">pci_irq_vector</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pci_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h3 id="implementation" tabindex="-1"><a class="header-anchor" href="#implementation" aria-hidden="true">#</a> Implementation</h3><h4 id="pci-alloc-irq-vectors" tabindex="-1"><a class="header-anchor" href="#pci-alloc-irq-vectors" aria-hidden="true">#</a> pci_alloc_irq_vectors</h4><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>pci_alloc_irq_vectors
  - pci_alloc_irq_vectors_affinity
    - __pci_enable_msix_range (for msix)
      - msix_capability_init
        - pci_msi_setup_msi_irqs -----------------------------------------+
    - __pci_enable_msi_range (for msi)                                    |
      - msi_capability_init: configure device&#39;s MSI capability structure  |
        - msi_setup_entry                                                 |
          - pci_msi_setup_msi_irqs ---------------------------------------+
    - pci_intx (for legacy)                                               |
                                                                          |
pci_msi_setup_msi_irqs &lt;--------------------------------------------------+
  - msi_domain_alloc_irqs
    - msi_domain_prepare_irqs
      - its_msi_prepare
    - __irq_domain_alloc_irqs
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">int</span>
<span class="token function">pci_alloc_irq_vectors</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pci_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> min_vecs<span class="token punctuation">,</span>
                      <span class="token keyword">unsigned</span> <span class="token keyword">int</span> max_vecs<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">pci_alloc_irq_vectors_affinity</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> min_vecs<span class="token punctuation">,</span> max_vecs<span class="token punctuation">,</span> flags<span class="token punctuation">,</span>
                                              <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><code>pci_alloc_irq_vectors_affinity</code> dispatches either of <strong>MSI</strong>, <strong>MSIX</strong> or <strong>LEGACY</strong>.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/**
 * pci_alloc_irq_vectors_affinity - allocate multiple IRQs for a device
 * @dev:                PCI device to operate on
 * @min_vecs:           minimum number of vectors required (must be &gt;= 1)
 * @max_vecs:           maximum (desired) number of vectors
 * @flags:              flags or quirks for the allocation
 * @affd:               optional description of the affinity requirements
 *
 * Allocate up to @max_vecs interrupt vectors for @dev, using MSI-X or MSI
 * vectors if available, and fall back to a single legacy vector
 * if neither is available.  Return the number of vectors allocated,
 * (which might be smaller than @max_vecs) if successful, or a negative
 * error code on error. If less than @min_vecs interrupt vectors are
 * available for @dev the function will fail with -ENOSPC.
 *
 * To get the Linux IRQ number used for a vector that can be passed to
 * request_irq() use the pci_irq_vector() helper.
 */</span>
 <span class="token keyword">int</span> <span class="token function">pci_alloc_irq_vectors_affinity</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pci_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> min_vecs<span class="token punctuation">,</span>
                                   <span class="token keyword">unsigned</span> <span class="token keyword">int</span> max_vecs<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span>
                                   <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">irq_affinity</span> <span class="token operator">*</span>affd<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">irq_affinity</span> msi_default_affd<span class="token punctuation">;</span>
        <span class="token keyword">int</span> msix_vecs <span class="token operator">=</span> <span class="token operator">-</span>ENOSPC<span class="token punctuation">;</span>
        <span class="token keyword">int</span> msi_vecs <span class="token operator">=</span> <span class="token operator">-</span>ENOSPC<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> PCI_IRQ_AFFINITY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>affd<span class="token punctuation">)</span>
                        affd <span class="token operator">=</span> <span class="token operator">&amp;</span>msi_default_affd<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WARN_ON</span><span class="token punctuation">(</span>affd<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        affd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> PCI_IRQ_MSIX<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                msix_vecs <span class="token operator">=</span> <span class="token function">__pci_enable_msix_range</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> min_vecs<span class="token punctuation">,</span>
                                                    max_vecs<span class="token punctuation">,</span> affd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>msix_vecs <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span> msix_vecs<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> PCI_IRQ_MSI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                msi_vecs <span class="token operator">=</span> <span class="token function">__pci_enable_msi_range</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> min_vecs<span class="token punctuation">,</span> max_vecs<span class="token punctuation">,</span>
                                                  affd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>msi_vecs <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span> msi_vecs<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* use legacy irq if allowed */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> PCI_IRQ_LEGACY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>min_vecs <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> dev<span class="token operator">-&gt;</span>irq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">pci_intx</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>msix_vecs <span class="token operator">==</span> <span class="token operator">-</span>ENOSPC<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>ENOSPC<span class="token punctuation">;</span>
        <span class="token keyword">return</span> msi_vecs<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><h4 id="enable-msi-x" tabindex="-1"><a class="header-anchor" href="#enable-msi-x" aria-hidden="true">#</a> Enable MSI-X</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">__pci_enable_msix_range</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pci_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
                                   <span class="token keyword">struct</span> <span class="token class-name">msix_entry</span> <span class="token operator">*</span>entries<span class="token punctuation">,</span> <span class="token keyword">int</span> minvec<span class="token punctuation">,</span>
                                   <span class="token keyword">int</span> maxvec<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">irq_affinity</span> <span class="token operator">*</span>affd<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">int</span> rc<span class="token punctuation">,</span> nvec <span class="token operator">=</span> maxvec<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>maxvec <span class="token operator">&lt;</span> minvec<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>ERANGE<span class="token punctuation">;</span>

        <span class="token comment">/*
         * If the caller is passing in sets, we can&#39;t support a range of
         * supported vectors. The caller needs to handle that.
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>affd <span class="token operator">&amp;&amp;</span> affd<span class="token operator">-&gt;</span>nr_sets <span class="token operator">&amp;&amp;</span> minvec <span class="token operator">!=</span> maxvec<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WARN_ON_ONCE</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>msix_enabled<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>affd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        nvec <span class="token operator">=</span> <span class="token function">irq_calc_affinity_vectors</span><span class="token punctuation">(</span>minvec<span class="token punctuation">,</span> nvec<span class="token punctuation">,</span> affd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>nvec <span class="token operator">&lt;</span> minvec<span class="token punctuation">)</span>
                                <span class="token keyword">return</span> <span class="token operator">-</span>ENOSPC<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                rc <span class="token operator">=</span> <span class="token function">__pci_enable_msix</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> entries<span class="token punctuation">,</span> nvec<span class="token punctuation">,</span> affd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span> nvec<span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span> rc<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">&lt;</span> minvec<span class="token punctuation">)</span>
                        <span class="token keyword">return</span> <span class="token operator">-</span>ENOSPC<span class="token punctuation">;</span>

                nvec <span class="token operator">=</span> rc<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>Let&#39;s skip irq affinity here.</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>__pci_enable_msix
  - pci_msi_supported
  - pci_msix_vec_count
  - msix_capability_init
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">__pci_enable_msix</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pci_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">msix_entry</span> <span class="token operator">*</span>entries<span class="token punctuation">,</span>
                             <span class="token keyword">int</span> nvec<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">irq_affinity</span> <span class="token operator">*</span>affd<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">int</span> nr_entries<span class="token punctuation">;</span>
        <span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">pci_msi_supported</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> nvec<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>

        nr_entries <span class="token operator">=</span> <span class="token function">pci_msix_vec_count</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nr_entries <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> nr_entries<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nvec <span class="token operator">&gt;</span> nr_entries<span class="token punctuation">)</span>
                <span class="token keyword">return</span> nr_entries<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>entries<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">/* Check for any invalid entries */</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nvec<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>entries<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>entry <span class="token operator">&gt;=</span> nr_entries<span class="token punctuation">)</span>
                                <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>         <span class="token comment">/* invalid entry */</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> nvec<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>entries<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>entry <span class="token operator">==</span> entries<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>entry<span class="token punctuation">)</span>
                                        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span> <span class="token comment">/* duplicate entry */</span>
                        <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* Check whether driver already requested for MSI irq */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>msi_enabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">pci_info</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">&quot;can&#39;t enable MSI-X (MSI IRQ already assigned)\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">msix_capability_init</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> entries<span class="token punctuation">,</span> nvec<span class="token punctuation">,</span> affd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/**
 * pci_msi_supported - check whether MSI may be enabled on a device
 * @dev: pointer to the pci_dev data structure of MSI device function
 * @nvec: how many MSIs have been requested ?
 *
 * Look at global flags, the device itself, and its parent buses
 * to determine if MSI/-X are supported for the device. If MSI/-X is
 * supported return 1, else return 0.
 **/</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">pci_msi_supported</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pci_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">int</span> nvec<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">pci_bus</span> <span class="token operator">*</span>bus<span class="token punctuation">;</span>

        <span class="token comment">/* MSI must be globally enabled and supported by the device */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pci_msi_enable<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev <span class="token operator">||</span> dev<span class="token operator">-&gt;</span>no_msi <span class="token operator">||</span> dev<span class="token operator">-&gt;</span>current_state <span class="token operator">!=</span> PCI_D0<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">/*
         * You can&#39;t ask to have 0 or less MSIs configured.
         *  a) it&#39;s stupid ..
         *  b) the list manipulation code assumes nvec &gt;= 1.
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nvec <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">/*
         * Any bridge which does NOT route MSI transactions from its
         * secondary bus to its primary bus must set NO_MSI flag on
         * the secondary pci_bus.
         * We expect only arch-specific PCI host bus controller driver
         * or quirks for specific PCI bridges to be setting NO_MSI.
         */</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>bus <span class="token operator">=</span> dev<span class="token operator">-&gt;</span>bus<span class="token punctuation">;</span> bus<span class="token punctuation">;</span> bus <span class="token operator">=</span> bus<span class="token operator">-&gt;</span>parent<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>bus<span class="token operator">-&gt;</span>bus_flags <span class="token operator">&amp;</span> PCI_BUS_FLAGS_NO_MSI<span class="token punctuation">)</span>
                        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/**
 * pci_msix_vec_count - return the number of device&#39;s MSI-X table entries
 * @dev: pointer to the pci_dev data structure of MSI-X device function
 * This function returns the number of device&#39;s MSI-X table entries and
 * therefore the number of MSI-X vectors device is capable of sending.
 * It returns a negative errno if the device is not capable of sending MSI-X
 * interrupts.
 **/</span>
<span class="token keyword">int</span> <span class="token function">pci_msix_vec_count</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pci_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        u16 control<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev<span class="token operator">-&gt;</span>msix_cap<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>

        <span class="token function">pci_read_config_word</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> dev<span class="token operator">-&gt;</span>msix_cap <span class="token operator">+</span> PCI_MSIX_FLAGS<span class="token punctuation">,</span> <span class="token operator">&amp;</span>control<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">msix_table_size</span><span class="token punctuation">(</span>control<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">EXPORT_SYMBOL</span><span class="token punctuation">(</span>pci_msix_vec_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>msix_capability_init
  - pci_msix_clear_and_set_ctrl: disable msi-x enable bit
  - msix_map_region: compute the physical addres of msi-x table and map it
                     to virtual address
  - msix_setup_entries: allocate and initialize msi_desc for each vector
  - pci_msi_setup_msi_irqs
  - msi_verify_entries
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/**
 * msix_capability_init - configure device&#39;s MSI-X capability
 * @dev: pointer to the pci_dev data structure of MSI-X device function
 * @entries: pointer to an array of struct msix_entry entries
 * @nvec: number of @entries
 * @affd: Optional pointer to enable automatic affinity assignement
 *
 * Setup the MSI-X capability structure of device function with a
 * single MSI-X irq. A return of zero indicates the successful setup of
 * requested MSI-X entries with allocated irqs or non-zero for otherwise.
 **/</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">msix_capability_init</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pci_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">msix_entry</span> <span class="token operator">*</span>entries<span class="token punctuation">,</span>
                                <span class="token keyword">int</span> nvec<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">irq_affinity</span> <span class="token operator">*</span>affd<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
        u16 control<span class="token punctuation">;</span>
        <span class="token keyword">void</span> __iomem <span class="token operator">*</span>base<span class="token punctuation">;</span>

        <span class="token comment">/* Ensure MSI-X is disabled while it is set up */</span>
        <span class="token function">pci_msix_clear_and_set_ctrl</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> PCI_MSIX_FLAGS_ENABLE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">pci_read_config_word</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> dev<span class="token operator">-&gt;</span>msix_cap <span class="token operator">+</span> PCI_MSIX_FLAGS<span class="token punctuation">,</span> <span class="token operator">&amp;</span>control<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* Request &amp; Map MSI-X table region */</span>
	<span class="token comment">/* base is the virtual address of msi-x table */</span>
        base <span class="token operator">=</span> <span class="token function">msix_map_region</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token function">msix_table_size</span><span class="token punctuation">(</span>control<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>base<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>

        ret <span class="token operator">=</span> <span class="token function">msix_setup_entries</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> base<span class="token punctuation">,</span> entries<span class="token punctuation">,</span> nvec<span class="token punctuation">,</span> affd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
                <span class="token keyword">return</span> ret<span class="token punctuation">;</span>

        ret <span class="token operator">=</span> <span class="token function">pci_msi_setup_msi_irqs</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> nvec<span class="token punctuation">,</span> PCI_CAP_ID_MSIX<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
                <span class="token keyword">goto</span> out_avail<span class="token punctuation">;</span>

        <span class="token comment">/* Check if all MSI entries honor device restrictions */</span>
        ret <span class="token operator">=</span> <span class="token function">msi_verify_entries</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
                <span class="token keyword">goto</span> out_free<span class="token punctuation">;</span>

        <span class="token comment">/*
         * Some devices require MSI-X to be enabled before we can touch the
         * MSI-X registers.  We need to mask all the vectors to prevent
         * interrupts coming in before they&#39;re fully set up.
         */</span>
        <span class="token function">pci_msix_clear_and_set_ctrl</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                                PCI_MSIX_FLAGS_MASKALL <span class="token operator">|</span> PCI_MSIX_FLAGS_ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">msix_program_entries</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> entries<span class="token punctuation">)</span><span class="token punctuation">;</span>

        ret <span class="token operator">=</span> <span class="token function">populate_msi_sysfs</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
                <span class="token keyword">goto</span> out_free<span class="token punctuation">;</span>

        <span class="token comment">/* Set MSI-X enabled bits and unmask the function */</span>
        <span class="token function">pci_intx_for_msi</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dev<span class="token operator">-&gt;</span>msix_enabled <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token function">pci_msix_clear_and_set_ctrl</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> PCI_MSIX_FLAGS_MASKALL<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">pcibios_free_irq</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

out_avail<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">/*
                 * If we had some success, report the number of irqs
                 * we succeeded in setting up.
                 */</span>
                <span class="token keyword">struct</span> <span class="token class-name">msi_desc</span> <span class="token operator">*</span>entry<span class="token punctuation">;</span>
                <span class="token keyword">int</span> avail <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

                <span class="token function">for_each_pci_msi_entry</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> dev<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token operator">-&gt;</span>irq <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                                avail<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>avail <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                        ret <span class="token operator">=</span> avail<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

out_free<span class="token operator">:</span>
        <span class="token function">free_msi_irqs</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">msix_setup_entries</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pci_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">void</span> __iomem <span class="token operator">*</span>base<span class="token punctuation">,</span>
                              <span class="token keyword">struct</span> <span class="token class-name">msix_entry</span> <span class="token operator">*</span>entries<span class="token punctuation">,</span> <span class="token keyword">int</span> nvec<span class="token punctuation">,</span>
                              <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">irq_affinity</span> <span class="token operator">*</span>affd<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">irq_affinity_desc</span> <span class="token operator">*</span>curmsk<span class="token punctuation">,</span> <span class="token operator">*</span>masks <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">msi_desc</span> <span class="token operator">*</span>entry<span class="token punctuation">;</span>
        <span class="token keyword">int</span> ret<span class="token punctuation">,</span> i<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>affd<span class="token punctuation">)</span>
                masks <span class="token operator">=</span> <span class="token function">irq_create_affinity_masks</span><span class="token punctuation">(</span>nvec<span class="token punctuation">,</span> affd<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> curmsk <span class="token operator">=</span> masks<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nvec<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                entry <span class="token operator">=</span> <span class="token function">alloc_msi_entry</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> curmsk<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>i<span class="token punctuation">)</span>
                                <span class="token function">iounmap</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">else</span>
                                <span class="token function">free_msi_irqs</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">/* No enough memory. Don&#39;t try again */</span>
                        ret <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
                        <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                entry<span class="token operator">-&gt;</span>msi_attrib<span class="token punctuation">.</span>is_msix       <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                entry<span class="token operator">-&gt;</span>msi_attrib<span class="token punctuation">.</span>is_64         <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>entries<span class="token punctuation">)</span>
                        entry<span class="token operator">-&gt;</span>msi_attrib<span class="token punctuation">.</span>entry_nr <span class="token operator">=</span> entries<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>entry<span class="token punctuation">;</span>
                <span class="token keyword">else</span>
                        entry<span class="token operator">-&gt;</span>msi_attrib<span class="token punctuation">.</span>entry_nr <span class="token operator">=</span> i<span class="token punctuation">;</span>
                entry<span class="token operator">-&gt;</span>msi_attrib<span class="token punctuation">.</span>default_irq   <span class="token operator">=</span> dev<span class="token operator">-&gt;</span>irq<span class="token punctuation">;</span>
                entry<span class="token operator">-&gt;</span>mask_base                <span class="token operator">=</span> base<span class="token punctuation">;</span>

                <span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>entry<span class="token operator">-&gt;</span>list<span class="token punctuation">,</span> <span class="token function">dev_to_msi_list</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>masks<span class="token punctuation">)</span>
                        curmsk<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
out<span class="token operator">:</span>
        <span class="token function">kfree</span><span class="token punctuation">(</span>masks<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">pci_msi_setup_msi_irqs</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pci_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">int</span> nvec<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">irq_domain</span> <span class="token operator">*</span>domain<span class="token punctuation">;</span>

        domain <span class="token operator">=</span> <span class="token function">dev_get_msi_domain</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>domain <span class="token operator">&amp;&amp;</span> <span class="token function">irq_domain_is_hierarchy</span><span class="token punctuation">(</span>domain<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token function">msi_domain_alloc_irqs</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> nvec<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">arch_setup_msi_irqs</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> nvec<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>the function invokes <code>msi_domain_alloc_irqs</code> which allocates Linux irqs from a MSI interrupt domain.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">msi_domain_alloc_irqs</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">irq_domain</span> <span class="token operator">*</span>domain<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
                          <span class="token keyword">int</span> nvec<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">msi_domain_info</span> <span class="token operator">*</span>info <span class="token operator">=</span> domain<span class="token operator">-&gt;</span>host_data<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">msi_domain_ops</span> <span class="token operator">*</span>ops <span class="token operator">=</span> info<span class="token operator">-&gt;</span>ops<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">irq_data</span> <span class="token operator">*</span>irq_data<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">msi_desc</span> <span class="token operator">*</span>desc<span class="token punctuation">;</span>
        <span class="token class-name">msi_alloc_info_t</span> arg<span class="token punctuation">;</span>
        <span class="token keyword">int</span> i<span class="token punctuation">,</span> ret<span class="token punctuation">,</span> virq<span class="token punctuation">;</span>
        bool can_reserve<span class="token punctuation">;</span>

        <span class="token comment">// creates device and inserts into ITS device list</span>
        ret <span class="token operator">=</span> <span class="token function">msi_domain_prepare_irqs</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> dev<span class="token punctuation">,</span> nvec<span class="token punctuation">,</span> <span class="token operator">&amp;</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
                <span class="token keyword">return</span> ret<span class="token punctuation">;</span>

        <span class="token function">for_each_msi_entry</span><span class="token punctuation">(</span>desc<span class="token punctuation">,</span> dev<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ops<span class="token operator">-&gt;</span><span class="token function">set_desc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>arg<span class="token punctuation">,</span> desc<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// allocates linux irq</span>
                virq <span class="token operator">=</span> <span class="token function">__irq_domain_alloc_irqs</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> desc<span class="token operator">-&gt;</span>nvec_used<span class="token punctuation">,</span>
                                               <span class="token function">dev_to_node</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>arg<span class="token punctuation">,</span> false<span class="token punctuation">,</span>
                                               desc<span class="token operator">-&gt;</span>affinity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>virq <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        ret <span class="token operator">=</span> <span class="token operator">-</span>ENOSPC<span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>ops<span class="token operator">-&gt;</span>handle_error<span class="token punctuation">)</span>
                                ret <span class="token operator">=</span> ops<span class="token operator">-&gt;</span><span class="token function">handle_error</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> desc<span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>ops<span class="token operator">-&gt;</span>msi_finish<span class="token punctuation">)</span>
                                ops<span class="token operator">-&gt;</span><span class="token function">msi_finish</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>arg<span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> desc<span class="token operator">-&gt;</span>nvec_used<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// set MSI descriptor data for an irq offset</span>
                        <span class="token function">irq_set_msi_desc_off</span><span class="token punctuation">(</span>virq<span class="token punctuation">,</span> i<span class="token punctuation">,</span> desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">irq_debugfs_copy_devname</span><span class="token punctuation">(</span>virq <span class="token operator">+</span> i<span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>ops<span class="token operator">-&gt;</span>msi_finish<span class="token punctuation">)</span>
                ops<span class="token operator">-&gt;</span><span class="token function">msi_finish</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>arg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        can_reserve <span class="token operator">=</span> <span class="token function">msi_check_reservation_mode</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> info<span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">for_each_msi_entry</span><span class="token punctuation">(</span>desc<span class="token punctuation">,</span> dev<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                virq <span class="token operator">=</span> desc<span class="token operator">-&gt;</span>irq<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>desc<span class="token operator">-&gt;</span>nvec_used <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
                        <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">&quot;irq %d for MSI\n&quot;</span><span class="token punctuation">,</span> virq<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span>
                        <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token string">&quot;irq [%d-%d] for MSI\n&quot;</span><span class="token punctuation">,</span>
                                virq<span class="token punctuation">,</span> virq <span class="token operator">+</span> desc<span class="token operator">-&gt;</span>nvec_used <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">/*
                 * This flag is set by the PCI layer as we need to activate
                 * the MSI entries before the PCI layer enables MSI in the
                 * card. Otherwise the card latches a random msi message.
                 */</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> MSI_FLAG_ACTIVATE_EARLY<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>

                irq_data <span class="token operator">=</span> <span class="token function">irq_domain_get_irq_data</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> desc<span class="token operator">-&gt;</span>irq<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>can_reserve<span class="token punctuation">)</span>
                        <span class="token function">irqd_clr_can_reserve</span><span class="token punctuation">(</span>irq_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                ret <span class="token operator">=</span> <span class="token function">irq_domain_activate_irq</span><span class="token punctuation">(</span>irq_data<span class="token punctuation">,</span> can_reserve<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
                        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/*
         * If these interrupts use reservation mode, clear the activated bit
         * so request_irq() will assign the final vector.
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>can_reserve<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">for_each_msi_entry</span><span class="token punctuation">(</span>desc<span class="token punctuation">,</span> dev<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        irq_data <span class="token operator">=</span> <span class="token function">irq_domain_get_irq_data</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> desc<span class="token operator">-&gt;</span>irq<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">irqd_clr_activated</span><span class="token punctuation">(</span>irq_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

cleanup<span class="token operator">:</span>
        <span class="token function">for_each_msi_entry</span><span class="token punctuation">(</span>desc<span class="token punctuation">,</span> dev<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">struct</span> <span class="token class-name">irq_data</span> <span class="token operator">*</span>irqd<span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>desc<span class="token operator">-&gt;</span>irq <span class="token operator">==</span> virq<span class="token punctuation">)</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>

                irqd <span class="token operator">=</span> <span class="token function">irq_domain_get_irq_data</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> desc<span class="token operator">-&gt;</span>irq<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">irqd_is_activated</span><span class="token punctuation">(</span>irqd<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token function">irq_domain_deactivate_irq</span><span class="token punctuation">(</span>irqd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">msi_domain_free_irqs</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br></div></div><h4 id="pci-irq-vector" tabindex="-1"><a class="header-anchor" href="#pci-irq-vector" aria-hidden="true">#</a> pci_irq_vector</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/**
 * pci_irq_vector - return Linux IRQ number of a device vector
 * @dev: PCI device to operate on
 * @nr: device-relative interrupt vector index (0-based).
 */</span>
<span class="token keyword">int</span> <span class="token function">pci_irq_vector</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pci_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>msix_enabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">struct</span> <span class="token class-name">msi_desc</span> <span class="token operator">*</span>entry<span class="token punctuation">;</span>
                <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

                <span class="token function">for_each_pci_msi_entry</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> dev<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> nr<span class="token punctuation">)</span>
                                <span class="token keyword">return</span> entry<span class="token operator">-&gt;</span>irq<span class="token punctuation">;</span>
                        i<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">WARN_ON_ONCE</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>msi_enabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">struct</span> <span class="token class-name">msi_desc</span> <span class="token operator">*</span>entry <span class="token operator">=</span> <span class="token function">first_pci_msi_entry</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WARN_ON_ONCE</span><span class="token punctuation">(</span>nr <span class="token operator">&gt;=</span> entry<span class="token operator">-&gt;</span>nvec_used<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WARN_ON_ONCE</span><span class="token punctuation">(</span>nr <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> dev<span class="token operator">-&gt;</span>irq <span class="token operator">+</span> nr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">EXPORT_SYMBOL</span><span class="token punctuation">(</span>pci_irq_vector<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h2 id="reference" tabindex="-1"><a class="header-anchor" href="#reference" aria-hidden="true">#</a> Reference</h2><blockquote><p>Documentation/PCI/pci.txt Documentation/PCI/MSI-HOWTO.txt https://docs.oracle.com/cd/E19683-01/806-5222/6je8fjvhe/index.html#hwovr-fig-23 https://en.wikipedia.org/wiki/PCI_configuration_space https://wiki.osdev.org/PCI</p></blockquote><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">6/27/2021, 3:40:08 PM</span></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: zhangjunyu.92@bytedance.com">Zhang Junyu</span><!--[-->, <!--]--><!--]--><!--[--><span class="contributor" title="email: junyu92@163.com">Zhang Junyu</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script src="/vue_notebook/assets/js/runtime~app.47f1fcf0.js" defer></script><script src="/vue_notebook/assets/js/1812.154fe714.js" defer></script><script src="/vue_notebook/assets/js/app.1f287e75.js" defer></script>
  </body>
</html>
