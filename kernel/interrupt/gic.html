<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.26">
    <title>GIC | Notebook</title><meta name="description" content="">
    <link rel="preload" href="/vue_notebook/assets/js/runtime~app.47f1fcf0.js" as="script"><link rel="preload" href="/vue_notebook/assets/css/styles.799329ce.css" as="style"><link rel="preload" href="/vue_notebook/assets/js/1812.154fe714.js" as="script"><link rel="preload" href="/vue_notebook/assets/js/app.1f287e75.js" as="script">
    <link rel="stylesheet" href="/vue_notebook/assets/css/styles.799329ce.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/vue_notebook/" class=""><!----><span class="site-name">Notebook</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><!----><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><!----><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item active">Kernel</p><ul class=""><li><!--[--><p class="sidebar-item">Booting and Initialization</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/boot/entry.html" class="nav-link sidebar-item" aria-label="Kernel entry point"><!--[--><!--]--> Kernel entry point <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/boot/kaslr.html" class="nav-link sidebar-item" aria-label="Kernel Address Space Layout Randomization"><!--[--><!--]--> Kernel Address Space Layout Randomization <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Memory Management</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/memory/memory_order.html" class="nav-link sidebar-item" aria-label="Memory Ordering"><!--[--><!--]--> Memory Ordering <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/memory/cache.html" class="nav-link sidebar-item" aria-label="Cache"><!--[--><!--]--> Cache <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/memory/memory_tagging_extension.html" class="nav-link sidebar-item" aria-label="Memory Tagging Extension"><!--[--><!--]--> Memory Tagging Extension <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/memory/arm64_fault.html" class="nav-link sidebar-item" aria-label="ARM64 Fault"><!--[--><!--]--> ARM64 Fault <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/memory/virtualization.html" class="nav-link sidebar-item" aria-label="Memory Virtualization"><!--[--><!--]--> Memory Virtualization <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Task</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/task/idle.md" class="nav-link sidebar-item" aria-label="/kernel/task/idle.md"><!--[--><!--]--> /kernel/task/idle.md <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/task/thread_info.html" class="nav-link sidebar-item" aria-label="Thread Info"><!--[--><!--]--> Thread Info <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Scheduler</p><!----><!--]--></li><li><!--[--><p class="sidebar-item">Syscall</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/syscall/vdso.md" class="nav-link sidebar-item" aria-label="/kernel/syscall/vdso.md"><!--[--><!--]--> /kernel/syscall/vdso.md <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item active">Interrupt Management</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/interrupt/interrupt_in_linux.html" class="nav-link sidebar-item" aria-label="Interrupt in Linux"><!--[--><!--]--> Interrupt in Linux <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/vue_notebook/kernel/interrupt/gic.html" class="router-link-active router-link-exact-active nav-link router-link-active sidebar-item active" aria-label="GIC"><!--[--><!--]--> GIC <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/interrupt/its.html" class="nav-link sidebar-item" aria-label="Interrupt Translation Service"><!--[--><!--]--> Interrupt Translation Service <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Time Management</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/time/time_in_linux.html" class="nav-link sidebar-item" aria-label="Time Framework in Linux"><!--[--><!--]--> Time Framework in Linux <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/time/clocksource_and_timekeeping.html" class="nav-link sidebar-item" aria-label="Clocksource and Timerkeeping"><!--[--><!--]--> Clocksource and Timerkeeping <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/time/jiffies.html" class="nav-link sidebar-item" aria-label="Jiffies"><!--[--><!--]--> Jiffies <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/time/clockevents.html" class="nav-link sidebar-item" aria-label="Clockevents"><!--[--><!--]--> Clockevents <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/time/timer.html" class="nav-link sidebar-item" aria-label="(Hardware) Timer"><!--[--><!--]--> (Hardware) Timer <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/time/hrtimer.html" class="nav-link sidebar-item" aria-label="High resolution timers"><!--[--><!--]--> High resolution timers <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/time/dynamic_timer.html" class="nav-link sidebar-item" aria-label="Dynamic Timer"><!--[--><!--]--> Dynamic Timer <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/time/tick_broadcast.html" class="nav-link sidebar-item" aria-label="Tick Broadcast"><!--[--><!--]--> Tick Broadcast <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">IPC</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/ipc/signal.md" class="nav-link sidebar-item" aria-label="/kernel/ipc/signal.md"><!--[--><!--]--> /kernel/ipc/signal.md <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/ipc/wait.html" class="nav-link sidebar-item" aria-label="Wait"><!--[--><!--]--> Wait <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/ipc/eventfd.html" class="nav-link sidebar-item" aria-label="eventfd"><!--[--><!--]--> eventfd <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Synchronization</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/sync/spinlock.md" class="nav-link sidebar-item" aria-label="/kernel/sync/spinlock.md"><!--[--><!--]--> /kernel/sync/spinlock.md <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/sync/mutex.md" class="nav-link sidebar-item" aria-label="/kernel/sync/mutex.md"><!--[--><!--]--> /kernel/sync/mutex.md <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/sync/semaphore.md" class="nav-link sidebar-item" aria-label="/kernel/sync/semaphore.md"><!--[--><!--]--> /kernel/sync/semaphore.md <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/sync/rcu.md" class="nav-link sidebar-item" aria-label="/kernel/sync/rcu.md"><!--[--><!--]--> /kernel/sync/rcu.md <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Device Driver</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/driver/pci.html" class="nav-link sidebar-item" aria-label="PCI"><!--[--><!--]--> PCI <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Power Management</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/power/psci.html" class="nav-link sidebar-item" aria-label="PSCI"><!--[--><!--]--> PSCI <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Trace</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/trace/lockup.html" class="nav-link sidebar-item" aria-label="lockup detection"><!--[--><!--]--> lockup detection <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/trace/walk_stack_on_arm.html" class="nav-link sidebar-item" aria-label="Walk stack on ARM"><!--[--><!--]--> Walk stack on ARM <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/trace/aarch64_debug.html" class="nav-link sidebar-item" aria-label="AArch64 Debug"><!--[--><!--]--> AArch64 Debug <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/trace/pmu.html" class="nav-link sidebar-item" aria-label="Performance Monitor Unit"><!--[--><!--]--> Performance Monitor Unit <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/trace/spe.html" class="nav-link sidebar-item" aria-label="Statistical Profiling Extension"><!--[--><!--]--> Statistical Profiling Extension <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/trace/kprobes.html" class="nav-link sidebar-item" aria-label="kprobes"><!--[--><!--]--> kprobes <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/trace/ftrace.html" class="nav-link sidebar-item" aria-label="ftrace"><!--[--><!--]--> ftrace <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Misc</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/misc/rseq.html" class="nav-link sidebar-item" aria-label="Restartable Sequences"><!--[--><!--]--> Restartable Sequences <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/misc/export_symbol.html" class="nav-link sidebar-item" aria-label="Export Kernel Symbol"><!--[--><!--]--> Export Kernel Symbol <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/misc/uefi.html" class="nav-link sidebar-item" aria-label="UEFI"><!--[--><!--]--> UEFI <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/misc/dtb.html" class="nav-link sidebar-item" aria-label="Device Tree"><!--[--><!--]--> Device Tree <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Virtualization</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/virtualization/vfio.html" class="nav-link sidebar-item" aria-label="VFIO"><!--[--><!--]--> VFIO <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/virtualization/secure_virt.html" class="nav-link sidebar-item" aria-label="Secure Virtualization"><!--[--><!--]--> Secure Virtualization <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">Rust</p><ul class=""><li><!--[--><a href="/vue_notebook/rust/" class="nav-link sidebar-item" aria-label="Rust"><!--[--><!--]--> Rust <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/rust/trait.html" class="nav-link sidebar-item" aria-label="Trait"><!--[--><!--]--> Trait <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/rust/pin.html" class="nav-link sidebar-item" aria-label="Pin"><!--[--><!--]--> Pin <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/rust/kernel_module_in_rust.html" class="nav-link sidebar-item" aria-label="Kernel Module in Rust"><!--[--><!--]--> Kernel Module in Rust <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">Debug</p><ul class=""><li><!--[--><a href="/vue_notebook/debug/gdb_python.html" class="nav-link sidebar-item" aria-label="GDB Python"><!--[--><!--]--> GDB Python <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">Qemu</p><ul class=""><li><!--[--><a href="/vue_notebook/qemu/pci.html" class="nav-link sidebar-item" aria-label="PCI"><!--[--><!--]--> PCI <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">trusted computing</p><ul class=""><li><!--[--><a href="/vue_notebook/trusted_computing/sgx.html" class="nav-link sidebar-item" aria-label="Intel SGX"><!--[--><!--]--> Intel SGX <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="gic" tabindex="-1"><a class="header-anchor" href="#gic" aria-hidden="true">#</a> GIC</h1><nav class="table-of-contents"><ul><li><a aria-current="page" href="/vue_notebook/kernel/interrupt/gic.html#registers" class="router-link-active router-link-exact-active">Registers</a><ul><li><a aria-current="page" href="/vue_notebook/kernel/interrupt/gic.html#distributor-gicd" class="router-link-active router-link-exact-active">Distributor (GICD_*)</a></li><li><a aria-current="page" href="/vue_notebook/kernel/interrupt/gic.html#redistributors-gicr" class="router-link-active router-link-exact-active">Redistributors (GICR_*)</a></li><li><a aria-current="page" href="/vue_notebook/kernel/interrupt/gic.html#cpu-interfaces-icc-eln" class="router-link-active router-link-exact-active">CPU interfaces (ICC_*_ELn)</a></li></ul></li><li><a aria-current="page" href="/vue_notebook/kernel/interrupt/gic.html#lift-cycle-of-an-interrupt" class="router-link-active router-link-exact-active">Lift cycle of an interrupt</a><ul><li><a aria-current="page" href="/vue_notebook/kernel/interrupt/gic.html#level-sensitive-interrupts" class="router-link-active router-link-exact-active">Level-sensitive interrupts</a></li><li><a aria-current="page" href="/vue_notebook/kernel/interrupt/gic.html#edge-sensitive-interrupts" class="router-link-active router-link-exact-active">Edge-sensitive interrupts</a></li><li><a aria-current="page" href="/vue_notebook/kernel/interrupt/gic.html#end-of-interrupt" class="router-link-active router-link-exact-active">End of interrupt</a></li></ul></li><li><a aria-current="page" href="/vue_notebook/kernel/interrupt/gic.html#affinity" class="router-link-active router-link-exact-active">Affinity</a></li><li><a aria-current="page" href="/vue_notebook/kernel/interrupt/gic.html#interrupt-prioritization" class="router-link-active router-link-exact-active">Interrupt prioritization</a><ul><li><a aria-current="page" href="/vue_notebook/kernel/interrupt/gic.html#preemption" class="router-link-active router-link-exact-active">Preemption</a></li></ul></li><li><a aria-current="page" href="/vue_notebook/kernel/interrupt/gic.html#virtualization-gic-part" class="router-link-active router-link-exact-active">Virtualization (GIC part)</a><ul><li><a aria-current="page" href="/vue_notebook/kernel/interrupt/gic.html#gicv4-1" class="router-link-active router-link-exact-active">GICv4(.1)</a></li><li><a aria-current="page" href="/vue_notebook/kernel/interrupt/gic.html#direct-injection-of-virtual-interrupts-gicv4" class="router-link-active router-link-exact-active">Direct injection of virtual interrupts (GICv4)</a></li><li><a aria-current="page" href="/vue_notebook/kernel/interrupt/gic.html#direct-injection-of-virtual-software-generated-interrupts-sgis" class="router-link-active router-link-exact-active">Direct injection of virtual Software Generated Interrupts (SGIs)</a></li></ul></li><li><a aria-current="page" href="/vue_notebook/kernel/interrupt/gic.html#virtualization-kvm-part" class="router-link-active router-link-exact-active">Virtualization (KVM part)</a><ul><li><a aria-current="page" href="/vue_notebook/kernel/interrupt/gic.html#forward-an-interrupt-direct-injection" class="router-link-active router-link-exact-active">Forward an interrupt (Direct Injection)</a></li></ul></li></ul></nav><h2 id="registers" tabindex="-1"><a class="header-anchor" href="#registers" aria-hidden="true">#</a> Registers</h2><h3 id="distributor-gicd" tabindex="-1"><a class="header-anchor" href="#distributor-gicd" aria-hidden="true">#</a> Distributor (GICD_*)</h3><h3 id="redistributors-gicr" tabindex="-1"><a class="header-anchor" href="#redistributors-gicr" aria-hidden="true">#</a> Redistributors (GICR_*)</h3><h3 id="cpu-interfaces-icc-eln" tabindex="-1"><a class="header-anchor" href="#cpu-interfaces-icc-eln" aria-hidden="true">#</a> CPU interfaces (ICC_*_ELn)</h3><h2 id="lift-cycle-of-an-interrupt" tabindex="-1"><a class="header-anchor" href="#lift-cycle-of-an-interrupt" aria-hidden="true">#</a> Lift cycle of an interrupt</h2><h3 id="level-sensitive-interrupts" tabindex="-1"><a class="header-anchor" href="#level-sensitive-interrupts" aria-hidden="true">#</a> Level-sensitive interrupts</h3><p>For level-sensitive interrupts, a rising edge on the interrupt input causes the interrupt to become pending, and the interrupt is held asserted <strong>until the peripheral de-asserts the interrupt signal</strong>.</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>+-&gt; Inactive
|     |
|     | interrupt source is asserted
|     V
|   Pending
|     |
|     | ack the irq by reading IAR
|     V
|   Active and Pending
|     |
|     | peripheral de-asserts the interrupt signal.
|     | software writing to a status register in the periphsral.
|     V
|   Active
|     |
|     | writing to EOIR
+-----+
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="edge-sensitive-interrupts" tabindex="-1"><a class="header-anchor" href="#edge-sensitive-interrupts" aria-hidden="true">#</a> Edge-sensitive interrupts</h3><p>For edge-sensitive interrupts, a rising edge on the interrupt input causes the interrupt to become pending, <strong>but the interrupt is not held asserted</strong>.</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>    Inactive
      |
      | interrupt source is asserted
      V
+-&gt; Pending
|     |
|     | ack the irq by reading IAR
|     V
|   Active
|     |
|     | (Option) peripheral re-asserts the interrupt signal.
|     V
|   (Option) Active and pending
|     |
|     | writing to EOIR and GIC re-asserts the interrupt signal
+-----+
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="end-of-interrupt" tabindex="-1"><a class="header-anchor" href="#end-of-interrupt" aria-hidden="true">#</a> End of interrupt</h3><p>Once the interrupt has been handled, software must inform the interrupt controller that the interrupt has been handled, so that the state machine can transition to the next state.</p><p><strong>GICv3 treats this as two tasks</strong></p><ul><li>Priority drop</li><li>Deactivation</li></ul><p>In the GICv3 architecture, priority drop and deactivation can happen together or separately. This is determined by the settings of <code>ICC_CTLR_ELn.EOImode</code>:</p><ul><li>EOImode == 0: A write to <code>ICC_EOIR0_EL1</code> for Group 0 interrupts, or <code>ICC_EOIR1_EL1</code> for Group 1 interrupts, performs both the priority drop and deactivation.</li><li>EOImode == 1: A write to <code>ICC_EOIR0_EL1</code> for Group interrupts, or <code>ICC_EOIR1_EL1</code> for Group 1 interrupts results in a priority drop. A seperate write to <code>ICC_DIR_EL1</code> is required for deactivation. This mode is often used for virtualization purposes.</li></ul><h2 id="affinity" tabindex="-1"><a class="header-anchor" href="#affinity" aria-hidden="true">#</a> Affinity</h2><p>GICv3 uses affinity routing to identify connected PEs and to route interrupts to <strong>a specific PE or group of PEs</strong>.</p><p>An affinity is a 32-bit value that is split into four fields:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>&lt;affinity level 3&gt;.&lt;affinity level 2&gt;.&lt;affinity level 1&gt;.&lt;affinity level 0&gt;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>At affinity level 0 there is a Redistributor.</p><p>The affinity of a PE is reported in <code>MPIDR_EL1</code>.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> u64 <span class="token function">gic_mpidr_to_affinity</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> mpidr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        u64 aff<span class="token punctuation">;</span>

        aff <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>u64<span class="token punctuation">)</span><span class="token function">MPIDR_AFFINITY_LEVEL</span><span class="token punctuation">(</span>mpidr<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">32</span> <span class="token operator">|</span>
               <span class="token function">MPIDR_AFFINITY_LEVEL</span><span class="token punctuation">(</span>mpidr<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span> <span class="token operator">|</span>
               <span class="token function">MPIDR_AFFINITY_LEVEL</span><span class="token punctuation">(</span>mpidr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span>  <span class="token operator">|</span>
               <span class="token function">MPIDR_AFFINITY_LEVEL</span><span class="token punctuation">(</span>mpidr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> aff<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>Router information stored in <code>GICD_IROUTER</code> register.</p><p>The SPI can be delivered to any connected PE that is participating in distribution of the interrupt group when <code>GICD_IROUTERn.Interrupt_Routing_Mode == 1</code>.</p><p>The Distributor, rather than software, selects the target PE. The target can therefore vary each time the interrupt is signaled. This type of routing is referred to as 1-of-N.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token function">gic_write_irouter</span><span class="token punctuation">(</span>affinity<span class="token punctuation">,</span> base <span class="token operator">+</span> GICD_IROUTER <span class="token operator">+</span> irqnr <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h2 id="interrupt-prioritization" tabindex="-1"><a class="header-anchor" href="#interrupt-prioritization" aria-hidden="true">#</a> Interrupt prioritization</h2><p>The Priority Mask register sets the minimum priority that an interrupt must have to be forwarded to the PE.</p><p>When a PE acknowledges an interrupt, its running priority becomes the same as the priority of the interrupt. The running priority returns to its former value when the PE writes to one of the End of Interrupt(EOI) registers.</p><p>Prioritization describes the</p><ul><li>Configuration and control of interrupt priority</li><li>Order of execution of pending interrupts</li><li>Determination of when interrupts are visible to a target PE, including <ul><li>Interrupt priority masking</li><li>Priority grouping</li><li>Preemption of an active interrupt</li></ul></li></ul><p>Priority values are an 8-bit unsigned binary number. 0x00 is the highest possible priority, and 0xFF is the lowest possible priority</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">gic_irq_set_prio</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">irq_data</span> <span class="token operator">*</span>d<span class="token punctuation">,</span> u8 prio<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">void</span> __iomem <span class="token operator">*</span>base <span class="token operator">=</span> <span class="token function">gic_dist_base</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
        u32 offset<span class="token punctuation">,</span> index<span class="token punctuation">;</span>

        offset <span class="token operator">=</span> <span class="token function">convert_offset_index</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> GICD_IPRIORITYR<span class="token punctuation">,</span> <span class="token operator">&amp;</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">writeb_relaxed</span><span class="token punctuation">(</span>prio<span class="token punctuation">,</span> base <span class="token operator">+</span> offset <span class="token operator">+</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="preemption" tabindex="-1"><a class="header-anchor" href="#preemption" aria-hidden="true">#</a> Preemption</h3><p>A CPU interface supports signaling of higher priority pending interrupts to a target PE before an active interrupt completes.</p><p>A pending interrupt is only signaled if both:</p><ul><li>Its priority is higher than the priority mask for that CPU interface</li><li>Its group prioirty is higher than of the running priority on the CPU interface</li></ul><p><img src="/vue_notebook/assets/img/preemption.6f1d5554.png" alt="Preemption"></p><p>The Arm CoreLink GICv3 architecture allows software to control preemption by specifying the difference in priority required for preemption to occur. This is controlled through the Binary Point registers: <code>ICC_BPRn_EL1</code>.</p><h2 id="virtualization-gic-part" tabindex="-1"><a class="header-anchor" href="#virtualization-gic-part" aria-hidden="true">#</a> Virtualization (GIC part)</h2><h3 id="gicv4-1" tabindex="-1"><a class="header-anchor" href="#gicv4-1" aria-hidden="true">#</a> GICv4(.1)</h3><p>GICv4 supports direct injection of vLPIs. With this feature, physical events <code>(EventID, DeviceID)</code> can be mapped to virtual interrupts.</p><p><strong>If the vPE targeted by interrupt is running, the virtual interrupt can be</strong><strong>forwarded without the need to first enter the hypervisor.</strong></p><h4 id="registers-1" tabindex="-1"><a class="header-anchor" href="#registers-1" aria-hidden="true">#</a> Registers</h4><p>The redistributors have two extra registers to support direct injection.</p><ul><li><p><code>GICR_VPROPBASER</code>: the address of the virtual LPI Configuration table. The configuration of vLPIs is global to all vPEs in the same VM.</p></li><li><p><code>GICR_VPENDBASER</code>: the address of virtual LPI Pending table. As with the physical LPI Pending table, the VPT records the pending state of the vLPIs. <strong>Each vPE has its own private VPT</strong>.</p></li></ul><h4 id="vpe-and-resident-a-vpe" tabindex="-1"><a class="header-anchor" href="#vpe-and-resident-a-vpe" aria-hidden="true">#</a> vPE and resident a vPE</h4><p>Multiple vPEs might be hosted by a single physical PE, with the hypervisor context switching between them. The currently running vPE is referred to to as being scheduled.</p><p>Invoke <code>its_make_vpe_resident</code> to schedule a vPE. More details are provided in the following section.</p><p>Virtual interrupts for the scheduled vPE can be directly injected. If the target vPE is not scheduled, the virtual interrupt is recorded as being pending in the appropriate VPT.</p><h4 id="virtual-lpi-pending-table-vpt" tabindex="-1"><a class="header-anchor" href="#virtual-lpi-pending-table-vpt" aria-hidden="true">#</a> virtual LPI Pending table (VPT)</h4><p><code>GICR_VPENDBASER</code> bits[51:16] contains the physical address of the virtual LPI Pending table.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">its_vpe</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">page</span>             <span class="token operator">*</span>vpt_page<span class="token punctuation">;</span>
        <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="its-commands-for-direct-injetion" tabindex="-1"><a class="header-anchor" href="#its-commands-for-direct-injetion" aria-hidden="true">#</a> ITS commands for direct injetion</h4><ol><li>Mapingp a tuple <code>(EventID, DeviceID)</code> to <code>vINTID</code> for a specific vPE</li></ol><p>Two command can be used to map <code>(EventID, DeviceID)</code> to a <code>vINTID</code> and <code>vPE</code>.</p><ul><li>The <code>VMAPI</code> command is used when the EventID and vINTID are the same <code>VMAPI &lt;DeviceID&gt;, &lt;EventID&gt;, &lt;Doorbell pINTID&gt;, &lt;vPE ID&gt;</code></li><li>The <code>VMAPTI</code> command is used then the EventID and vINTID are different <code>VMAPTI &lt;DeviceID&gt;, &lt;EventID&gt;, &lt;vINTID&gt;, &lt;pINTID&gt;, &lt;vPE ID&gt;</code></li></ul><p>The ITS must be aware of which physical PE a vPE will be scheduled on when it is running. The <code>VMAPP</code> maps a vPE to a physical redistributor.</p><p><code>VMAPP &lt;vPE ID&gt;, &lt;RDADDR&gt;, &lt;VPT&gt;, &lt;VPT size&gt;</code></p><ul><li><code>&lt;RDADDR&gt;</code> is the target redistributor.</li></ul><ol start="2"><li>Mapping a vPE to a physical Redistributor</li></ol><p>If a hypervisor maps a vPE to a different physical PE, the ITS mappings must be updated so that virtual interrupts are sent to the correct physical PE. The ITS mappings are updated using the <code>VMOVP</code> command, followed by <code>VSYNC</code> to synchronize the context.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">its_send_vmovp</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">its_vpe</span> <span class="token operator">*</span>vpe<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h3 id="direct-injection-of-virtual-interrupts-gicv4" tabindex="-1"><a class="header-anchor" href="#direct-injection-of-virtual-interrupts-gicv4" aria-hidden="true">#</a> Direct injection of virtual interrupts (GICv4)</h3><p>GICv4 adds support for the direct injection of virtual LPIs (vLPIs). This feature allows software to describe to the ITS how physical events <code>(EventID, DeviceID)</code> map to <code>virtual interrupts</code>.</p><p>If the vPE targeted by interrupt is running, the virtual interrupt can be forwarded without the need to first enter the hypervisor. This can reduce the overhead associated with virtualized interrupts.</p><h4 id="mapping-eventid-and-deviceid-to-virtual-interrupts" tabindex="-1"><a class="header-anchor" href="#mapping-eventid-and-deviceid-to-virtual-interrupts" aria-hidden="true">#</a> Mapping EventID and DeviceID to virtual interrupts</h4><p>To map <code>(EventID, DeviceID) -&gt; virtual interrupt</code>, <code>its_map_vlpi</code> should be invoked.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">its_map_vlpi</span><span class="token punctuation">(</span><span class="token keyword">int</span> irq<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">its_vlpi_map</span> <span class="token operator">*</span>map<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">its_cmd_info</span> info <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span>cmd_type <span class="token operator">=</span> MAP_VLPI<span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                        <span class="token punctuation">.</span>map      <span class="token operator">=</span> map<span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

        <span class="token comment">/*
         * The host will never see that interrupt firing again, so it
         * is vital that we don&#39;t do any lazy masking.
         */</span>
        <span class="token function">irq_set_status_flags</span><span class="token punctuation">(</span>irq<span class="token punctuation">,</span> IRQ_DISABLE_UNLAZY<span class="token punctuation">)</span><span class="token punctuation">;</span>

        ret <span class="token operator">=</span> <span class="token function">irq_set_vcpu_affinity</span><span class="token punctuation">(</span>irq<span class="token punctuation">,</span> <span class="token operator">&amp;</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
                <span class="token function">irq_clear_status_flags</span><span class="token punctuation">(</span>irq<span class="token punctuation">,</span> IRQ_DISABLE_UNLAZY<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">its_vlpi_map</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">irq_data</span> <span class="token operator">*</span>d<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">its_cmd_info</span> <span class="token operator">*</span>info<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">its_device</span> <span class="token operator">*</span>its_dev <span class="token operator">=</span> <span class="token function">irq_data_get_irq_chip_data</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
        u32 event <span class="token operator">=</span> <span class="token function">its_get_event_id</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>info<span class="token operator">-&gt;</span>map<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>

        <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>its_dev<span class="token operator">-&gt;</span>event_map<span class="token punctuation">.</span>vlpi_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>its_dev<span class="token operator">-&gt;</span>event_map<span class="token punctuation">.</span>vm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">struct</span> <span class="token class-name">its_vlpi_map</span> <span class="token operator">*</span>maps<span class="token punctuation">;</span>

                maps <span class="token operator">=</span> <span class="token function">kcalloc</span><span class="token punctuation">(</span>its_dev<span class="token operator">-&gt;</span>event_map<span class="token punctuation">.</span>nr_lpis<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>maps<span class="token punctuation">)</span><span class="token punctuation">,</span>
                               GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>maps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        ret <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
                        <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                its_dev<span class="token operator">-&gt;</span>event_map<span class="token punctuation">.</span>vm <span class="token operator">=</span> info<span class="token operator">-&gt;</span>map<span class="token operator">-&gt;</span>vm<span class="token punctuation">;</span>
                its_dev<span class="token operator">-&gt;</span>event_map<span class="token punctuation">.</span>vlpi_maps <span class="token operator">=</span> maps<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>its_dev<span class="token operator">-&gt;</span>event_map<span class="token punctuation">.</span>vm <span class="token operator">!=</span> info<span class="token operator">-&gt;</span>map<span class="token operator">-&gt;</span>vm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
                <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* Get our private copy of the mapping information */</span>
        its_dev<span class="token operator">-&gt;</span>event_map<span class="token punctuation">.</span>vlpi_maps<span class="token punctuation">[</span>event<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span>info<span class="token operator">-&gt;</span>map<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">irqd_is_forwarded_to_vcpu</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">/* Already mapped, move it around */</span>
                <span class="token function">its_send_vmovi</span><span class="token punctuation">(</span>its_dev<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">/* Ensure all the VPEs are mapped on this ITS */</span>
                <span class="token function">its_map_vm</span><span class="token punctuation">(</span>its_dev<span class="token operator">-&gt;</span>its<span class="token punctuation">,</span> info<span class="token operator">-&gt;</span>map<span class="token operator">-&gt;</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">/*
                 * Flag the interrupt as forwarded so that we can
                 * start poking the virtual property table.
                 */</span>
                <span class="token function">irqd_set_forwarded_to_vcpu</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">/* Write out the property to the prop table */</span>
                <span class="token function">lpi_write_config</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> info<span class="token operator">-&gt;</span>map<span class="token operator">-&gt;</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">/* Drop the physical mapping */</span>
                <span class="token function">its_send_discard</span><span class="token punctuation">(</span>its_dev<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">/* and install the virtual one */</span>
                <span class="token function">its_send_vmapti</span><span class="token punctuation">(</span>its_dev<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">/* Increment the number of VLPIs */</span>
                its_dev<span class="token operator">-&gt;</span>event_map<span class="token punctuation">.</span>nr_vlpis<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

out<span class="token operator">:</span>
        <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>its_dev<span class="token operator">-&gt;</span>event_map<span class="token punctuation">.</span>vlpi_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><p>The core function is <code>its_send_vmapti</code>.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">its_send_vmapti</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">its_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> u32 id<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">its_vlpi_map</span> <span class="token operator">*</span>map <span class="token operator">=</span> <span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>event_map<span class="token punctuation">.</span>vlpi_maps<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">its_cmd_desc</span> desc<span class="token punctuation">;</span>

        desc<span class="token punctuation">.</span>its_vmapti_cmd<span class="token punctuation">.</span>vpe <span class="token operator">=</span> map<span class="token operator">-&gt;</span>vpe<span class="token punctuation">;</span>
        desc<span class="token punctuation">.</span>its_vmapti_cmd<span class="token punctuation">.</span>dev <span class="token operator">=</span> dev<span class="token punctuation">;</span>
        desc<span class="token punctuation">.</span>its_vmapti_cmd<span class="token punctuation">.</span>virt_id <span class="token operator">=</span> map<span class="token operator">-&gt;</span>vintid<span class="token punctuation">;</span>
        desc<span class="token punctuation">.</span>its_vmapti_cmd<span class="token punctuation">.</span>event_id <span class="token operator">=</span> id<span class="token punctuation">;</span>
        desc<span class="token punctuation">.</span>its_vmapti_cmd<span class="token punctuation">.</span>db_enabled <span class="token operator">=</span> map<span class="token operator">-&gt;</span>db_enabled<span class="token punctuation">;</span>

        <span class="token function">its_send_single_vcommand</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>its<span class="token punctuation">,</span> its_build_vmapti_cmd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="scheduled-virtual-pe" tabindex="-1"><a class="header-anchor" href="#scheduled-virtual-pe" aria-hidden="true">#</a> Scheduled virtual PE</h4><p>Virtual interrupts for the scheduled vPE can be directly injected. If the target vPE is not scheduled, the virtual interrupt is recorded as being pending in the appropriate VPT.</p><p>When performing a context swith between vPEs, a hypervisor must update the Redistributor registers. This means that the hypervisor must:</p><ul><li>Clear <code>GICR_VPENDBASER.Valid</code></li><li>Poll <code>GICR_BPENDBASER.Dirty</code> until it reads 0</li><li>Update <code>GICR_VPROPBASER</code></li><li>Update <code>GICR_VPROPBASER</code>, setting Valid==1 in the process</li></ul><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">its_make_vpe_resident</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">its_vpe</span> <span class="token operator">*</span>vpe<span class="token punctuation">,</span> bool g0en<span class="token punctuation">,</span> bool g1en<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">its_cmd_info</span> info <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

        <span class="token function">WARN_ON</span><span class="token punctuation">(</span><span class="token function">preemptible</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        info<span class="token punctuation">.</span>cmd_type <span class="token operator">=</span> SCHEDULE_VPE<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">has_v4_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                info<span class="token punctuation">.</span>g0en <span class="token operator">=</span> g0en<span class="token punctuation">;</span>
                info<span class="token punctuation">.</span>g1en <span class="token operator">=</span> g1en<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">/* Disabled the doorbell, as we&#39;re about to enter the guest */</span>
                <span class="token function">disable_irq_nosync</span><span class="token punctuation">(</span>vpe<span class="token operator">-&gt;</span>irq<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        ret <span class="token operator">=</span> <span class="token function">its_send_vpe_cmd</span><span class="token punctuation">(</span>vpe<span class="token punctuation">,</span> <span class="token operator">&amp;</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">)</span>
                vpe<span class="token operator">-&gt;</span>resident <span class="token operator">=</span> true<span class="token punctuation">;</span>

        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>The core function is <code>its_send_vpe_cmd</code> which sends <code>SCHEDULE_VPE</code> cmd.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">its_vpe_4_1_schedule</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">its_vpe</span> <span class="token operator">*</span>vpe<span class="token punctuation">,</span>
                                 <span class="token keyword">struct</span> <span class="token class-name">its_cmd_info</span> <span class="token operator">*</span>info<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">void</span> __iomem <span class="token operator">*</span>vlpi_base <span class="token operator">=</span> <span class="token function">gic_data_rdist_vlpi_base</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        u64 val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">/* Schedule the VPE */</span>
        val <span class="token operator">|=</span> GICR_VPENDBASER_Valid<span class="token punctuation">;</span>
        val <span class="token operator">|=</span> info<span class="token operator">-&gt;</span>g0en <span class="token operator">?</span> GICR_VPENDBASER_4_1_VGRP0EN <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        val <span class="token operator">|=</span> info<span class="token operator">-&gt;</span>g1en <span class="token operator">?</span> GICR_VPENDBASER_4_1_VGRP1EN <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        val <span class="token operator">|=</span> <span class="token function">FIELD_PREP</span><span class="token punctuation">(</span>GICR_VPENDBASER_4_1_VPEID<span class="token punctuation">,</span> vpe<span class="token operator">-&gt;</span>vpe_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">gicr_write_vpendbaser</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> vlpi_base <span class="token operator">+</span> GICR_VPENDBASER<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>It writes <code>VPENDBASER</code> as above.</p><h4 id="inject-interrupts" tabindex="-1"><a class="header-anchor" href="#inject-interrupts" aria-hidden="true">#</a> Inject interrupts</h4><p>When a peripheral writes to <code>GITS_TRANSLATER</code></p><ol><li>The ITS uses the DeviceID to select the appropriate entry from the Device table. This entry identifies the Interrupt translation table to use.</li><li>The ITS uses the EventID to select the appropriate entry from the Interrupt translation table. This will return either: a. A pINTID and Collection ID b. A vINTID and vPE ID, and optionally a pINTID as a door-bell interrupt</li><li>The ITS uses the vPE ID to select the required entry in the vPE table and the vPE table <strong>returns the target Redistributor and the address of the VPT of the vPE</strong>.</li><li>The ITS forwards the vINTID, a door-bell interrupt and VPT address to the target Redistributor.</li><li>The Redistributor compares the VPT address from the ITS against the current <code>GICR_BPENDBASER</code> a. if the VPT address and current <code>GICR_BPENDBASER</code> match, the vPE is scheduled, and the vINTID is forwarded to the virtual CPU interface. b. if the VPT address and current <code>GICR_BPENDBASER</code> do not match, the vPE is not scheduled. The vINTID is set as pending in the VPT. If a door-bell interrupt was provided, the pINTID is forwarded to the physical CPU interface.</li></ol><h3 id="direct-injection-of-virtual-software-generated-interrupts-sgis" tabindex="-1"><a class="header-anchor" href="#direct-injection-of-virtual-software-generated-interrupts-sgis" aria-hidden="true">#</a> Direct injection of virtual Software Generated Interrupts (SGIs)</h3><p>GICv4.1 supports direct injection of SGIs which allows SGIs to be directly injected via the ITS. This mechanism still requires a trap to the hypervisor on the sending PE but removes the need for a trap to the hypervisor on the receiving PE(s).</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">its_vpe</span> <span class="token punctuation">{</span>
        <span class="token keyword">union</span> <span class="token punctuation">{</span>
                <span class="token comment">/* GICv4.0 implementations */</span>
                <span class="token comment">//</span>

                <span class="token comment">/* GICv4.1 implementations */</span>
                <span class="token keyword">struct</span> <span class="token punctuation">{</span>
                        <span class="token comment">//</span>
                        <span class="token keyword">struct</span> <span class="token class-name">irq_domain</span>       <span class="token operator">*</span>sgi_domain<span class="token punctuation">;</span>
                        <span class="token keyword">struct</span> <span class="token punctuation">{</span>
                                u8              priority<span class="token punctuation">;</span>
                                bool            enabled<span class="token punctuation">;</span>
                                bool            group<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>                       sgi_config<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token comment">//</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">its_alloc_vcpu_sgis</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">its_vpe</span> <span class="token operator">*</span>vpe<span class="token punctuation">,</span> <span class="token keyword">int</span> idx<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
        <span class="token keyword">int</span> sgi_base<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">has_v4_1_sgi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

        name <span class="token operator">=</span> <span class="token function">kasprintf</span><span class="token punctuation">(</span>GFP_KERNEL<span class="token punctuation">,</span> <span class="token string">&quot;GICv4-sgi-%d&quot;</span><span class="token punctuation">,</span> <span class="token function">task_pid_nr</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>name<span class="token punctuation">)</span>
                <span class="token keyword">goto</span> err<span class="token punctuation">;</span>

        vpe<span class="token operator">-&gt;</span>fwnode <span class="token operator">=</span> <span class="token function">irq_domain_alloc_named_id_fwnode</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vpe<span class="token operator">-&gt;</span>fwnode<span class="token punctuation">)</span>
                <span class="token keyword">goto</span> err<span class="token punctuation">;</span>

        <span class="token function">kfree</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        name <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

        vpe<span class="token operator">-&gt;</span>sgi_domain <span class="token operator">=</span> <span class="token function">irq_domain_create_linear</span><span class="token punctuation">(</span>vpe<span class="token operator">-&gt;</span>fwnode<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span>
                                                   sgi_domain_ops<span class="token punctuation">,</span> vpe<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vpe<span class="token operator">-&gt;</span>sgi_domain<span class="token punctuation">)</span>
                <span class="token keyword">goto</span> err<span class="token punctuation">;</span>

        sgi_base <span class="token operator">=</span> <span class="token function">__irq_domain_alloc_irqs</span><span class="token punctuation">(</span>vpe<span class="token operator">-&gt;</span>sgi_domain<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span>
                                               NUMA_NO_NODE<span class="token punctuation">,</span> vpe<span class="token punctuation">,</span>
                                               false<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sgi_base <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">goto</span> err<span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

err<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>vpe<span class="token operator">-&gt;</span>sgi_domain<span class="token punctuation">)</span>
                <span class="token function">irq_domain_remove</span><span class="token punctuation">(</span>vpe<span class="token operator">-&gt;</span>sgi_domain<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>vpe<span class="token operator">-&gt;</span>fwnode<span class="token punctuation">)</span>
                <span class="token function">irq_domain_free_fwnode</span><span class="token punctuation">(</span>vpe<span class="token operator">-&gt;</span>fwnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">kfree</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>kvm enables vsgis via <code>vgic_v4_configure_vsgis</code>.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* Must be called with the kvm lock held */</span>
<span class="token keyword">void</span> <span class="token function">vgic_v4_configure_vsgis</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kvm</span> <span class="token operator">*</span>kvm<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">vgic_dist</span> <span class="token operator">*</span>dist <span class="token operator">=</span> <span class="token operator">&amp;</span>kvm<span class="token operator">-&gt;</span>arch<span class="token punctuation">.</span>vgic<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">kvm_vcpu</span> <span class="token operator">*</span>vcpu<span class="token punctuation">;</span>
        <span class="token keyword">int</span> i<span class="token punctuation">;</span>

        <span class="token function">kvm_arm_halt_guest</span><span class="token punctuation">(</span>kvm<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">kvm_for_each_vcpu</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> vcpu<span class="token punctuation">,</span> kvm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>dist<span class="token operator">-&gt;</span>nassgireq<span class="token punctuation">)</span>
                        <span class="token function">vgic_v4_enable_vsgis</span><span class="token punctuation">(</span>vcpu<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span>
                        <span class="token function">vgic_v4_disable_vsgis</span><span class="token punctuation">(</span>vcpu<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">kvm_arm_resume_guest</span><span class="token punctuation">(</span>kvm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">vgic_v4_enable_vsgis</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kvm_vcpu</span> <span class="token operator">*</span>vcpu<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">its_vpe</span> <span class="token operator">*</span>vpe <span class="token operator">=</span> <span class="token operator">&amp;</span>vcpu<span class="token operator">-&gt;</span>arch<span class="token punctuation">.</span>vgic_cpu<span class="token punctuation">.</span>vgic_v3<span class="token punctuation">.</span>its_vpe<span class="token punctuation">;</span>
        <span class="token keyword">int</span> i<span class="token punctuation">;</span>

        <span class="token comment">/*
         * With GICv4.1, every virtual SGI can be directly injected. So
         * let&#39;s pretend that they are HW interrupts, tied to a host
         * IRQ. The SGI code will do its magic.
         */</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> VGIC_NR_SGIS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">struct</span> <span class="token class-name">vgic_irq</span> <span class="token operator">*</span>irq <span class="token operator">=</span> <span class="token function">vgic_get_irq</span><span class="token punctuation">(</span>vcpu<span class="token operator">-&gt;</span>kvm<span class="token punctuation">,</span> vcpu<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">struct</span> <span class="token class-name">irq_desc</span> <span class="token operator">*</span>desc<span class="token punctuation">;</span>
                <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span>
                <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

                <span class="token function">raw_spin_lock_irqsave</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>irq<span class="token operator">-&gt;</span>irq_lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>irq<span class="token operator">-&gt;</span>hw<span class="token punctuation">)</span>
                        <span class="token keyword">goto</span> unlock<span class="token punctuation">;</span>

                irq<span class="token operator">-&gt;</span>hw <span class="token operator">=</span> true<span class="token punctuation">;</span>
                irq<span class="token operator">-&gt;</span>host_irq <span class="token operator">=</span> <span class="token function">irq_find_mapping</span><span class="token punctuation">(</span>vpe<span class="token operator">-&gt;</span>sgi_domain<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">/* Transfer the full irq state to the vPE */</span>
                <span class="token function">vgic_v4_sync_sgi_config</span><span class="token punctuation">(</span>vpe<span class="token punctuation">,</span> irq<span class="token punctuation">)</span><span class="token punctuation">;</span>
                desc <span class="token operator">=</span> <span class="token function">irq_to_desc</span><span class="token punctuation">(</span>irq<span class="token operator">-&gt;</span>host_irq<span class="token punctuation">)</span><span class="token punctuation">;</span>
                ret <span class="token operator">=</span> <span class="token function">irq_domain_activate_irq</span><span class="token punctuation">(</span><span class="token function">irq_desc_get_irq_data</span><span class="token punctuation">(</span>desc<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                              false<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">WARN_ON</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">/* Transfer pending state */</span>
                        ret <span class="token operator">=</span> <span class="token function">irq_set_irqchip_state</span><span class="token punctuation">(</span>irq<span class="token operator">-&gt;</span>host_irq<span class="token punctuation">,</span>
                                                    IRQCHIP_STATE_PENDING<span class="token punctuation">,</span>
                                                    irq<span class="token operator">-&gt;</span>pending_latch<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">WARN_ON</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        irq<span class="token operator">-&gt;</span>pending_latch <span class="token operator">=</span> false<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
        unlock<span class="token operator">:</span>
                <span class="token function">raw_spin_unlock_irqrestore</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>irq<span class="token operator">-&gt;</span>irq_lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">vgic_put_irq</span><span class="token punctuation">(</span>vcpu<span class="token operator">-&gt;</span>kvm<span class="token punctuation">,</span> irq<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><h2 id="virtualization-kvm-part" tabindex="-1"><a class="header-anchor" href="#virtualization-kvm-part" aria-hidden="true">#</a> Virtualization (KVM part)</h2><p>In this section, we are going to talk about how KVM interact with (v)GIC.</p><h3 id="forward-an-interrupt-direct-injection" tabindex="-1"><a class="header-anchor" href="#forward-an-interrupt-direct-injection" aria-hidden="true">#</a> Forward an interrupt (Direct Injection)</h3><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">kvm_vgic_v4_set_forwarding</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kvm</span> <span class="token operator">*</span>kvm<span class="token punctuation">,</span> <span class="token keyword">int</span> virq<span class="token punctuation">,</span>
                               <span class="token keyword">struct</span> <span class="token class-name">kvm_kernel_irq_routing_entry</span> <span class="token operator">*</span>irq_entry<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">vgic_its</span> <span class="token operator">*</span>its<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">vgic_irq</span> <span class="token operator">*</span>irq<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">its_vlpi_map</span> map<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span>
        <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">vgic_supports_direct_msis</span><span class="token punctuation">(</span>kvm<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">/*
         * Get the ITS, and escape early on error (not a valid
         * doorbell for any of our vITSs).
         */</span>
        its <span class="token operator">=</span> <span class="token function">vgic_get_its</span><span class="token punctuation">(</span>kvm<span class="token punctuation">,</span> irq_entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>its<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>its<span class="token operator">-&gt;</span>its_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* Perform the actual DevID/EventID -&gt; LPI translation. */</span>
        ret <span class="token operator">=</span> <span class="token function">vgic_its_resolve_lpi</span><span class="token punctuation">(</span>kvm<span class="token punctuation">,</span> its<span class="token punctuation">,</span> irq_entry<span class="token operator">-&gt;</span>msi<span class="token punctuation">.</span>devid<span class="token punctuation">,</span>
                                   irq_entry<span class="token operator">-&gt;</span>msi<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>irq<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
                <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>        <span class="token comment">/*
         * Emit the mapping request. If it fails, the ITS probably
         * isn&#39;t v4 compatible, so let&#39;s silently bail out. Holding
         * the ITS lock should ensure that nothing can modify the
         * target vcpu.
         */</span>
        map <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">its_vlpi_map</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span>vm             <span class="token operator">=</span> <span class="token operator">&amp;</span>kvm<span class="token operator">-&gt;</span>arch<span class="token punctuation">.</span>vgic<span class="token punctuation">.</span>its_vm<span class="token punctuation">,</span>
                <span class="token punctuation">.</span>vpe            <span class="token operator">=</span> <span class="token operator">&amp;</span>irq<span class="token operator">-&gt;</span>target_vcpu<span class="token operator">-&gt;</span>arch<span class="token punctuation">.</span>vgic_cpu<span class="token punctuation">.</span>vgic_v3<span class="token punctuation">.</span>its_vpe<span class="token punctuation">,</span>
                <span class="token punctuation">.</span>vintid         <span class="token operator">=</span> irq<span class="token operator">-&gt;</span>intid<span class="token punctuation">,</span>
                <span class="token punctuation">.</span>properties     <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>irq<span class="token operator">-&gt;</span>priority <span class="token operator">&amp;</span> <span class="token number">0xfc</span><span class="token punctuation">)</span> <span class="token operator">|</span>
                                   <span class="token punctuation">(</span>irq<span class="token operator">-&gt;</span>enabled <span class="token operator">?</span> LPI_PROP_ENABLED <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">|</span>
                                   LPI_PROP_GROUP1<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">.</span>db_enabled     <span class="token operator">=</span> true<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        ret <span class="token operator">=</span> <span class="token function">its_map_vlpi</span><span class="token punctuation">(</span>virq<span class="token punctuation">,</span> <span class="token operator">&amp;</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
                <span class="token keyword">goto</span> out<span class="token punctuation">;</span>

        irq<span class="token operator">-&gt;</span>hw         <span class="token operator">=</span> true<span class="token punctuation">;</span>
        irq<span class="token operator">-&gt;</span>host_irq   <span class="token operator">=</span> virq<span class="token punctuation">;</span>
        <span class="token function">atomic_inc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>map<span class="token punctuation">.</span>vpe<span class="token operator">-&gt;</span>vlpi_count<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* Transfer pending state */</span>
        <span class="token function">raw_spin_lock_irqsave</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>irq<span class="token operator">-&gt;</span>irq_lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>irq<span class="token operator">-&gt;</span>pending_latch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ret <span class="token operator">=</span> <span class="token function">irq_set_irqchip_state</span><span class="token punctuation">(</span>irq<span class="token operator">-&gt;</span>host_irq<span class="token punctuation">,</span>
                                            IRQCHIP_STATE_PENDING<span class="token punctuation">,</span>
                                            irq<span class="token operator">-&gt;</span>pending_latch<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">WARN_RATELIMIT</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> <span class="token string">&quot;IRQ %d&quot;</span><span class="token punctuation">,</span> irq<span class="token operator">-&gt;</span>host_irq<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">/*
                 * Clear pending_latch and communicate this state
                 * change via vgic_queue_irq_unlock.
                 */</span>
                irq<span class="token operator">-&gt;</span>pending_latch <span class="token operator">=</span> false<span class="token punctuation">;</span>
                <span class="token function">vgic_queue_irq_unlock</span><span class="token punctuation">(</span>kvm<span class="token punctuation">,</span> irq<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">raw_spin_unlock_irqrestore</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>irq<span class="token operator">-&gt;</span>irq_lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

out<span class="token operator">:</span>
        <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>its<span class="token operator">-&gt;</span>its_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">8/26/2021, 10:41:00 AM</span></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: zhangjunyu.92@bytedance.com">Zhang Junyu</span><!--[-->, <!--]--><!--]--><!--[--><span class="contributor" title="email: junyu92@163.com">Zhang Junyu</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev">  <a href="/vue_notebook/kernel/interrupt/interrupt_in_linux.html" class="nav-link" aria-label="Interrupt in Linux"><!--[--><!--]--> Interrupt in Linux <!--[--><!--]--></a></span><span class="next"><a href="/vue_notebook/kernel/interrupt/its.html" class="nav-link" aria-label="Interrupt Translation Service"><!--[--><!--]--> Interrupt Translation Service <!--[--><!--]--></a>  </span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script src="/vue_notebook/assets/js/runtime~app.47f1fcf0.js" defer></script><script src="/vue_notebook/assets/js/1812.154fe714.js" defer></script><script src="/vue_notebook/assets/js/app.1f287e75.js" defer></script>
  </body>
</html>
