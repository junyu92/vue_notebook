<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.26">
    <title>Interrupt Translation Service | Notebook</title><meta name="description" content="">
    <link rel="preload" href="/vue_notebook/assets/js/runtime~app.47f1fcf0.js" as="script"><link rel="preload" href="/vue_notebook/assets/css/styles.799329ce.css" as="style"><link rel="preload" href="/vue_notebook/assets/js/1812.154fe714.js" as="script"><link rel="preload" href="/vue_notebook/assets/js/app.1f287e75.js" as="script">
    <link rel="stylesheet" href="/vue_notebook/assets/css/styles.799329ce.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/vue_notebook/" class=""><!----><span class="site-name">Notebook</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><!----><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><!----><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item active">Kernel</p><ul class=""><li><!--[--><p class="sidebar-item">Booting and Initialization</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/boot/entry.html" class="nav-link sidebar-item" aria-label="Kernel entry point"><!--[--><!--]--> Kernel entry point <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/boot/kaslr.html" class="nav-link sidebar-item" aria-label="Kernel Address Space Layout Randomization"><!--[--><!--]--> Kernel Address Space Layout Randomization <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Memory Management</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/memory/memory_order.html" class="nav-link sidebar-item" aria-label="Memory Ordering"><!--[--><!--]--> Memory Ordering <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/memory/cache.html" class="nav-link sidebar-item" aria-label="Cache"><!--[--><!--]--> Cache <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/memory/memory_tagging_extension.html" class="nav-link sidebar-item" aria-label="Memory Tagging Extension"><!--[--><!--]--> Memory Tagging Extension <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/memory/arm64_fault.html" class="nav-link sidebar-item" aria-label="ARM64 Fault"><!--[--><!--]--> ARM64 Fault <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/memory/virtualization.html" class="nav-link sidebar-item" aria-label="Memory Virtualization"><!--[--><!--]--> Memory Virtualization <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Task</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/task/idle.md" class="nav-link sidebar-item" aria-label="/kernel/task/idle.md"><!--[--><!--]--> /kernel/task/idle.md <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/task/thread_info.html" class="nav-link sidebar-item" aria-label="Thread Info"><!--[--><!--]--> Thread Info <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Scheduler</p><!----><!--]--></li><li><!--[--><p class="sidebar-item">Syscall</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/syscall/vdso.md" class="nav-link sidebar-item" aria-label="/kernel/syscall/vdso.md"><!--[--><!--]--> /kernel/syscall/vdso.md <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item active">Interrupt Management</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/interrupt/interrupt_in_linux.html" class="nav-link sidebar-item" aria-label="Interrupt in Linux"><!--[--><!--]--> Interrupt in Linux <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/interrupt/gic.html" class="nav-link sidebar-item" aria-label="GIC"><!--[--><!--]--> GIC <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/vue_notebook/kernel/interrupt/its.html" class="router-link-active router-link-exact-active nav-link router-link-active sidebar-item active" aria-label="Interrupt Translation Service"><!--[--><!--]--> Interrupt Translation Service <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Time Management</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/time/time_in_linux.html" class="nav-link sidebar-item" aria-label="Time Framework in Linux"><!--[--><!--]--> Time Framework in Linux <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/time/clocksource_and_timekeeping.html" class="nav-link sidebar-item" aria-label="Clocksource and Timerkeeping"><!--[--><!--]--> Clocksource and Timerkeeping <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/time/jiffies.html" class="nav-link sidebar-item" aria-label="Jiffies"><!--[--><!--]--> Jiffies <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/time/clockevents.html" class="nav-link sidebar-item" aria-label="Clockevents"><!--[--><!--]--> Clockevents <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/time/timer.html" class="nav-link sidebar-item" aria-label="(Hardware) Timer"><!--[--><!--]--> (Hardware) Timer <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/time/hrtimer.html" class="nav-link sidebar-item" aria-label="High resolution timers"><!--[--><!--]--> High resolution timers <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/time/dynamic_timer.html" class="nav-link sidebar-item" aria-label="Dynamic Timer"><!--[--><!--]--> Dynamic Timer <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/time/tick_broadcast.html" class="nav-link sidebar-item" aria-label="Tick Broadcast"><!--[--><!--]--> Tick Broadcast <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">IPC</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/ipc/signal.md" class="nav-link sidebar-item" aria-label="/kernel/ipc/signal.md"><!--[--><!--]--> /kernel/ipc/signal.md <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/ipc/wait.html" class="nav-link sidebar-item" aria-label="Wait"><!--[--><!--]--> Wait <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/ipc/eventfd.html" class="nav-link sidebar-item" aria-label="eventfd"><!--[--><!--]--> eventfd <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Synchronization</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/sync/spinlock.md" class="nav-link sidebar-item" aria-label="/kernel/sync/spinlock.md"><!--[--><!--]--> /kernel/sync/spinlock.md <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/sync/mutex.md" class="nav-link sidebar-item" aria-label="/kernel/sync/mutex.md"><!--[--><!--]--> /kernel/sync/mutex.md <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/sync/semaphore.md" class="nav-link sidebar-item" aria-label="/kernel/sync/semaphore.md"><!--[--><!--]--> /kernel/sync/semaphore.md <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/sync/rcu.md" class="nav-link sidebar-item" aria-label="/kernel/sync/rcu.md"><!--[--><!--]--> /kernel/sync/rcu.md <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Device Driver</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/driver/pci.html" class="nav-link sidebar-item" aria-label="PCI"><!--[--><!--]--> PCI <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Power Management</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/power/psci.html" class="nav-link sidebar-item" aria-label="PSCI"><!--[--><!--]--> PSCI <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Trace</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/trace/lockup.html" class="nav-link sidebar-item" aria-label="lockup detection"><!--[--><!--]--> lockup detection <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/trace/walk_stack_on_arm.html" class="nav-link sidebar-item" aria-label="Walk stack on ARM"><!--[--><!--]--> Walk stack on ARM <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/trace/aarch64_debug.html" class="nav-link sidebar-item" aria-label="AArch64 Debug"><!--[--><!--]--> AArch64 Debug <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/trace/pmu.html" class="nav-link sidebar-item" aria-label="Performance Monitor Unit"><!--[--><!--]--> Performance Monitor Unit <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/trace/spe.html" class="nav-link sidebar-item" aria-label="Statistical Profiling Extension"><!--[--><!--]--> Statistical Profiling Extension <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/trace/kprobes.html" class="nav-link sidebar-item" aria-label="kprobes"><!--[--><!--]--> kprobes <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/trace/ftrace.html" class="nav-link sidebar-item" aria-label="ftrace"><!--[--><!--]--> ftrace <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Misc</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/misc/rseq.html" class="nav-link sidebar-item" aria-label="Restartable Sequences"><!--[--><!--]--> Restartable Sequences <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/misc/export_symbol.html" class="nav-link sidebar-item" aria-label="Export Kernel Symbol"><!--[--><!--]--> Export Kernel Symbol <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/misc/uefi.html" class="nav-link sidebar-item" aria-label="UEFI"><!--[--><!--]--> UEFI <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/misc/dtb.html" class="nav-link sidebar-item" aria-label="Device Tree"><!--[--><!--]--> Device Tree <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Virtualization</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/virtualization/vfio.html" class="nav-link sidebar-item" aria-label="VFIO"><!--[--><!--]--> VFIO <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/virtualization/secure_virt.html" class="nav-link sidebar-item" aria-label="Secure Virtualization"><!--[--><!--]--> Secure Virtualization <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">Rust</p><ul class=""><li><!--[--><a href="/vue_notebook/rust/" class="nav-link sidebar-item" aria-label="Rust"><!--[--><!--]--> Rust <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/rust/trait.html" class="nav-link sidebar-item" aria-label="Trait"><!--[--><!--]--> Trait <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/rust/pin.html" class="nav-link sidebar-item" aria-label="Pin"><!--[--><!--]--> Pin <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/rust/kernel_module_in_rust.html" class="nav-link sidebar-item" aria-label="Kernel Module in Rust"><!--[--><!--]--> Kernel Module in Rust <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">Debug</p><ul class=""><li><!--[--><a href="/vue_notebook/debug/gdb_python.html" class="nav-link sidebar-item" aria-label="GDB Python"><!--[--><!--]--> GDB Python <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">Qemu</p><ul class=""><li><!--[--><a href="/vue_notebook/qemu/pci.html" class="nav-link sidebar-item" aria-label="PCI"><!--[--><!--]--> PCI <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">trusted computing</p><ul class=""><li><!--[--><a href="/vue_notebook/trusted_computing/sgx.html" class="nav-link sidebar-item" aria-label="Intel SGX"><!--[--><!--]--> Intel SGX <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="interrupt-translation-service" tabindex="-1"><a class="header-anchor" href="#interrupt-translation-service" aria-hidden="true">#</a> Interrupt Translation Service</h1><h2 id="introduction" tabindex="-1"><a class="header-anchor" href="#introduction" aria-hidden="true">#</a> Introduction</h2><p>An ITS is used to route Message Signalled interrupts from devices into an LPI injection on the processor.</p><p>An <strong>Interrupt Translation Service</strong> maps interrupts to INTIDs and redistributors.</p><p>New class of interrupts (LPI) via an Interrupt Translation Service (ITS)</p><ul><li>Allows MSI/MSI-X support</li><li>Supports indirections for target cores (via collections)</li><li>Introduces device ID sampled from the bus</li><li>New IRQ class with possibly thousands of LPIs and probably sparse allocation Tables are held in physical memory</li></ul><h2 id="model" tabindex="-1"><a class="header-anchor" href="#model" aria-hidden="true">#</a> Model</h2><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>   +--------+                  +-------------+     +------------+
   | Device | ---------------&gt; | Interrupt   |     | Collection |
   | Table  |                  | Translation |     | Table      |
   +--------+ &lt;-----------     | Tables      |     +------------+
                          \    +-------------+      ^
                           \         ^              |
                            \        |             /
+------------------+         V       V            V
| Peripheral sends |         +--------------------+     +---------------+
| interrupt as     | ------&gt; | ITS                | --&gt; | Redistributor |
| message to ITS   |         +--------------------+     +---------------+
+------------------+
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ol><li>Peripheral sends interrupt as a message to the ITS <ul><li>The message specifies the DeviceID (which peripheral) and an EventID (which interrupt from that peripheral)</li></ul></li><li>ITS uses the DeviceID to index into the <em>Device Table</em><ul><li>Returns pointer to a peripheral specific <em>Interrupt Translation Table</em> (ITT)</li></ul></li><li>ITS uses the EventID to index into the <em>Interrupt Translation Table</em><ul><li>Returns <em>Interrupt translation entry</em> (ITE), that describes: <ul><li>For physical interrupts <ul><li>The output physical INTID</li><li>The <em>Interrupt collection number</em>, ICID</li></ul></li><li>For virtual interrupts <ul><li>The output virtual INTID</li><li>the vPEID</li><li>A doorbell to use if the vPE is not scheduled</li></ul></li></ul></li></ul></li><li>For physical interrupts, ICID selects a <em>Collection table entry</em> in the <em>Collection table</em> (CT) that describes the target Redistributor, and therefore the target PE, to which the interrupt is routed</li><li>For virtual interrupts, in GICv4, the vPEID selects a vPE table entry that describes the Redistributor that is currently hosting the target vPE to which the interrupt is routed</li></ol><h2 id="components" tabindex="-1"><a class="header-anchor" href="#components" aria-hidden="true">#</a> Components</h2><h3 id="configuration-table-and-pending-table" tabindex="-1"><a class="header-anchor" href="#configuration-table-and-pending-table" aria-hidden="true">#</a> Configuration table and Pending table</h3><p>Configuration table entry bit assignments:</p><table><thead><tr><th>Bits</th><th>Name</th><th>Function</th></tr></thead><tbody><tr><td>7:2</td><td>Priority</td><td>The priority of the LPI</td></tr><tr><td>1</td><td></td><td>RES1</td></tr><tr><td>0</td><td>Enable</td><td>LPI enable</td></tr></tbody></table><p><code>GICR_PENDBASER</code> provides the base address of the LPI Pending table for physical LPIs.</p><p>Each Redistributor maintains entries in a seperate LPI Pending table that indicates the pending state of each LPI when <code>GICR_CTLR.EnableLPIs == 1</code> in the Redistributor:</p><ul><li>0: The LPI is not pending</li><li>1: The LPI is pending</li></ul><p>The following function allocates Global Configuration table and per-CPU pending table.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">allocate_lpi_tables</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        u64 val<span class="token punctuation">;</span>
        <span class="token keyword">int</span> err<span class="token punctuation">,</span> cpu<span class="token punctuation">;</span>

        <span class="token comment">/*
         * If LPIs are enabled while we run this from the boot CPU,
         * flag the RD tables as pre-allocated if the stars do align.
         */</span>
        val <span class="token operator">=</span> <span class="token function">readl_relaxed</span><span class="token punctuation">(</span><span class="token function">gic_data_rdist_rd_base</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> GICR_CTLR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>val <span class="token operator">&amp;</span> GICR_CTLR_ENABLE_LPIS<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">enabled_lpis_allowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                gic_rdists<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> <span class="token punctuation">(</span>RDIST_FLAGS_RD_TABLES_PREALLOCATED <span class="token operator">|</span>
                                      RDIST_FLAGS_PROPBASE_NEEDS_FLUSHING<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">&quot;GICv3: Using preallocated redistributor tables\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        err <span class="token operator">=</span> <span class="token function">its_setup_lpi_prop_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                <span class="token keyword">return</span> err<span class="token punctuation">;</span>

        <span class="token comment">/*
         * We allocate all the pending tables anyway, as we may have a
         * mix of RDs that have had LPIs enabled, and some that
         * don&#39;t. We&#39;ll free the unused ones as each CPU comes online.
         */</span>
        <span class="token function">for_each_possible_cpu</span><span class="token punctuation">(</span>cpu<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">struct</span> <span class="token class-name">page</span> <span class="token operator">*</span>pend_page<span class="token punctuation">;</span>

                pend_page <span class="token operator">=</span> <span class="token function">its_allocate_pending_table</span><span class="token punctuation">(</span>GFP_NOWAIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pend_page<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to allocate PENDBASE for CPU%d\n&quot;</span><span class="token punctuation">,</span> cpu<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token function">gic_data_rdist_cpu</span><span class="token punctuation">(</span>cpu<span class="token punctuation">)</span><span class="token operator">-&gt;</span>pend_page <span class="token operator">=</span> pend_page<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><h3 id="its-table" tabindex="-1"><a class="header-anchor" href="#its-table" aria-hidden="true">#</a> ITS Table</h3><p>this is initialized via <code>its_probe_one</code> and <code>its_alloc_tables</code>.</p><p>provide information about the type, size and access attributes for the architected ITS memory structures.</p><h3 id="the-device-table-deviceid" tabindex="-1"><a class="header-anchor" href="#the-device-table-deviceid" aria-hidden="true">#</a> The Device table (DeviceID-&gt;)</h3><p>provides a table of <strong>Device table entries</strong>. Each DTE describes a mapping between a <strong>DeviceID</strong> and an <strong>ITT base address</strong> that points to the memory that the ITS can use to store the translations for the <strong>EventID</strong>.</p><p>DTE entries:</p><table><thead><tr><th>Number of bits</th><th>Assignment</th><th>Notes</th></tr></thead><tbody><tr><td>1</td><td>Valid</td><td></td></tr><tr><td>40</td><td>ITT Address</td><td>Basic physical address</td></tr><tr><td>5</td><td>ITT Range</td><td>Log2 (EventID width supported by the ITT) minus one</td></tr></tbody></table><h3 id="the-interrupt-translation-table-eventid" tabindex="-1"><a class="header-anchor" href="#the-interrupt-translation-table-eventid" aria-hidden="true">#</a> The Interrupt translation table (EventID -&gt;)</h3><table><thead><tr><th>Number of bits</th><th>Assignment</th><th>Notes</th></tr></thead><tbody><tr><td>1</td><td>Valid</td><td></td></tr><tr><td>1</td><td>Interrupt_Type</td><td>indicates whether the interrupt is phys or virt</td></tr><tr><td>Size of the LPI number space</td><td>Interrupt_Number</td><td>pINTID or vINTID</td></tr><tr><td>Size of the LPI number space</td><td>Interrupt Number Hypervisor ID</td><td></td></tr><tr><td>16</td><td>ICID</td><td>Interrupt Collection ID, for phys interrupts only</td></tr><tr><td>16</td><td>vPEID</td><td>vPE ID, for virtual interrupt only</td></tr></tbody></table><h3 id="the-collection-table-collectid" tabindex="-1"><a class="header-anchor" href="#the-collection-table-collectid" aria-hidden="true">#</a> The collection table(CollectID -&gt;)</h3><p>The <em>Collection table</em> (CT) provides a table of <em>Collection table entries</em> (CTEs).</p><table><thead><tr><th>Number of bits</th><th>Assignment</th><th>Notes</th></tr></thead><tbody><tr><td>1</td><td>Valid</td><td></td></tr><tr><td>Size of RB base identifier</td><td>RDbase</td><td></td></tr></tbody></table><h3 id="the-its-command-interface" tabindex="-1"><a class="header-anchor" href="#the-its-command-interface" aria-hidden="true">#</a> The ITS command interface</h3><p>The ITS is configured and managed, including establishing a Translation Table for each device, via an in memory ring shared between the CPU and the ITS controller. The ring is managed via the <code>GITS_CBASER</code> register and indexed by <code>GITS_CWRITER</code> and ``GITS_CREADR` registers.</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>+--------------------+ &lt;- GITS_CBASER
|                    |
+--------------------+ &lt;- GITS_CREADR
| unprocessed cmd    |
+--------------------+
| unprocessed cmd    |
+--------------------+
| unprocessed cmd    |
+--------------------+ &lt;- GITS_CBASER + GITS_CWRITER
|                    |
+--------------------+
|                    |
+--------------------+
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>A processor adds commands to the shared ring and then updates <code>GITS_CWRITER</code> to make them visible to the ITS controller.</p><p>The ITS controller sequentially processes commands from the ring and then updates <code>GITS_CREADR</code> to indicate the the processor that the command has been processed.</p><p>The size of the table is 64K and initialized within <code>its_probe_one</code>.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>        its<span class="token operator">-&gt;</span>cmd_base <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">__get_free_pages</span><span class="token punctuation">(</span>GFP_KERNEL <span class="token operator">|</span> __GFP_ZERO<span class="token punctuation">,</span>
                                                <span class="token function">get_order</span><span class="token punctuation">(</span>ITS_CMD_QUEUE_SZ<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        baser <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">virt_to_phys</span><span class="token punctuation">(</span>its<span class="token operator">-&gt;</span>cmd_base<span class="token punctuation">)</span>    <span class="token operator">|</span>
                 GITS_CBASER_RaWaWb             <span class="token operator">|</span>
                 GITS_CBASER_InnerShareable     <span class="token operator">|</span>
                 <span class="token punctuation">(</span>ITS_CMD_QUEUE_SZ <span class="token operator">/</span> SZ_4K <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">|</span>
                 GITS_CBASER_VALID<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">gits_write_cbaser</span><span class="token punctuation">(</span>baser<span class="token punctuation">,</span> its<span class="token operator">-&gt;</span>base <span class="token operator">+</span> GITS_CBASER<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>Each command has size 32 bytes.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/*
 * The ITS command block, which is what the ITS actually parses.
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">its_cmd_block</span> <span class="token punctuation">{</span>
        u64     raw_cmd<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>Writing command in the table via <code>its_send_single_command</code>.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token function">BUILD_SINGLE_CMD_FUNC</span><span class="token punctuation">(</span>its_send_single_command<span class="token punctuation">,</span> <span class="token class-name">its_cmd_builder_t</span><span class="token punctuation">,</span>
                             <span class="token keyword">struct</span> <span class="token class-name">its_collection</span><span class="token punctuation">,</span> its_build_sync_cmd<span class="token punctuation">)</span>

<span class="token comment">/* Warning, macro hell follows */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">BUILD_SINGLE_CMD_FUNC</span><span class="token expression"><span class="token punctuation">(</span>name<span class="token punctuation">,</span> buildtype<span class="token punctuation">,</span> synctype<span class="token punctuation">,</span> buildfn<span class="token punctuation">)</span>       </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token keyword">void</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">its_node</span> <span class="token operator">*</span>its<span class="token punctuation">,</span>                                         </span><span class="token punctuation">\</span>
          <span class="token expression">buildtype builder<span class="token punctuation">,</span>                                            </span><span class="token punctuation">\</span>
          <span class="token expression"><span class="token keyword">struct</span> <span class="token class-name">its_cmd_desc</span> <span class="token operator">*</span>desc<span class="token punctuation">)</span>                                    </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token punctuation">{</span>                                                                       </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">struct</span> <span class="token class-name">its_cmd_block</span> <span class="token operator">*</span>cmd<span class="token punctuation">,</span> <span class="token operator">*</span>sync_cmd<span class="token punctuation">,</span> <span class="token operator">*</span>next_cmd<span class="token punctuation">;</span>                </span><span class="token punctuation">\</span>
        <span class="token expression">synctype <span class="token operator">*</span>sync_obj<span class="token punctuation">;</span>                                             </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span>                                            </span><span class="token punctuation">\</span>
                                                                        <span class="token punctuation">\</span>
        <span class="token expression"><span class="token function">raw_spin_lock_irqsave</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>its<span class="token operator">-&gt;</span>lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>                       </span><span class="token punctuation">\</span>
                                                                        <span class="token punctuation">\</span>
        <span class="token expression">cmd <span class="token operator">=</span> <span class="token function">its_allocate_entry</span><span class="token punctuation">(</span>its<span class="token punctuation">)</span><span class="token punctuation">;</span>                                  </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>             </span><span class="token comment">/* We&#39;re soooooo screewed... */</span>         <span class="token punctuation">\</span>
                <span class="token expression"><span class="token function">raw_spin_unlock_irqrestore</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>its<span class="token operator">-&gt;</span>lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>          </span><span class="token punctuation">\</span>
                <span class="token expression"><span class="token keyword">return</span><span class="token punctuation">;</span>                                                 </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">}</span>                                                               </span><span class="token punctuation">\</span>
        <span class="token expression">sync_obj <span class="token operator">=</span> <span class="token function">builder</span><span class="token punctuation">(</span>its<span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> desc<span class="token punctuation">)</span><span class="token punctuation">;</span>                             </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token function">its_flush_cmd</span><span class="token punctuation">(</span>its<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>                                        </span><span class="token punctuation">\</span>
                                                                        <span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>sync_obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>                                                 </span><span class="token punctuation">\</span>
                <span class="token expression">sync_cmd <span class="token operator">=</span> <span class="token function">its_allocate_entry</span><span class="token punctuation">(</span>its<span class="token punctuation">)</span><span class="token punctuation">;</span>                     </span><span class="token punctuation">\</span>
                <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sync_cmd<span class="token punctuation">)</span>                                          </span><span class="token punctuation">\</span>
                        <span class="token expression"><span class="token keyword">goto</span> post<span class="token punctuation">;</span>                                      </span><span class="token punctuation">\</span>
                                                                        <span class="token punctuation">\</span>
                <span class="token expression"><span class="token function">buildfn</span><span class="token punctuation">(</span>its<span class="token punctuation">,</span> sync_cmd<span class="token punctuation">,</span> sync_obj<span class="token punctuation">)</span><span class="token punctuation">;</span>                       </span><span class="token punctuation">\</span>
                <span class="token expression"><span class="token function">its_flush_cmd</span><span class="token punctuation">(</span>its<span class="token punctuation">,</span> sync_cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>                           </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">}</span>                                                               </span><span class="token punctuation">\</span>
                                                                        <span class="token punctuation">\</span>
<span class="token expression">post<span class="token operator">:</span>                                                                   </span><span class="token punctuation">\</span>
        <span class="token expression">next_cmd <span class="token operator">=</span> <span class="token function">its_post_commands</span><span class="token punctuation">(</span>its<span class="token punctuation">)</span><span class="token punctuation">;</span>                              </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token function">raw_spin_unlock_irqrestore</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>its<span class="token operator">-&gt;</span>lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>                  </span><span class="token punctuation">\</span>
                                                                        <span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">its_wait_for_range_completion</span><span class="token punctuation">(</span>its<span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> next_cmd<span class="token punctuation">)</span><span class="token punctuation">)</span>          </span><span class="token punctuation">\</span>
                <span class="token expression"><span class="token function">pr_err_ratelimited</span><span class="token punctuation">(</span></span><span class="token string">&quot;ITS cmd %ps failed\n&quot;</span><span class="token expression"><span class="token punctuation">,</span> builder<span class="token punctuation">)</span><span class="token punctuation">;</span>    </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token punctuation">}</span></span></span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">its_cmd_block</span> <span class="token operator">*</span><span class="token function">its_allocate_entry</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">its_node</span> <span class="token operator">*</span>its<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">its_cmd_block</span> <span class="token operator">*</span>cmd<span class="token punctuation">;</span>
        u32 count <span class="token operator">=</span> <span class="token number">1000000</span><span class="token punctuation">;</span>    <span class="token comment">/* 1s! */</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">its_queue_full</span><span class="token punctuation">(</span>its<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                count<span class="token operator">--</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">pr_err_ratelimited</span><span class="token punctuation">(</span><span class="token string">&quot;ITS queue not draining\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">cpu_relax</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">udelay</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        cmd <span class="token operator">=</span> its<span class="token operator">-&gt;</span>cmd_write<span class="token operator">++</span><span class="token punctuation">;</span>

        <span class="token comment">/* Handle queue wrapping */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>its<span class="token operator">-&gt;</span>cmd_write <span class="token operator">==</span> <span class="token punctuation">(</span>its<span class="token operator">-&gt;</span>cmd_base <span class="token operator">+</span> ITS_CMD_QUEUE_NR_ENTRIES<span class="token punctuation">)</span><span class="token punctuation">)</span>
                its<span class="token operator">-&gt;</span>cmd_write <span class="token operator">=</span> its<span class="token operator">-&gt;</span>cmd_base<span class="token punctuation">;</span>

        <span class="token comment">/* Clear command  */</span>
        cmd<span class="token operator">-&gt;</span>raw_cmd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        cmd<span class="token operator">-&gt;</span>raw_cmd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        cmd<span class="token operator">-&gt;</span>raw_cmd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        cmd<span class="token operator">-&gt;</span>raw_cmd<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> cmd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">its_cmd_block</span> <span class="token operator">*</span><span class="token function">its_post_commands</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">its_node</span> <span class="token operator">*</span>its<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        u64 wr <span class="token operator">=</span> <span class="token function">its_cmd_ptr_to_offset</span><span class="token punctuation">(</span>its<span class="token punctuation">,</span> its<span class="token operator">-&gt;</span>cmd_write<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">writel_relaxed</span><span class="token punctuation">(</span>wr<span class="token punctuation">,</span> its<span class="token operator">-&gt;</span>base <span class="token operator">+</span> GITS_CWRITER<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> its<span class="token operator">-&gt;</span>cmd_write<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br></div></div><p>Commands sent on the ring include</p><ul><li>operational commands <ul><li>Routing interrupts to processors</li><li>Generating interrupts</li><li>Clearing the pending state of interrupts</li><li>Synchronising the command queue</li></ul></li><li>maintenance commands <ul><li>Map device/collection/processor</li><li>Map virtual interrupt</li><li>Clean interrupts</li><li>Discard interrupts</li></ul></li></ul><p>According to the specification, we have command</p><ul><li>its_send_int</li><li>its_send_clear</li><li>its_send_inv</li><li>its_send_mapd</li><li>its_send_mapc</li><li>its_send_mapti</li><li>its_send_movi</li><li>its_send_discard</li><li>its_send_vmapti</li><li>its_send_vmovi</li><li>its_send_vmapp</li><li>its_send_vmovp</li><li>its_send_vinvall</li></ul><h2 id="device-tree-node" tabindex="-1"><a class="header-anchor" href="#device-tree-node" aria-hidden="true">#</a> Device Tree Node</h2><p><em>GICv3</em> has one or more ITS that are used to route Message Signalled Interrupts (MSI) to the CPUS.</p><p>For example,</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	gic: interrupt-controller@2cf00000 {
		compatible = &quot;arm,gic-v3&quot;;
		#interrupt-cells = &lt;3&gt;;
		#address-cells = &lt;2&gt;;
		#size-cells = &lt;2&gt;;
		ranges;
		interrupt-controller;
		reg = &lt;0x0 0x2f000000 0 0x10000&gt;,	// GICD
		      &lt;0x0 0x2f100000 0 0x200000&gt;,	// GICR
		      &lt;0x0 0x2c000000 0 0x2000&gt;,	// GICC
		      &lt;0x0 0x2c010000 0 0x2000&gt;,	// GICH
		      &lt;0x0 0x2c020000 0 0x2000&gt;;	// GICV
		interrupts = &lt;1 9 4&gt;;

		gic-its@2c200000 {
			compatible = &quot;arm,gic-v3-its&quot;;
			msi-controller;
			reg = &lt;0x0 0x2c200000 0 0x200000&gt;;
		};
	};

	gic: interrupt-controller@2c010000 {
		compatible = &quot;arm,gic-v3&quot;;
		#interrupt-cells = &lt;3&gt;;
		#address-cells = &lt;2&gt;;
		#size-cells = &lt;2&gt;;
		ranges;
		interrupt-controller;
		redistributor-stride = &lt;0x0 0x40000&gt;;	// 256kB stride
		#redistributor-regions = &lt;2&gt;;
		reg = &lt;0x0 0x2c010000 0 0x10000&gt;,	// GICD
		      &lt;0x0 0x2d000000 0 0x800000&gt;,	// GICR 1: CPUs 0-31
		      &lt;0x0 0x2e000000 0 0x800000&gt;;	// GICR 2: CPUs 32-63
		      &lt;0x0 0x2c040000 0 0x2000&gt;,	// GICC
		      &lt;0x0 0x2c060000 0 0x2000&gt;,	// GICH
		      &lt;0x0 0x2c080000 0 0x2000&gt;;	// GICV
		interrupts = &lt;1 9 4&gt;;

		gic-its@2c200000 {
			compatible = &quot;arm,gic-v3-its&quot;;
			msi-controller;
			reg = &lt;0x0 0x2c200000 0 0x200000&gt;;
		};

		gic-its@2c400000 {
			compatible = &quot;arm,gic-v3-its&quot;;
			msi-controller;
			reg = &lt;0x0 0x2c400000 0 0x200000&gt;;
		};
	};
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><h2 id="how-to" tabindex="-1"><a class="header-anchor" href="#how-to" aria-hidden="true">#</a> HOW TO</h2><h3 id="data-structures" tabindex="-1"><a class="header-anchor" href="#data-structures" aria-hidden="true">#</a> Data Structures</h3><h4 id="struct-lpi-range" tabindex="-1"><a class="header-anchor" href="#struct-lpi-range" aria-hidden="true">#</a> struct lpi_range</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">lpi_range</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span>        entry<span class="token punctuation">;</span>
        u32                     base_id<span class="token punctuation">;</span>
        u32                     span<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token function">LIST_HEAD</span><span class="token punctuation">(</span>lpi_range_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>contains ranges of LPIs that are to available to allocate from.</p><h4 id="struct-its-device" tabindex="-1"><a class="header-anchor" href="#struct-its-device" aria-hidden="true">#</a> struct its_device</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/*
 * The ITS view of a device - belongs to an ITS, owns an interrupt
 * translation table, and a list of interrupts.  If it some of its
 * LPIs are injected into a guest (GICv4), the event_map.vm field
 * indicates which one.
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">its_device</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span>        entry<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">its_node</span>         <span class="token operator">*</span>its<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">event_lpi_map</span>    event_map<span class="token punctuation">;</span>
        <span class="token keyword">void</span>                    <span class="token operator">*</span>itt<span class="token punctuation">;</span>
        u32                     nr_ites<span class="token punctuation">;</span>
        u32                     device_id<span class="token punctuation">;</span>
        bool                    shared<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">event_lpi_map</span> <span class="token punctuation">{</span>
        <span class="token comment">/* map event id to its_vlpi_map */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span>           <span class="token operator">*</span>lpi_map<span class="token punctuation">;</span>
        <span class="token comment">/* collection mapping: maps event id to cpu */</span>
        u16                     <span class="token operator">*</span>col_map<span class="token punctuation">;</span>
        <span class="token comment">/* base hwirq num */</span>
        <span class="token class-name">irq_hw_number_t</span>         lpi_base<span class="token punctuation">;</span>
        <span class="token keyword">int</span>                     nr_lpis<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">mutex</span>            vlpi_lock<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">its_vm</span>           <span class="token operator">*</span>vm<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">its_vlpi_map</span>     <span class="token operator">*</span>vlpi_maps<span class="token punctuation">;</span>
        <span class="token keyword">int</span>                     nr_vlpis<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="helper-function-for-its-chip" tabindex="-1"><a class="header-anchor" href="#helper-function-for-its-chip" aria-hidden="true">#</a> Helper function for its chip</h3><h4 id="create-device" tabindex="-1"><a class="header-anchor" href="#create-device" aria-hidden="true">#</a> create device</h4><p><code>its_msi_prepare</code> is invokes when msi/msix is enabling.</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>- msi_capability_init
- msix_capability_init
  - pci_msi_setup_msi_irqs
    - msi_domain_alloc_irqs
      - msi_domain_prepare_irqs
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">its_msi_prepare</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">irq_domain</span> <span class="token operator">*</span>domain<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
                           <span class="token keyword">int</span> nvec<span class="token punctuation">,</span> <span class="token class-name">msi_alloc_info_t</span> <span class="token operator">*</span>info<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">its_node</span> <span class="token operator">*</span>its<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">its_device</span> <span class="token operator">*</span>its_dev<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">msi_domain_info</span> <span class="token operator">*</span>msi_info<span class="token punctuation">;</span>
        u32 dev_id<span class="token punctuation">;</span>
        <span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">/*
         * We ignore &quot;dev&quot; entierely, and rely on the dev_id that has
         * been passed via the scratchpad. This limits this domain&#39;s
         * usefulness to upper layers that definitely know that they
         * are built on top of the ITS.
         */</span>
        dev_id <span class="token operator">=</span> info<span class="token operator">-&gt;</span>scratchpad<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ul<span class="token punctuation">;</span>

        msi_info <span class="token operator">=</span> <span class="token function">msi_get_domain_info</span><span class="token punctuation">(</span>domain<span class="token punctuation">)</span><span class="token punctuation">;</span>
        its <span class="token operator">=</span> msi_info<span class="token operator">-&gt;</span>data<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>gic_rdists<span class="token operator">-&gt;</span>has_direct_lpi <span class="token operator">&amp;&amp;</span>
            vpe_proxy<span class="token punctuation">.</span>dev <span class="token operator">&amp;&amp;</span>
            vpe_proxy<span class="token punctuation">.</span>dev<span class="token operator">-&gt;</span>its <span class="token operator">==</span> its <span class="token operator">&amp;&amp;</span>
            dev_id <span class="token operator">==</span> vpe_proxy<span class="token punctuation">.</span>dev<span class="token operator">-&gt;</span>device_id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">/* Bad luck. Get yourself a better implementation */</span>
                <span class="token function">WARN_ONCE</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;DevId %x clashes with GICv4 VPE proxy device\n&quot;</span><span class="token punctuation">,</span>
                          dev_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>its<span class="token operator">-&gt;</span>dev_alloc_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        its_dev <span class="token operator">=</span> <span class="token function">its_find_device</span><span class="token punctuation">(</span>its<span class="token punctuation">,</span> dev_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>its_dev<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">/*
                 * We already have seen this ID, probably through
                 * another alias (PCI bridge of some sort). No need to
                 * create the device.
                 */</span>
                its_dev<span class="token operator">-&gt;</span>shared <span class="token operator">=</span> true<span class="token punctuation">;</span>
                <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">&quot;Reusing ITT for devID %x\n&quot;</span><span class="token punctuation">,</span> dev_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        its_dev <span class="token operator">=</span> <span class="token function">its_create_device</span><span class="token punctuation">(</span>its<span class="token punctuation">,</span> dev_id<span class="token punctuation">,</span> nvec<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>its_dev<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                err <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
                <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">&quot;ITT %d entries, %d bits\n&quot;</span><span class="token punctuation">,</span> nvec<span class="token punctuation">,</span> <span class="token function">ilog2</span><span class="token punctuation">(</span>nvec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
out<span class="token operator">:</span>
        <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>its<span class="token operator">-&gt;</span>dev_alloc_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        info<span class="token operator">-&gt;</span>scratchpad<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ptr <span class="token operator">=</span> its_dev<span class="token punctuation">;</span>
        <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">its_device</span> <span class="token operator">*</span><span class="token function">its_create_device</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">its_node</span> <span class="token operator">*</span>its<span class="token punctuation">,</span> u32 dev_id<span class="token punctuation">,</span>
                                            <span class="token keyword">int</span> nvecs<span class="token punctuation">,</span> bool alloc_lpis<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">its_device</span> <span class="token operator">*</span>dev<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>lpi_map <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span>
        u16 <span class="token operator">*</span>col_map <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token operator">*</span>itt<span class="token punctuation">;</span>
        <span class="token keyword">int</span> lpi_base<span class="token punctuation">;</span>
        <span class="token keyword">int</span> nr_lpis<span class="token punctuation">;</span>
        <span class="token keyword">int</span> nr_ites<span class="token punctuation">;</span>
        <span class="token keyword">int</span> sz<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">its_alloc_device_table</span><span class="token punctuation">(</span>its<span class="token punctuation">,</span> dev_id<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WARN_ON</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_power_of_2</span><span class="token punctuation">(</span>nvecs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                nvecs <span class="token operator">=</span> <span class="token function">roundup_pow_of_two</span><span class="token punctuation">(</span>nvecs<span class="token punctuation">)</span><span class="token punctuation">;</span>

        dev <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
         * Even if the device wants a single LPI, the ITT must be
         * sized as a power of two (and you need at least one bit...).
         */</span>
        nr_ites <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> nvecs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sz <span class="token operator">=</span> nr_ites <span class="token operator">*</span> its<span class="token operator">-&gt;</span>ite_size<span class="token punctuation">;</span>
        sz <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>sz<span class="token punctuation">,</span> ITS_ITT_ALIGN<span class="token punctuation">)</span> <span class="token operator">+</span> ITS_ITT_ALIGN <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        itt <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span>sz<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>alloc_lpis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                lpi_map <span class="token operator">=</span> <span class="token function">its_lpi_alloc</span><span class="token punctuation">(</span>nvecs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>lpi_base<span class="token punctuation">,</span> <span class="token operator">&amp;</span>nr_lpis<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>lpi_map<span class="token punctuation">)</span>
                        col_map <span class="token operator">=</span> <span class="token function">kcalloc</span><span class="token punctuation">(</span>nr_lpis<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>col_map<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                          GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                col_map <span class="token operator">=</span> <span class="token function">kcalloc</span><span class="token punctuation">(</span>nr_ites<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>col_map<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
                nr_lpis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                lpi_base <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev <span class="token operator">||</span> <span class="token operator">!</span>itt <span class="token operator">||</span>  <span class="token operator">!</span>col_map <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span>lpi_map <span class="token operator">&amp;&amp;</span> alloc_lpis<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">kfree</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">kfree</span><span class="token punctuation">(</span>itt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">kfree</span><span class="token punctuation">(</span>lpi_map<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">kfree</span><span class="token punctuation">(</span>col_map<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">gic_flush_dcache_to_poc</span><span class="token punctuation">(</span>itt<span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>

        dev<span class="token operator">-&gt;</span>its <span class="token operator">=</span> its<span class="token punctuation">;</span>
        dev<span class="token operator">-&gt;</span>itt <span class="token operator">=</span> itt<span class="token punctuation">;</span>
        dev<span class="token operator">-&gt;</span>nr_ites <span class="token operator">=</span> nr_ites<span class="token punctuation">;</span>
        dev<span class="token operator">-&gt;</span>event_map<span class="token punctuation">.</span>lpi_map <span class="token operator">=</span> lpi_map<span class="token punctuation">;</span>
        dev<span class="token operator">-&gt;</span>event_map<span class="token punctuation">.</span>col_map <span class="token operator">=</span> col_map<span class="token punctuation">;</span>
        dev<span class="token operator">-&gt;</span>event_map<span class="token punctuation">.</span>lpi_base <span class="token operator">=</span> lpi_base<span class="token punctuation">;</span>
        dev<span class="token operator">-&gt;</span>event_map<span class="token punctuation">.</span>nr_lpis <span class="token operator">=</span> nr_lpis<span class="token punctuation">;</span>
        <span class="token function">mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>event_map<span class="token punctuation">.</span>vlpi_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dev<span class="token operator">-&gt;</span>device_id <span class="token operator">=</span> dev_id<span class="token punctuation">;</span>
        <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">raw_spin_lock_irqsave</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>its<span class="token operator">-&gt;</span>lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">list_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>entry<span class="token punctuation">,</span> <span class="token operator">&amp;</span>its<span class="token operator">-&gt;</span>its_device_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">raw_spin_unlock_irqrestore</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>its<span class="token operator">-&gt;</span>lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* Map device to its ITT */</span>
        <span class="token function">its_send_mapd</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> dev<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br></div></div><h4 id="allocate-hwirq-for-device" tabindex="-1"><a class="header-anchor" href="#allocate-hwirq-for-device" aria-hidden="true">#</a> allocate hwirq for device</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">its_irq_domain_alloc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">irq_domain</span> <span class="token operator">*</span>domain<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> virq<span class="token punctuation">,</span>
                                <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nr_irqs<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>args<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token class-name">msi_alloc_info_t</span> <span class="token operator">*</span>info <span class="token operator">=</span> args<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">its_device</span> <span class="token operator">*</span>its_dev <span class="token operator">=</span> info<span class="token operator">-&gt;</span>scratchpad<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ptr<span class="token punctuation">;</span>
        <span class="token class-name">irq_hw_number_t</span> hwirq<span class="token punctuation">;</span>
        <span class="token keyword">int</span> err<span class="token punctuation">;</span>
        <span class="token keyword">int</span> i<span class="token punctuation">;</span>

        <span class="token comment">// alloc hardware irq</span>
        err <span class="token operator">=</span> <span class="token function">its_alloc_device_irq</span><span class="token punctuation">(</span>its_dev<span class="token punctuation">,</span> nr_irqs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hwirq<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                <span class="token keyword">return</span> err<span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nr_irqs<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                err <span class="token operator">=</span> <span class="token function">its_irq_gic_domain_alloc</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> virq <span class="token operator">+</span> i<span class="token punctuation">,</span> hwirq <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                        <span class="token keyword">return</span> err<span class="token punctuation">;</span>

                <span class="token comment">// setup irq_data</span>
                <span class="token function">irq_domain_set_hwirq_and_chip</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> virq <span class="token operator">+</span> i<span class="token punctuation">,</span>
                                              hwirq <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token operator">&amp;</span>its_irq_chip<span class="token punctuation">,</span> its_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">irqd_set_single_target</span><span class="token punctuation">(</span><span class="token function">irq_desc_get_irq_data</span><span class="token punctuation">(</span><span class="token function">irq_to_desc</span><span class="token punctuation">(</span>virq <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">&quot;ID:%d pID:%d vID:%d\n&quot;</span><span class="token punctuation">,</span>
                         <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>hwirq <span class="token operator">+</span> i <span class="token operator">-</span> its_dev<span class="token operator">-&gt;</span>event_map<span class="token punctuation">.</span>lpi_base<span class="token punctuation">)</span><span class="token punctuation">,</span>
                         <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>hwirq <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> virq <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h4 id="activate-irq" tabindex="-1"><a class="header-anchor" href="#activate-irq" aria-hidden="true">#</a> activate irq</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">its_irq_domain_activate</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">irq_domain</span> <span class="token operator">*</span>domain<span class="token punctuation">,</span>
                                   <span class="token keyword">struct</span> <span class="token class-name">irq_data</span> <span class="token operator">*</span>d<span class="token punctuation">,</span> bool reserve<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">its_device</span> <span class="token operator">*</span>its_dev <span class="token operator">=</span> <span class="token function">irq_data_get_irq_chip_data</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
        u32 event <span class="token operator">=</span> <span class="token function">its_get_event_id</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">cpumask</span> <span class="token operator">*</span>cpu_mask <span class="token operator">=</span> cpu_online_mask<span class="token punctuation">;</span>
        <span class="token keyword">int</span> cpu<span class="token punctuation">;</span>

        <span class="token comment">/* get the cpu_mask of local node */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>its_dev<span class="token operator">-&gt;</span>its<span class="token operator">-&gt;</span>numa_node <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                cpu_mask <span class="token operator">=</span> <span class="token function">cpumask_of_node</span><span class="token punctuation">(</span>its_dev<span class="token operator">-&gt;</span>its<span class="token operator">-&gt;</span>numa_node<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* Bind the LPI to the first possible CPU */</span>
        cpu <span class="token operator">=</span> <span class="token function">cpumask_first_and</span><span class="token punctuation">(</span>cpu_mask<span class="token punctuation">,</span> cpu_online_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cpu <span class="token operator">&gt;=</span> nr_cpu_ids<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>its_dev<span class="token operator">-&gt;</span>its<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> ITS_FLAGS_WORKAROUND_CAVIUM_23144<span class="token punctuation">)</span>
                        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>

                cpu <span class="token operator">=</span> <span class="token function">cpumask_first</span><span class="token punctuation">(</span>cpu_online_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        its_dev<span class="token operator">-&gt;</span>event_map<span class="token punctuation">.</span>col_map<span class="token punctuation">[</span>event<span class="token punctuation">]</span> <span class="token operator">=</span> cpu<span class="token punctuation">;</span>
        <span class="token function">irq_data_update_effective_affinity</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token function">cpumask_of</span><span class="token punctuation">(</span>cpu<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* Map the GIC IRQ and event to the device */</span>
        <span class="token function">its_send_mapti</span><span class="token punctuation">(</span>its_dev<span class="token punctuation">,</span> d<span class="token operator">-&gt;</span>hwirq<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h3 id="create-gic-its-chip" tabindex="-1"><a class="header-anchor" href="#create-gic-its-chip" aria-hidden="true">#</a> Create GIC ITS chip</h3><p>When kernel is initializing GICv3 chip, it will probe ITS chip and try to initialize it.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">gic_init_bases</span><span class="token punctuation">(</span><span class="token keyword">void</span> __iomem <span class="token operator">*</span>dist_base<span class="token punctuation">,</span>
                                 <span class="token keyword">struct</span> <span class="token class-name">redist_region</span> <span class="token operator">*</span>rdist_regs<span class="token punctuation">,</span>
                                 u32 nr_redist_regions<span class="token punctuation">,</span>
                                 u64 redist_stride<span class="token punctuation">,</span>
                                 <span class="token keyword">struct</span> <span class="token class-name">fwnode_handle</span> <span class="token operator">*</span>handle<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token comment">// ...</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">gic_dist_supports_lpis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">its_init</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gic_data<span class="token punctuation">.</span>rdists<span class="token punctuation">,</span> gic_data<span class="token punctuation">.</span>domain<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">its_cpu_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>For example.</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[    0.000000] NR_IRQS: 64, nr_irqs: 64, preallocated irqs: 0
[    0.000000] GICv3: 256 SPIs implemented
[    0.000000] GICv3: 0 Extended SPIs implemented
[    0.000000] GICv3: Distributor has no Range Selector support
[    0.000000] GICv3: 16 PPIs implemented
[    0.000000] GICv3: no VLPI support, no direct LPI support
[    0.000000] GICv3: CPU0: found redistributor 0 region 0:0x00000000080a0000
[    0.000000] ACPI: SRAT not present
[    0.000000] ITS [mem 0x08080000-0x0809ffff]
[    0.000000] ITS@0x0000000008080000: allocated 8192 Devices @12a7b0000 (indireect, esz 8, psz 64K, shr 1)
[    0.000000] ITS@0x0000000008080000: allocated 8192 Interrupt Collections @12aa7c0000 (flat, esz 8, psz 64K, shr 1)
[    0.000000] GICv3: using LPI property table @0x000000012a7d0000
[    0.000000] GICv3: CPU0: using allocated LPI pending table @0x000000012a7e00000
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><code>gic_init_bases</code> invokes <code>its_init</code> method.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> __init <span class="token function">its_init</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">fwnode_handle</span> <span class="token operator">*</span>handle<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">rdists</span> <span class="token operator">*</span>rdists<span class="token punctuation">,</span>
                    <span class="token keyword">struct</span> <span class="token class-name">irq_domain</span> <span class="token operator">*</span>parent_domain<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>of_node<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">its_node</span> <span class="token operator">*</span>its<span class="token punctuation">;</span>
        bool has_v4 <span class="token operator">=</span> false<span class="token punctuation">;</span>
        <span class="token keyword">int</span> err<span class="token punctuation">;</span>

        its_parent <span class="token operator">=</span> parent_domain<span class="token punctuation">;</span>
        of_node <span class="token operator">=</span> <span class="token function">to_of_node</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>of_node<span class="token punctuation">)</span>
                <span class="token function">its_of_probe</span><span class="token punctuation">(</span>of_node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
                <span class="token function">its_acpi_probe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">list_empty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>its_nodes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">&quot;ITS: No ITS available, not enabling LPIs\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>ENXIO<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        gic_rdists <span class="token operator">=</span> rdists<span class="token punctuation">;</span>

        err <span class="token operator">=</span> <span class="token function">allocate_lpi_tables</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                <span class="token keyword">return</span> err<span class="token punctuation">;</span>

        <span class="token function">list_for_each_entry</span><span class="token punctuation">(</span>its<span class="token punctuation">,</span> <span class="token operator">&amp;</span>its_nodes<span class="token punctuation">,</span> entry<span class="token punctuation">)</span>
                has_v4 <span class="token operator">|=</span> its<span class="token operator">-&gt;</span>is_v4<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>has_v4 <span class="token operator">&amp;</span> rdists<span class="token operator">-&gt;</span>has_vlpis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">its_init_vpe_domain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                    <span class="token function">its_init_v4</span><span class="token punctuation">(</span>parent_domain<span class="token punctuation">,</span> <span class="token operator">&amp;</span>its_vpe_domain_ops<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        rdists<span class="token operator">-&gt;</span>has_vlpis <span class="token operator">=</span> false<span class="token punctuation">;</span>
                        <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">&quot;ITS: Disabling GICv4 support\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token function">register_syscore_ops</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>its_syscore_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p><code>its_init</code> is trivial.</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>its_init
  - its_of_probe
  - allocate_lpi_tables
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="probe-its-chip" tabindex="-1"><a class="header-anchor" href="#probe-its-chip" aria-hidden="true">#</a> probe its chip</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">its_probe_one</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">resource</span> <span class="token operator">*</span>res<span class="token punctuation">,</span>
                                <span class="token keyword">struct</span> <span class="token class-name">fwnode_handle</span> <span class="token operator">*</span>handle<span class="token punctuation">,</span> <span class="token keyword">int</span> numa_node<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">its_node</span> <span class="token operator">*</span>its<span class="token punctuation">;</span>
        <span class="token keyword">void</span> __iomem <span class="token operator">*</span>its_base<span class="token punctuation">;</span>
        u32 val<span class="token punctuation">,</span> ctlr<span class="token punctuation">;</span>
        u64 baser<span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> typer<span class="token punctuation">;</span>
        <span class="token keyword">int</span> err<span class="token punctuation">;</span>

        its_base <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>res<span class="token operator">-&gt;</span>start<span class="token punctuation">,</span> <span class="token function">resource_size</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>its_base<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">&quot;ITS@%pa: Unable to map ITS registers\n&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token operator">-&gt;</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        val <span class="token operator">=</span> <span class="token function">readl_relaxed</span><span class="token punctuation">(</span>its_base <span class="token operator">+</span> GITS_PIDR2<span class="token punctuation">)</span> <span class="token operator">&amp;</span> GIC_PIDR2_ARCH_MASK<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">!=</span> <span class="token number">0x30</span> <span class="token operator">&amp;&amp;</span> val <span class="token operator">!=</span> <span class="token number">0x40</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">&quot;ITS@%pa: No ITS detected, giving up\n&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token operator">-&gt;</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
                err <span class="token operator">=</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span>
                <span class="token keyword">goto</span> out_unmap<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        err <span class="token operator">=</span> <span class="token function">its_force_quiescent</span><span class="token punctuation">(</span>its_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">&quot;ITS@%pa: Failed to quiesce, giving up\n&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token operator">-&gt;</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">goto</span> out_unmap<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">&quot;ITS %pR\n&quot;</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>

        its <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>its<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>its<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                err <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
                <span class="token keyword">goto</span> out_unmap<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>        <span class="token function">raw_spin_lock_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>its<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>its<span class="token operator">-&gt;</span>dev_alloc_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>its<span class="token operator">-&gt;</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>its<span class="token operator">-&gt;</span>its_device_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>        <span class="token comment">// Read `GITS_TYPER` to get the features of the ITS.</span>
        typer <span class="token operator">=</span> <span class="token function">gic_read_typer</span><span class="token punctuation">(</span>its_base <span class="token operator">+</span> GITS_TYPER<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// virtual address</span>
        its<span class="token operator">-&gt;</span>base <span class="token operator">=</span> its_base<span class="token punctuation">;</span>
        <span class="token comment">// physical address specified by dts</span>
        its<span class="token operator">-&gt;</span>phys_base <span class="token operator">=</span> res<span class="token operator">-&gt;</span>start<span class="token punctuation">;</span>
        <span class="token comment">// get ITT_entry_size, bits [7:4]</span>
        its<span class="token operator">-&gt;</span>ite_size <span class="token operator">=</span> <span class="token function">GITS_TYPER_ITT_ENTRY_SIZE</span><span class="token punctuation">(</span>typer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// The number of DeviceID</span>
        its<span class="token operator">-&gt;</span>device_ids <span class="token operator">=</span> <span class="token function">GITS_TYPER_DEVBITS</span><span class="token punctuation">(</span>typer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        its<span class="token operator">-&gt;</span>is_v4 <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>typer <span class="token operator">&amp;</span> GITS_TYPER_VLPIS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>its<span class="token operator">-&gt;</span>is_v4<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>typer <span class="token operator">&amp;</span> GITS_TYPER_VMOVP<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        err <span class="token operator">=</span> <span class="token function">its_compute_its_list_map</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> its_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                                <span class="token keyword">goto</span> out_free_its<span class="token punctuation">;</span>

                        its<span class="token operator">-&gt;</span>list_nr <span class="token operator">=</span> err<span class="token punctuation">;</span>

                        <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">&quot;ITS@%pa: Using ITS number %d\n&quot;</span><span class="token punctuation">,</span>
                                <span class="token operator">&amp;</span>res<span class="token operator">-&gt;</span>start<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">&quot;ITS@%pa: Single VMOVP capable\n&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token operator">-&gt;</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        its<span class="token operator">-&gt;</span>numa_node <span class="token operator">=</span> numa_node<span class="token punctuation">;</span>

        its<span class="token operator">-&gt;</span>cmd_base <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">__get_free_pages</span><span class="token punctuation">(</span>GFP_KERNEL <span class="token operator">|</span> __GFP_ZERO<span class="token punctuation">,</span>
                                                <span class="token function">get_order</span><span class="token punctuation">(</span>ITS_CMD_QUEUE_SZ<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>its<span class="token operator">-&gt;</span>cmd_base<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                err <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
                <span class="token keyword">goto</span> out_free_its<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        its<span class="token operator">-&gt;</span>cmd_write <span class="token operator">=</span> its<span class="token operator">-&gt;</span>cmd_base<span class="token punctuation">;</span>
        its<span class="token operator">-&gt;</span>fwnode_handle <span class="token operator">=</span> handle<span class="token punctuation">;</span>
	<span class="token comment">/*
         * the purpose of GITS_TRANSLATER register is to be
         * Written by a requesting Device to signal an interrupt
         * for translation by the ITS.
	 */</span>
        its<span class="token operator">-&gt;</span>get_msi_base <span class="token operator">=</span> its_irq_get_msi_base<span class="token punctuation">;</span>
        its<span class="token operator">-&gt;</span>msi_domain_flags <span class="token operator">=</span> IRQ_DOMAIN_FLAG_MSI_REMAP<span class="token punctuation">;</span>

        <span class="token function">its_enable_quirks</span><span class="token punctuation">(</span>its<span class="token punctuation">)</span><span class="token punctuation">;</span>

        err <span class="token operator">=</span> <span class="token function">its_alloc_tables</span><span class="token punctuation">(</span>its<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                <span class="token keyword">goto</span> out_free_cmd<span class="token punctuation">;</span>

        err <span class="token operator">=</span> <span class="token function">its_alloc_collections</span><span class="token punctuation">(</span>its<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                <span class="token keyword">goto</span> out_free_tables<span class="token punctuation">;</span>

        baser <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">virt_to_phys</span><span class="token punctuation">(</span>its<span class="token operator">-&gt;</span>cmd_base<span class="token punctuation">)</span>    <span class="token operator">|</span>
                 GITS_CBASER_RaWaWb             <span class="token operator">|</span>
                 GITS_CBASER_InnerShareable     <span class="token operator">|</span>
                 <span class="token punctuation">(</span>ITS_CMD_QUEUE_SZ <span class="token operator">/</span> SZ_4K <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">|</span>
                 GITS_CBASER_VALID<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">gits_write_cbaser</span><span class="token punctuation">(</span>baser<span class="token punctuation">,</span> its<span class="token operator">-&gt;</span>base <span class="token operator">+</span> GITS_CBASER<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tmp <span class="token operator">=</span> <span class="token function">gits_read_cbaser</span><span class="token punctuation">(</span>its<span class="token operator">-&gt;</span>base <span class="token operator">+</span> GITS_CBASER<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tmp <span class="token operator">^</span> baser<span class="token punctuation">)</span> <span class="token operator">&amp;</span> GITS_CBASER_SHAREABILITY_MASK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>tmp <span class="token operator">&amp;</span> GITS_CBASER_SHAREABILITY_MASK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">/*
                         * The HW reports non-shareable, we must
                         * remove the cacheability attributes as
                         * well.
                         */</span>
                        baser <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GITS_CBASER_SHAREABILITY_MASK <span class="token operator">|</span>
                                   GITS_CBASER_CACHEABILITY_MASK<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        baser <span class="token operator">|=</span> GITS_CBASER_nC<span class="token punctuation">;</span>
                        <span class="token function">gits_write_cbaser</span><span class="token punctuation">(</span>baser<span class="token punctuation">,</span> its<span class="token operator">-&gt;</span>base <span class="token operator">+</span> GITS_CBASER<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">&quot;ITS: using cache flushing for cmd queue\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                its<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> ITS_FLAGS_CMDQ_NEEDS_FLUSHING<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">gits_write_cwriter</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> its<span class="token operator">-&gt;</span>base <span class="token operator">+</span> GITS_CWRITER<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctlr <span class="token operator">=</span> <span class="token function">readl_relaxed</span><span class="token punctuation">(</span>its<span class="token operator">-&gt;</span>base <span class="token operator">+</span> GITS_CTLR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctlr <span class="token operator">|=</span> GITS_CTLR_ENABLE<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>its<span class="token operator">-&gt;</span>is_v4<span class="token punctuation">)</span>
                ctlr <span class="token operator">|=</span> GITS_CTLR_ImDe<span class="token punctuation">;</span>
        <span class="token function">writel_relaxed</span><span class="token punctuation">(</span>ctlr<span class="token punctuation">,</span> its<span class="token operator">-&gt;</span>base <span class="token operator">+</span> GITS_CTLR<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">GITS_TYPER_HCC</span><span class="token punctuation">(</span>typer<span class="token punctuation">)</span><span class="token punctuation">)</span>
                its<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> ITS_FLAGS_SAVE_SUSPEND_STATE<span class="token punctuation">;</span>

        err <span class="token operator">=</span> <span class="token function">its_init_domain</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> its<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                <span class="token keyword">goto</span> out_free_tables<span class="token punctuation">;</span>

        <span class="token function">raw_spin_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>its_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">list_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>its<span class="token operator">-&gt;</span>entry<span class="token punctuation">,</span> <span class="token operator">&amp;</span>its_nodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">raw_spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>its_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

out_free_tables<span class="token operator">:</span>
        <span class="token function">its_free_tables</span><span class="token punctuation">(</span>its<span class="token punctuation">)</span><span class="token punctuation">;</span>
out_free_cmd<span class="token operator">:</span>
        <span class="token function">free_pages</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>its<span class="token operator">-&gt;</span>cmd_base<span class="token punctuation">,</span> <span class="token function">get_order</span><span class="token punctuation">(</span>ITS_CMD_QUEUE_SZ<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
out_free_its<span class="token operator">:</span>
        <span class="token function">kfree</span><span class="token punctuation">(</span>its<span class="token punctuation">)</span><span class="token punctuation">;</span>
out_unmap<span class="token operator">:</span>
        <span class="token function">iounmap</span><span class="token punctuation">(</span>its_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">&quot;ITS@%pa: failed probing (%d)\n&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token operator">-&gt;</span>start<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br></div></div><p>initialize tables</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">its_alloc_tables</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">its_node</span> <span class="token operator">*</span>its<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        u64 shr <span class="token operator">=</span> GITS_BASER_InnerShareable<span class="token punctuation">;</span>
        u64 cache <span class="token operator">=</span> GITS_BASER_RaWaWb<span class="token punctuation">;</span>
        u32 psz <span class="token operator">=</span> SZ_64K<span class="token punctuation">;</span>
        <span class="token keyword">int</span> err<span class="token punctuation">,</span> i<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>its<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> ITS_FLAGS_WORKAROUND_CAVIUM_22375<span class="token punctuation">)</span>
                <span class="token comment">/* erratum 24313: ignore memory access type */</span>
                cache <span class="token operator">=</span> GITS_BASER_nCnB<span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> GITS_BASER_NR_REGS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">struct</span> <span class="token class-name">its_baser</span> <span class="token operator">*</span>baser <span class="token operator">=</span> its<span class="token operator">-&gt;</span>tables <span class="token operator">+</span> i<span class="token punctuation">;</span>
                u64 val <span class="token operator">=</span> <span class="token function">its_read_baser</span><span class="token punctuation">(</span>its<span class="token punctuation">,</span> baser<span class="token punctuation">)</span><span class="token punctuation">;</span>
                u64 type <span class="token operator">=</span> <span class="token function">GITS_BASER_TYPE</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
                u32 order <span class="token operator">=</span> <span class="token function">get_order</span><span class="token punctuation">(</span>psz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                bool indirect <span class="token operator">=</span> false<span class="token punctuation">;</span>

                <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> GITS_BASER_TYPE_NONE<span class="token operator">:</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>

                <span class="token keyword">case</span> GITS_BASER_TYPE_DEVICE<span class="token operator">:</span>
                        indirect <span class="token operator">=</span> <span class="token function">its_parse_indirect_baser</span><span class="token punctuation">(</span>its<span class="token punctuation">,</span> baser<span class="token punctuation">,</span>
                                                            psz<span class="token punctuation">,</span> <span class="token operator">&amp;</span>order<span class="token punctuation">,</span>
                                                            its<span class="token operator">-&gt;</span>device_ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> GITS_BASER_TYPE_VCPU<span class="token operator">:</span>
                        indirect <span class="token operator">=</span> <span class="token function">its_parse_indirect_baser</span><span class="token punctuation">(</span>its<span class="token punctuation">,</span> baser<span class="token punctuation">,</span>
                                                            psz<span class="token punctuation">,</span> <span class="token operator">&amp;</span>order<span class="token punctuation">,</span>
                                                            ITS_MAX_VPEID_BITS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                err <span class="token operator">=</span> <span class="token function">its_setup_baser</span><span class="token punctuation">(</span>its<span class="token punctuation">,</span> baser<span class="token punctuation">,</span> cache<span class="token punctuation">,</span> shr<span class="token punctuation">,</span> psz<span class="token punctuation">,</span> order<span class="token punctuation">,</span> indirect<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">its_free_tables</span><span class="token punctuation">(</span>its<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> err<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">/* Update settings which will be used for next BASERn */</span>
                psz <span class="token operator">=</span> baser<span class="token operator">-&gt;</span>psz<span class="token punctuation">;</span>
                cache <span class="token operator">=</span> baser<span class="token operator">-&gt;</span>val <span class="token operator">&amp;</span> GITS_BASER_CACHEABILITY_MASK<span class="token punctuation">;</span>
                shr <span class="token operator">=</span> baser<span class="token operator">-&gt;</span>val <span class="token operator">&amp;</span> GITS_BASER_SHAREABILITY_MASK<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p>initialize collections</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">its_alloc_collections</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">its_node</span> <span class="token operator">*</span>its<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">int</span> i<span class="token punctuation">;</span>

        its<span class="token operator">-&gt;</span>collections <span class="token operator">=</span> <span class="token function">kcalloc</span><span class="token punctuation">(</span>nr_cpu_ids<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>its<span class="token operator">-&gt;</span>collections<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                   GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>its<span class="token operator">-&gt;</span>collections<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nr_cpu_ids<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                its<span class="token operator">-&gt;</span>collections<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>target_address <span class="token operator">=</span> <span class="token operator">~</span><span class="token number">0ULL</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="allocate-lpi-tables" tabindex="-1"><a class="header-anchor" href="#allocate-lpi-tables" aria-hidden="true">#</a> allocate lpi tables</h4><ol><li>its_setup_lpi_prop_table: allocate <code>prop_table</code> for <code>gic_rdists</code></li><li>allocate pending table for each cpu</li></ol><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">allocate_lpi_tables</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        u64 val<span class="token punctuation">;</span>
        <span class="token keyword">int</span> err<span class="token punctuation">,</span> cpu<span class="token punctuation">;</span>

        <span class="token comment">/*
         * If LPIs are enabled while we run this from the boot CPU,
         * flag the RD tables as pre-allocated if the stars do align.
         */</span>
        val <span class="token operator">=</span> <span class="token function">readl_relaxed</span><span class="token punctuation">(</span><span class="token function">gic_data_rdist_rd_base</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> GICR_CTLR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>val <span class="token operator">&amp;</span> GICR_CTLR_ENABLE_LPIS<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">enabled_lpis_allowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                gic_rdists<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> <span class="token punctuation">(</span>RDIST_FLAGS_RD_TABLES_PREALLOCATED <span class="token operator">|</span>
                                      RDIST_FLAGS_PROPBASE_NEEDS_FLUSHING<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">&quot;GICv3: Using preallocated redistributor tables\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        err <span class="token operator">=</span> <span class="token function">its_setup_lpi_prop_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                <span class="token keyword">return</span> err<span class="token punctuation">;</span>

        <span class="token comment">/*
         * We allocate all the pending tables anyway, as we may have a
         * mix of RDs that have had LPIs enabled, and some that
         * don&#39;t. We&#39;ll free the unused ones as each CPU comes online.
         */</span>
        <span class="token function">for_each_possible_cpu</span><span class="token punctuation">(</span>cpu<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">struct</span> <span class="token class-name">page</span> <span class="token operator">*</span>pend_page<span class="token punctuation">;</span>

                pend_page <span class="token operator">=</span> <span class="token function">its_allocate_pending_table</span><span class="token punctuation">(</span>GFP_NOWAIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pend_page<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to allocate PENDBASE for CPU%d\n&quot;</span><span class="token punctuation">,</span> cpu<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token function">gic_data_rdist_cpu</span><span class="token punctuation">(</span>cpu<span class="token punctuation">)</span><span class="token operator">-&gt;</span>pend_page <span class="token operator">=</span> pend_page<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

```c
<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">its_setup_lpi_prop_table</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token comment">// if the physical address is reserved, we don&#39;t need alloc pages for it.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>gic_rdists<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> RDIST_FLAGS_RD_TABLES_PREALLOCATED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                u64 val<span class="token punctuation">;</span>

                val <span class="token operator">=</span> <span class="token function">gicr_read_propbaser</span><span class="token punctuation">(</span><span class="token function">gic_data_rdist_rd_base</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> GICR_PROPBASER<span class="token punctuation">)</span><span class="token punctuation">;</span>
                lpi_id_bits <span class="token operator">=</span> <span class="token punctuation">(</span>val <span class="token operator">&amp;</span> GICR_PROPBASER_IDBITS_MASK<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

                gic_rdists<span class="token operator">-&gt;</span>prop_table_pa <span class="token operator">=</span> val <span class="token operator">&amp;</span> <span class="token function">GENMASK_ULL</span><span class="token punctuation">(</span><span class="token number">51</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                gic_rdists<span class="token operator">-&gt;</span>prop_table_va <span class="token operator">=</span> <span class="token function">memremap</span><span class="token punctuation">(</span>gic_rdists<span class="token operator">-&gt;</span>prop_table_pa<span class="token punctuation">,</span>
                                                     LPI_PROPBASE_SZ<span class="token punctuation">,</span>
                                                     MEMREMAP_WB<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">gic_reset_prop_table</span><span class="token punctuation">(</span>gic_rdists<span class="token operator">-&gt;</span>prop_table_va<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">struct</span> <span class="token class-name">page</span> <span class="token operator">*</span>page<span class="token punctuation">;</span>

                lpi_id_bits <span class="token operator">=</span> <span class="token class-name">min_t</span><span class="token punctuation">(</span>u32<span class="token punctuation">,</span>
                                    <span class="token function">GICD_TYPER_ID_BITS</span><span class="token punctuation">(</span>gic_rdists<span class="token operator">-&gt;</span>gicd_typer<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    ITS_MAX_LPI_NRBITS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                page <span class="token operator">=</span> <span class="token function">its_allocate_prop_table</span><span class="token punctuation">(</span>GFP_NOWAIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>page<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to allocate PROPBASE\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                gic_rdists<span class="token operator">-&gt;</span>prop_table_pa <span class="token operator">=</span> <span class="token function">page_to_phys</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
                gic_rdists<span class="token operator">-&gt;</span>prop_table_va <span class="token operator">=</span> <span class="token function">page_address</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">WARN_ON</span><span class="token punctuation">(</span><span class="token function">gic_reserve_range</span><span class="token punctuation">(</span>gic_rdists<span class="token operator">-&gt;</span>prop_table_pa<span class="token punctuation">,</span>
                                          LPI_PROPBASE_SZ<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">&quot;GICv3: using LPI property table @%pa\n&quot;</span><span class="token punctuation">,</span>
                <span class="token operator">&amp;</span>gic_rdists<span class="token operator">-&gt;</span>prop_table_pa<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">its_lpi_init</span><span class="token punctuation">(</span>lpi_id_bits<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br></div></div><p>initliaze LPI irq numbers</p><p><code>its_lpi_init</code> insert LPI numbers [8192-8192+lpis] into <code>lpi_range_list</code>.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">its_lpi_init</span><span class="token punctuation">(</span>u32 id_bits<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        u32 lpis <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1UL</span> <span class="token operator">&lt;&lt;</span> id_bits<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">8192</span><span class="token punctuation">;</span>
        u32 numlpis<span class="token punctuation">;</span>
        <span class="token keyword">int</span> err<span class="token punctuation">;</span>

        numlpis <span class="token operator">=</span> <span class="token number">1UL</span> <span class="token operator">&lt;&lt;</span> <span class="token function">GICD_TYPER_NUM_LPIS</span><span class="token punctuation">(</span>gic_rdists<span class="token operator">-&gt;</span>gicd_typer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>numlpis <span class="token operator">&gt;</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">WARN_ON</span><span class="token punctuation">(</span>numlpis <span class="token operator">&gt;</span> lpis<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                lpis <span class="token operator">=</span> numlpis<span class="token punctuation">;</span>
                <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">&quot;ITS: Using hypervisor restricted LPI range [%u]\n&quot;</span><span class="token punctuation">,</span>
                        lpis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/*
         * Initializing the allocator is just the same as freeing the
         * full range of LPIs.
         */</span>
        err <span class="token operator">=</span> <span class="token function">free_lpi_range</span><span class="token punctuation">(</span><span class="token number">8192</span><span class="token punctuation">,</span> lpis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">&quot;ITS: Allocator initialized for %u LPIs\n&quot;</span><span class="token punctuation">,</span> lpis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h4 id="its-cpu-init" tabindex="-1"><a class="header-anchor" href="#its-cpu-init" aria-hidden="true">#</a> its_cpu_init</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">its_cpu_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">list_empty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>its_nodes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

                ret <span class="token operator">=</span> <span class="token function">redist_disable_lpis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
                        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>

                <span class="token function">its_cpu_init_lpis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">its_cpu_init_collections</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">its_cpu_init_lpis</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">void</span> __iomem <span class="token operator">*</span>rbase <span class="token operator">=</span> <span class="token function">gic_data_rdist_rd_base</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">page</span> <span class="token operator">*</span>pend_page<span class="token punctuation">;</span>
        <span class="token class-name">phys_addr_t</span> paddr<span class="token punctuation">;</span>
        u64 val<span class="token punctuation">,</span> tmp<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">gic_data_rdist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>lpi_enabled<span class="token punctuation">)</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>

        val <span class="token operator">=</span> <span class="token function">readl_relaxed</span><span class="token punctuation">(</span>rbase <span class="token operator">+</span> GICR_CTLR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>gic_rdists<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> RDIST_FLAGS_RD_TABLES_PREALLOCATED<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span>val <span class="token operator">&amp;</span> GICR_CTLR_ENABLE_LPIS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">/*
                 * Check that we get the same property table on all
                 * RDs. If we don&#39;t, this is hopeless.
                 */</span>
                paddr <span class="token operator">=</span> <span class="token function">gicr_read_propbaser</span><span class="token punctuation">(</span>rbase <span class="token operator">+</span> GICR_PROPBASER<span class="token punctuation">)</span><span class="token punctuation">;</span>
                paddr <span class="token operator">&amp;=</span> <span class="token function">GENMASK_ULL</span><span class="token punctuation">(</span><span class="token number">51</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WARN_ON</span><span class="token punctuation">(</span>gic_rdists<span class="token operator">-&gt;</span>prop_table_pa <span class="token operator">!=</span> paddr<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token function">add_taint</span><span class="token punctuation">(</span>TAINT_CRAP<span class="token punctuation">,</span> LOCKDEP_STILL_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>

                paddr <span class="token operator">=</span> <span class="token function">gicr_read_pendbaser</span><span class="token punctuation">(</span>rbase <span class="token operator">+</span> GICR_PENDBASER<span class="token punctuation">)</span><span class="token punctuation">;</span>
                paddr <span class="token operator">&amp;=</span> <span class="token function">GENMASK_ULL</span><span class="token punctuation">(</span><span class="token number">51</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token function">WARN_ON</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">gic_check_reserved_range</span><span class="token punctuation">(</span>paddr<span class="token punctuation">,</span> LPI_PENDBASE_SZ<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">its_free_pending_table</span><span class="token punctuation">(</span><span class="token function">gic_data_rdist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>pend_page<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">gic_data_rdist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>pend_page <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

                <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        pend_page <span class="token operator">=</span> <span class="token function">gic_data_rdist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>pend_page<span class="token punctuation">;</span>
        paddr <span class="token operator">=</span> <span class="token function">page_to_phys</span><span class="token punctuation">(</span>pend_page<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">WARN_ON</span><span class="token punctuation">(</span><span class="token function">gic_reserve_range</span><span class="token punctuation">(</span>paddr<span class="token punctuation">,</span> LPI_PENDBASE_SZ<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* set PROPBASE */</span>
        val <span class="token operator">=</span> <span class="token punctuation">(</span>gic_rdists<span class="token operator">-&gt;</span>prop_table_pa <span class="token operator">|</span>
               GICR_PROPBASER_InnerShareable <span class="token operator">|</span>
               GICR_PROPBASER_RaWaWb <span class="token operator">|</span>
               <span class="token punctuation">(</span><span class="token punctuation">(</span>LPI_NRBITS <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> GICR_PROPBASER_IDBITS_MASK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">gicr_write_propbaser</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> rbase <span class="token operator">+</span> GICR_PROPBASER<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tmp <span class="token operator">=</span> <span class="token function">gicr_read_propbaser</span><span class="token punctuation">(</span>rbase <span class="token operator">+</span> GICR_PROPBASER<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tmp <span class="token operator">^</span> val<span class="token punctuation">)</span> <span class="token operator">&amp;</span> GICR_PROPBASER_SHAREABILITY_MASK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>tmp <span class="token operator">&amp;</span> GICR_PROPBASER_SHAREABILITY_MASK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">/*
                         * The HW reports non-shareable, we must
                         * remove the cacheability attributes as
                         * well.
                         */</span>
                        val <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GICR_PROPBASER_SHAREABILITY_MASK <span class="token operator">|</span>
                                 GICR_PROPBASER_CACHEABILITY_MASK<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        val <span class="token operator">|=</span> GICR_PROPBASER_nC<span class="token punctuation">;</span>
                        <span class="token function">gicr_write_propbaser</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> rbase <span class="token operator">+</span> GICR_PROPBASER<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">pr_info_once</span><span class="token punctuation">(</span><span class="token string">&quot;GIC: using cache flushing for LPI property table\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                gic_rdists<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> RDIST_FLAGS_PROPBASE_NEEDS_FLUSHING<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* set PENDBASE */</span>
        val <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">page_to_phys</span><span class="token punctuation">(</span>pend_page<span class="token punctuation">)</span> <span class="token operator">|</span>
               GICR_PENDBASER_InnerShareable <span class="token operator">|</span>
               GICR_PENDBASER_RaWaWb<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">gicr_write_pendbaser</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> rbase <span class="token operator">+</span> GICR_PENDBASER<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tmp <span class="token operator">=</span> <span class="token function">gicr_read_pendbaser</span><span class="token punctuation">(</span>rbase <span class="token operator">+</span> GICR_PENDBASER<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>tmp <span class="token operator">&amp;</span> GICR_PENDBASER_SHAREABILITY_MASK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">/*
                 * The HW reports non-shareable, we must remove the
                 * cacheability attributes as well.
                 */</span>
                val <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>GICR_PENDBASER_SHAREABILITY_MASK <span class="token operator">|</span>
                         GICR_PENDBASER_CACHEABILITY_MASK<span class="token punctuation">)</span><span class="token punctuation">;</span>
                val <span class="token operator">|=</span> GICR_PENDBASER_nC<span class="token punctuation">;</span>
                <span class="token function">gicr_write_pendbaser</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> rbase <span class="token operator">+</span> GICR_PENDBASER<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* Enable LPIs */</span>
        val <span class="token operator">=</span> <span class="token function">readl_relaxed</span><span class="token punctuation">(</span>rbase <span class="token operator">+</span> GICR_CTLR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        val <span class="token operator">|=</span> GICR_CTLR_ENABLE_LPIS<span class="token punctuation">;</span>
        <span class="token function">writel_relaxed</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> rbase <span class="token operator">+</span> GICR_CTLR<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>gic_rdists<span class="token operator">-&gt;</span>has_vlpis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">void</span> __iomem <span class="token operator">*</span>vlpi_base <span class="token operator">=</span> <span class="token function">gic_data_rdist_vlpi_base</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">/*
                 * It&#39;s possible for CPU to receive VLPIs before it is
                 * sheduled as a vPE, especially for the first CPU, and the
                 * VLPI with INTID larger than 2^(IDbits+1) will be considered
                 * as out of range and dropped by GIC.
                 * So we initialize IDbits to known value to avoid VLPI drop.
                 */</span>
                val <span class="token operator">=</span> <span class="token punctuation">(</span>LPI_NRBITS <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> GICR_VPROPBASER_IDBITS_MASK<span class="token punctuation">;</span>
                <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">&quot;GICv4: CPU%d: Init IDbits to 0x%llx for GICR_VPROPBASER\n&quot;</span><span class="token punctuation">,</span>
                        <span class="token function">smp_processor_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">gits_write_vpropbaser</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> vlpi_base <span class="token operator">+</span> GICR_VPROPBASER<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">/*
                 * Also clear Valid bit of GICR_VPENDBASER, in case some
                 * ancient programming gets left in and has possibility of
                 * corrupting memory.
                 */</span>
                val <span class="token operator">=</span> <span class="token function">its_clear_vpend_valid</span><span class="token punctuation">(</span>vlpi_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">WARN_ON</span><span class="token punctuation">(</span>val <span class="token operator">&amp;</span> GICR_VPENDBASER_Dirty<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* Make sure the GIC has seen the above */</span>
        <span class="token function">dsb</span><span class="token punctuation">(</span>sy<span class="token punctuation">)</span><span class="token punctuation">;</span>
out<span class="token operator">:</span>
        <span class="token function">gic_data_rdist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>lpi_enabled <span class="token operator">=</span> true<span class="token punctuation">;</span>
        <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">&quot;GICv3: CPU%d: using %s LPI pending table @%pa\n&quot;</span><span class="token punctuation">,</span>
                <span class="token function">smp_processor_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">gic_data_rdist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>pend_page <span class="token operator">?</span> <span class="token string">&quot;allocated&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;reserved&quot;</span><span class="token punctuation">,</span>
                <span class="token operator">&amp;</span>paddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">its_cpu_init_collections</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">its_node</span> <span class="token operator">*</span>its<span class="token punctuation">;</span>

        <span class="token function">raw_spin_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>its_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">list_for_each_entry</span><span class="token punctuation">(</span>its<span class="token punctuation">,</span> <span class="token operator">&amp;</span>its_nodes<span class="token punctuation">,</span> entry<span class="token punctuation">)</span>
                <span class="token function">its_cpu_init_collection</span><span class="token punctuation">(</span>its<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">raw_spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>its_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">its_cpu_init_collection</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">its_node</span> <span class="token operator">*</span>its<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">int</span> cpu <span class="token operator">=</span> <span class="token function">smp_processor_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        u64 target<span class="token punctuation">;</span>

        <span class="token comment">/* avoid cross node collections and its mapping */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>its<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> ITS_FLAGS_WORKAROUND_CAVIUM_23144<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>cpu_node<span class="token punctuation">;</span>

                cpu_node <span class="token operator">=</span> <span class="token function">of_get_cpu_node</span><span class="token punctuation">(</span>cpu<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>its<span class="token operator">-&gt;</span>numa_node <span class="token operator">!=</span> NUMA_NO_NODE <span class="token operator">&amp;&amp;</span>
                        its<span class="token operator">-&gt;</span>numa_node <span class="token operator">!=</span> <span class="token function">of_node_to_nid</span><span class="token punctuation">(</span>cpu_node<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/*
         * We now have to bind each collection to its target
         * redistributor.
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">gic_read_typer</span><span class="token punctuation">(</span>its<span class="token operator">-&gt;</span>base <span class="token operator">+</span> GITS_TYPER<span class="token punctuation">)</span> <span class="token operator">&amp;</span> GITS_TYPER_PTA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">/*
                 * This ITS wants the physical address of the
                 * redistributor.
                 */</span>
                target <span class="token operator">=</span> <span class="token function">gic_data_rdist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>phys_base<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">/* This ITS wants a linear CPU number. */</span>
                target <span class="token operator">=</span> <span class="token function">gic_read_typer</span><span class="token punctuation">(</span><span class="token function">gic_data_rdist_rd_base</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> GICR_TYPER<span class="token punctuation">)</span><span class="token punctuation">;</span>
                target <span class="token operator">=</span> <span class="token function">GICR_TYPER_CPU_NUMBER</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* Perform collection mapping */</span>
        its<span class="token operator">-&gt;</span>collections<span class="token punctuation">[</span>cpu<span class="token punctuation">]</span><span class="token punctuation">.</span>target_address <span class="token operator">=</span> target<span class="token punctuation">;</span>
        its<span class="token operator">-&gt;</span>collections<span class="token punctuation">[</span>cpu<span class="token punctuation">]</span><span class="token punctuation">.</span>col_id <span class="token operator">=</span> cpu<span class="token punctuation">;</span>

        <span class="token function">its_send_mapc</span><span class="token punctuation">(</span>its<span class="token punctuation">,</span> <span class="token operator">&amp;</span>its<span class="token operator">-&gt;</span>collections<span class="token punctuation">[</span>cpu<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">its_send_invall</span><span class="token punctuation">(</span>its<span class="token punctuation">,</span> <span class="token operator">&amp;</span>its<span class="token operator">-&gt;</span>collections<span class="token punctuation">[</span>cpu<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><h3 id="un-mask-msi-irq" tabindex="-1"><a class="header-anchor" href="#un-mask-msi-irq" aria-hidden="true">#</a> (un)mask MSI IRQ</h3><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">its_mask_msi_irq</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">irq_data</span> <span class="token operator">*</span>d<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token function">pci_msi_mask_irq</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// mask the parent interrupt</span>
        <span class="token function">irq_chip_mask_parent</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">its_unmask_msi_irq</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">irq_data</span> <span class="token operator">*</span>d<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token function">pci_msi_unmask_irq</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// unmask the parent interrupt</span>
        <span class="token function">irq_chip_unmask_parent</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/**
 * pci_msi_mask_irq - Generic irq chip callback to mask PCI/MSI interrupts
 * @data:       pointer to irqdata associated to that interrupt
 */</span>
<span class="token keyword">void</span> <span class="token function">pci_msi_mask_irq</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">irq_data</span> <span class="token operator">*</span>data<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token function">msi_set_mask_bit</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">msi_set_mask_bit</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">irq_data</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> u32 flag<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">msi_desc</span> <span class="token operator">*</span>desc <span class="token operator">=</span> <span class="token function">irq_data_get_msi_desc</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>desc<span class="token operator">-&gt;</span>msi_attrib<span class="token punctuation">.</span>is_msix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">msix_mask_irq</span><span class="token punctuation">(</span>desc<span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">readl</span><span class="token punctuation">(</span>desc<span class="token operator">-&gt;</span>mask_base<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">/* Flush write to device */</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">unsigned</span> offset <span class="token operator">=</span> data<span class="token operator">-&gt;</span>irq <span class="token operator">-</span> desc<span class="token operator">-&gt;</span>irq<span class="token punctuation">;</span>
                <span class="token function">msi_mask_irq</span><span class="token punctuation">(</span>desc<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> offset<span class="token punctuation">,</span> flag <span class="token operator">&lt;&lt;</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Mask MSI-X irq</span>

<span class="token comment">/*
 * This internal function does not flush PCI writes to the device.
 * All users must ensure that they read from the device before either
 * assuming that the device state is up to date, or returning out of this
 * file.  This saves a few milliseconds when initialising devices with lots
 * of MSI-X interrupts.
 */</span>
u32 <span class="token function">__pci_msix_desc_mask_irq</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">msi_desc</span> <span class="token operator">*</span>desc<span class="token punctuation">,</span> u32 flag<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        u32 mask_bits <span class="token operator">=</span> desc<span class="token operator">-&gt;</span>masked<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>pci_msi_ignore_mask<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

        mask_bits <span class="token operator">&amp;=</span> <span class="token operator">~</span>PCI_MSIX_ENTRY_CTRL_MASKBIT<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
                mask_bits <span class="token operator">|=</span> PCI_MSIX_ENTRY_CTRL_MASKBIT<span class="token punctuation">;</span>
        <span class="token function">writel</span><span class="token punctuation">(</span>mask_bits<span class="token punctuation">,</span> <span class="token function">pci_msix_desc_addr</span><span class="token punctuation">(</span>desc<span class="token punctuation">)</span> <span class="token operator">+</span> PCI_MSIX_ENTRY_VECTOR_CTRL<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> mask_bits<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">msix_mask_irq</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">msi_desc</span> <span class="token operator">*</span>desc<span class="token punctuation">,</span> u32 flag<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        desc<span class="token operator">-&gt;</span>masked <span class="token operator">=</span> <span class="token function">__pci_msix_desc_mask_irq</span><span class="token punctuation">(</span>desc<span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Mask MSI irq</span>

<span class="token comment">/*
 * PCI 2.3 does not specify mask bits for each MSI interrupt.  Attempting to
 * mask all MSI interrupts by clearing the MSI enable bit does not work
 * reliably as devices without an INTx disable bit will then generate a
 * level IRQ which will never be cleared.
 */</span>
u32 <span class="token function">__pci_msi_desc_mask_irq</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">msi_desc</span> <span class="token operator">*</span>desc<span class="token punctuation">,</span> u32 mask<span class="token punctuation">,</span> u32 flag<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        u32 mask_bits <span class="token operator">=</span> desc<span class="token operator">-&gt;</span>masked<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>pci_msi_ignore_mask <span class="token operator">||</span> <span class="token operator">!</span>desc<span class="token operator">-&gt;</span>msi_attrib<span class="token punctuation">.</span>maskbit<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

        mask_bits <span class="token operator">&amp;=</span> <span class="token operator">~</span>mask<span class="token punctuation">;</span>
        mask_bits <span class="token operator">|=</span> flag<span class="token punctuation">;</span>
        <span class="token function">pci_write_config_dword</span><span class="token punctuation">(</span><span class="token function">msi_desc_to_pci_dev</span><span class="token punctuation">(</span>desc<span class="token punctuation">)</span><span class="token punctuation">,</span> desc<span class="token operator">-&gt;</span>mask_pos<span class="token punctuation">,</span>
                               mask_bits<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> mask_bits<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">msi_mask_irq</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">msi_desc</span> <span class="token operator">*</span>desc<span class="token punctuation">,</span> u32 mask<span class="token punctuation">,</span> u32 flag<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        desc<span class="token operator">-&gt;</span>masked <span class="token operator">=</span> <span class="token function">__pci_msi_desc_mask_irq</span><span class="token punctuation">(</span>desc<span class="token punctuation">,</span> mask<span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br></div></div><h2 id="virtualization" tabindex="-1"><a class="header-anchor" href="#virtualization" aria-hidden="true">#</a> Virtualization</h2><p>In GICv3, A <strong>virtual LPI</strong> is generated when the hypervisor writes a <strong>vINTID</strong> corresponding to the LPI range, to a List register, in this case, the vINTID that has a value greater than 8191.</p><p>GICv4 provides support for the direct injection of <code>vLPI</code>, in the LPI INTID range. With the direct injection of vLPIs, the <code>GICR_*</code> registers use structures in memory for each <code>vPE</code> to hold LPI configuration and pending information for vLPIs in the same way that they use structures in memory to hold LPI configuration and pending information for physical LPIs.</p><h3 id="model-and-data-structures" tabindex="-1"><a class="header-anchor" href="#model-and-data-structures" aria-hidden="true">#</a> Model and Data Structures</h3><h4 id="data-structures-1" tabindex="-1"><a class="header-anchor" href="#data-structures-1" aria-hidden="true">#</a> Data structures</h4><ul><li><code>struct its_device</code>: a device</li><li><code>struct its_ite</code>: triple <code>(eventid, irq, collection)</code></li></ul><h4 id="helper" tabindex="-1"><a class="header-anchor" href="#helper" aria-hidden="true">#</a> Helper</h4><ul><li><code>find_ite</code> is used to find an interrupt translation table entry (<code>struct its_ite</code>) for a given <code>(Device ID, Event ID)</code> on an ITS.</li></ul><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">its_ite</span> <span class="token operator">*</span><span class="token function">find_ite</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">vgic_its</span> <span class="token operator">*</span>its<span class="token punctuation">,</span> u32 device_id<span class="token punctuation">,</span>
                                  u32 event_id<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">its_device</span> <span class="token operator">*</span>device<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">its_ite</span> <span class="token operator">*</span>ite<span class="token punctuation">;</span>

        device <span class="token operator">=</span> <span class="token function">find_its_device</span><span class="token punctuation">(</span>its<span class="token punctuation">,</span> device_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>device <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

        <span class="token function">list_for_each_entry</span><span class="token punctuation">(</span>ite<span class="token punctuation">,</span> <span class="token operator">&amp;</span>device<span class="token operator">-&gt;</span>itt_head<span class="token punctuation">,</span> ite_list<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ite<span class="token operator">-&gt;</span>event_id <span class="token operator">==</span> event_id<span class="token punctuation">)</span>
                        <span class="token keyword">return</span> ite<span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="api" tabindex="-1"><a class="header-anchor" href="#api" aria-hidden="true">#</a> API</h3><h4 id="ioctl-kvm-dev-arm-its-ctrl-reset" tabindex="-1"><a class="header-anchor" href="#ioctl-kvm-dev-arm-its-ctrl-reset" aria-hidden="true">#</a> ioctl KVM_DEV_ARM_ITS_CTRL_RESET</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* virt/kvm/arm/vgic/vgic-its.c */</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">vgic_its_reset</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kvm</span> <span class="token operator">*</span>kvm<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">vgic_its</span> <span class="token operator">*</span>its<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token comment">/* We need to keep the ABI specific field values */</span>
        its<span class="token operator">-&gt;</span>baser_coll_table <span class="token operator">&amp;=</span> <span class="token operator">~</span>GITS_BASER_VALID<span class="token punctuation">;</span>
        its<span class="token operator">-&gt;</span>baser_device_table <span class="token operator">&amp;=</span> <span class="token operator">~</span>GITS_BASER_VALID<span class="token punctuation">;</span>
        its<span class="token operator">-&gt;</span>cbaser <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        its<span class="token operator">-&gt;</span>creadr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        its<span class="token operator">-&gt;</span>cwriter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        its<span class="token operator">-&gt;</span>enabled <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token function">vgic_its_free_device_list</span><span class="token punctuation">(</span>kvm<span class="token punctuation">,</span> its<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">vgic_its_free_collection_list</span><span class="token punctuation">(</span>kvm<span class="token punctuation">,</span> its<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="ioctl-kvm-dev-arm-its-save-tables" tabindex="-1"><a class="header-anchor" href="#ioctl-kvm-dev-arm-its-save-tables" aria-hidden="true">#</a> ioctl KVM_DEV_ARM_ITS_SAVE_TABLES</h4><p>Save the ITS tables into guest ARM.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">vgic_its_save_tables_v0</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">vgic_its</span> <span class="token operator">*</span>its<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

        ret <span class="token operator">=</span> <span class="token function">vgic_its_save_device_tables</span><span class="token punctuation">(</span>its<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
                <span class="token keyword">return</span> ret<span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">vgic_its_save_collection_table</span><span class="token punctuation">(</span>its<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="ioctl-kvm-dev-arm-its-restore-tables" tabindex="-1"><a class="header-anchor" href="#ioctl-kvm-dev-arm-its-restore-tables" aria-hidden="true">#</a> ioctl KVM_DEV_ARM_ITS_RESTORE_TABLES</h4><p>Restore the ITS tables from guest RAM to internal data structs.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/**
 * vgic_its_restore_tables_v0 - Restore the ITS tables from guest RAM
 * to internal data structs according to V0 ABI
 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">vgic_its_restore_tables_v0</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">vgic_its</span> <span class="token operator">*</span>its<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

        ret <span class="token operator">=</span> <span class="token function">vgic_its_restore_collection_table</span><span class="token punctuation">(</span>its<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
                <span class="token keyword">return</span> ret<span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">vgic_its_restore_device_tables</span><span class="token punctuation">(</span>its<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="direct-injection-of-virtual-interrupts" tabindex="-1"><a class="header-anchor" href="#direct-injection-of-virtual-interrupts" aria-hidden="true">#</a> Direct injection of virtual interrupts</h3><p>The ITS maps an EventID and a DeviceID to an INTID associated with a PE, see The Interrupt Translation Service on page 5-89 for more information. GICv4 introduces the ability to generate a virtual LPI without involving the hypervisor.</p><p>ITE: (EventID -&gt;)</p><ul><li><em>control flag</em>: indicated that the EventID is associated with a virtual LPI</li><li><em>vPEID</em>: to index in to the ITS vPE table</li><li><em>A virtual INTID</em>: indicates which vLPI becomes pending</li><li><em>A physical INTID</em></li></ul><h2 id="reference" tabindex="-1"><a class="header-anchor" href="#reference" aria-hidden="true">#</a> Reference</h2><blockquote><p>http://bos.itdks.com/855dbb545f004e9da1c603f3bcc0a917.pdf https://xenbits.xen.org/people/ianc/vits/draftB.html</p></blockquote><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">6/28/2021, 10:20:27 AM</span></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: zhangjunyu.92@bytedance.com">Zhang Junyu</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"> ← <a href="/vue_notebook/kernel/interrupt/gic.html" class="nav-link" aria-label="GIC"><!--[--><!--]--> GIC <!--[--><!--]--></a></span><!----></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script src="/vue_notebook/assets/js/runtime~app.47f1fcf0.js" defer></script><script src="/vue_notebook/assets/js/1812.154fe714.js" defer></script><script src="/vue_notebook/assets/js/app.1f287e75.js" defer></script>
  </body>
</html>
