<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.26">
    <title>Cache | Notebook</title><meta name="description" content="">
    <link rel="preload" href="/vue_notebook/assets/js/runtime~app.47f1fcf0.js" as="script"><link rel="preload" href="/vue_notebook/assets/css/styles.799329ce.css" as="style"><link rel="preload" href="/vue_notebook/assets/js/1812.154fe714.js" as="script"><link rel="preload" href="/vue_notebook/assets/js/app.1f287e75.js" as="script">
    <link rel="stylesheet" href="/vue_notebook/assets/css/styles.799329ce.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/vue_notebook/" class=""><!----><span class="site-name">Notebook</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><!----><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><!----><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item active">Kernel</p><ul class=""><li><!--[--><p class="sidebar-item">Booting and Initialization</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/boot/entry.html" class="nav-link sidebar-item" aria-label="Kernel entry point"><!--[--><!--]--> Kernel entry point <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/boot/kaslr.html" class="nav-link sidebar-item" aria-label="Kernel Address Space Layout Randomization"><!--[--><!--]--> Kernel Address Space Layout Randomization <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item active">Memory Management</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/memory/memory_order.html" class="nav-link sidebar-item" aria-label="Memory Ordering"><!--[--><!--]--> Memory Ordering <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/vue_notebook/kernel/memory/cache.html" class="router-link-active router-link-exact-active nav-link router-link-active sidebar-item active" aria-label="Cache"><!--[--><!--]--> Cache <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/memory/memory_tagging_extension.html" class="nav-link sidebar-item" aria-label="Memory Tagging Extension"><!--[--><!--]--> Memory Tagging Extension <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/memory/arm64_fault.html" class="nav-link sidebar-item" aria-label="ARM64 Fault"><!--[--><!--]--> ARM64 Fault <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/memory/virtualization.html" class="nav-link sidebar-item" aria-label="Memory Virtualization"><!--[--><!--]--> Memory Virtualization <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Task</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/task/idle.md" class="nav-link sidebar-item" aria-label="/kernel/task/idle.md"><!--[--><!--]--> /kernel/task/idle.md <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/task/thread_info.html" class="nav-link sidebar-item" aria-label="Thread Info"><!--[--><!--]--> Thread Info <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Scheduler</p><!----><!--]--></li><li><!--[--><p class="sidebar-item">Syscall</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/syscall/vdso.md" class="nav-link sidebar-item" aria-label="/kernel/syscall/vdso.md"><!--[--><!--]--> /kernel/syscall/vdso.md <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Interrupt Management</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/interrupt/interrupt_in_linux.html" class="nav-link sidebar-item" aria-label="Interrupt in Linux"><!--[--><!--]--> Interrupt in Linux <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/interrupt/gic.html" class="nav-link sidebar-item" aria-label="GIC"><!--[--><!--]--> GIC <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/interrupt/its.html" class="nav-link sidebar-item" aria-label="Interrupt Translation Service"><!--[--><!--]--> Interrupt Translation Service <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Time Management</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/time/time_in_linux.html" class="nav-link sidebar-item" aria-label="Time Framework in Linux"><!--[--><!--]--> Time Framework in Linux <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/time/clocksource_and_timekeeping.html" class="nav-link sidebar-item" aria-label="Clocksource and Timerkeeping"><!--[--><!--]--> Clocksource and Timerkeeping <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/time/jiffies.html" class="nav-link sidebar-item" aria-label="Jiffies"><!--[--><!--]--> Jiffies <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/time/clockevents.html" class="nav-link sidebar-item" aria-label="Clockevents"><!--[--><!--]--> Clockevents <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/time/timer.html" class="nav-link sidebar-item" aria-label="(Hardware) Timer"><!--[--><!--]--> (Hardware) Timer <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/time/hrtimer.html" class="nav-link sidebar-item" aria-label="High resolution timers"><!--[--><!--]--> High resolution timers <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/time/dynamic_timer.html" class="nav-link sidebar-item" aria-label="Dynamic Timer"><!--[--><!--]--> Dynamic Timer <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/time/tick_broadcast.html" class="nav-link sidebar-item" aria-label="Tick Broadcast"><!--[--><!--]--> Tick Broadcast <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">IPC</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/ipc/signal.md" class="nav-link sidebar-item" aria-label="/kernel/ipc/signal.md"><!--[--><!--]--> /kernel/ipc/signal.md <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/ipc/wait.html" class="nav-link sidebar-item" aria-label="Wait"><!--[--><!--]--> Wait <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/ipc/eventfd.html" class="nav-link sidebar-item" aria-label="eventfd"><!--[--><!--]--> eventfd <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Synchronization</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/sync/spinlock.md" class="nav-link sidebar-item" aria-label="/kernel/sync/spinlock.md"><!--[--><!--]--> /kernel/sync/spinlock.md <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/sync/mutex.md" class="nav-link sidebar-item" aria-label="/kernel/sync/mutex.md"><!--[--><!--]--> /kernel/sync/mutex.md <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/sync/semaphore.md" class="nav-link sidebar-item" aria-label="/kernel/sync/semaphore.md"><!--[--><!--]--> /kernel/sync/semaphore.md <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/sync/rcu.md" class="nav-link sidebar-item" aria-label="/kernel/sync/rcu.md"><!--[--><!--]--> /kernel/sync/rcu.md <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Device Driver</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/driver/pci.html" class="nav-link sidebar-item" aria-label="PCI"><!--[--><!--]--> PCI <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Power Management</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/power/psci.html" class="nav-link sidebar-item" aria-label="PSCI"><!--[--><!--]--> PSCI <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Trace</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/trace/lockup.html" class="nav-link sidebar-item" aria-label="lockup detection"><!--[--><!--]--> lockup detection <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/trace/walk_stack_on_arm.html" class="nav-link sidebar-item" aria-label="Walk stack on ARM"><!--[--><!--]--> Walk stack on ARM <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/trace/aarch64_debug.html" class="nav-link sidebar-item" aria-label="AArch64 Debug"><!--[--><!--]--> AArch64 Debug <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/trace/pmu.html" class="nav-link sidebar-item" aria-label="Performance Monitor Unit"><!--[--><!--]--> Performance Monitor Unit <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/trace/spe.html" class="nav-link sidebar-item" aria-label="Statistical Profiling Extension"><!--[--><!--]--> Statistical Profiling Extension <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/trace/kprobes.html" class="nav-link sidebar-item" aria-label="kprobes"><!--[--><!--]--> kprobes <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/trace/ftrace.html" class="nav-link sidebar-item" aria-label="ftrace"><!--[--><!--]--> ftrace <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Misc</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/misc/rseq.html" class="nav-link sidebar-item" aria-label="Restartable Sequences"><!--[--><!--]--> Restartable Sequences <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/misc/export_symbol.html" class="nav-link sidebar-item" aria-label="Export Kernel Symbol"><!--[--><!--]--> Export Kernel Symbol <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/misc/uefi.html" class="nav-link sidebar-item" aria-label="UEFI"><!--[--><!--]--> UEFI <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/misc/dtb.html" class="nav-link sidebar-item" aria-label="Device Tree"><!--[--><!--]--> Device Tree <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><p class="sidebar-item">Virtualization</p><ul class="sidebar-sub-items"><li><!--[--><a href="/vue_notebook/kernel/virtualization/vfio.html" class="nav-link sidebar-item" aria-label="VFIO"><!--[--><!--]--> VFIO <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/kernel/virtualization/secure_virt.html" class="nav-link sidebar-item" aria-label="Secure Virtualization"><!--[--><!--]--> Secure Virtualization <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">Rust</p><ul class=""><li><!--[--><a href="/vue_notebook/rust/" class="nav-link sidebar-item" aria-label="Rust"><!--[--><!--]--> Rust <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/rust/trait.html" class="nav-link sidebar-item" aria-label="Trait"><!--[--><!--]--> Trait <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/rust/pin.html" class="nav-link sidebar-item" aria-label="Pin"><!--[--><!--]--> Pin <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/vue_notebook/rust/kernel_module_in_rust.html" class="nav-link sidebar-item" aria-label="Kernel Module in Rust"><!--[--><!--]--> Kernel Module in Rust <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">Debug</p><ul class=""><li><!--[--><a href="/vue_notebook/debug/gdb_python.html" class="nav-link sidebar-item" aria-label="GDB Python"><!--[--><!--]--> GDB Python <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">Qemu</p><ul class=""><li><!--[--><a href="/vue_notebook/qemu/pci.html" class="nav-link sidebar-item" aria-label="PCI"><!--[--><!--]--> PCI <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">trusted computing</p><ul class=""><li><!--[--><a href="/vue_notebook/trusted_computing/sgx.html" class="nav-link sidebar-item" aria-label="Intel SGX"><!--[--><!--]--> Intel SGX <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="cache" tabindex="-1"><a class="header-anchor" href="#cache" aria-hidden="true">#</a> Cache</h1><h2 id="introduction" tabindex="-1"><a class="header-anchor" href="#introduction" aria-hidden="true">#</a> Introduction</h2><p>A cache is a small, fast block of memory that sits between the core and main memory. It holds copies of items in main memory.</p><p>Accesses to the cache memory occur significantly faster than those to main memory. Whenever the core reads or writes a particular address, it first looks for it in the cache.</p><p>If it finds the address in the cache, it uses the data in the cache, rather than performing an access to main memory. This significantly increases the potential performance of the system, by reducing the effect of slow external memory access times. It also reduces the power consumption of the system, by avoiding the need to drive external signals.</p><p>Processors that implement the ARMv8-A Architecture are usually implemented with two or more levels of cache.</p><p>This typically means that the processor has small <strong>L1 Instruction and Data caches</strong> for <strong>each core</strong>.</p><p>The Cortex-A53 and Cortex-A57 processors are normally implemented with two or more levels of cache, that is a small L1 Instruction and Data cache and a larger, <strong>unified L2 cache</strong>, which is <strong>shared between multiple cores in a cluster</strong>.</p><p>Additionally, there can be an <strong>external L3 cache</strong> as an external hardware block, <strong>shared between clusters</strong>.</p><h2 id="d-cache-and-i-cache" tabindex="-1"><a class="header-anchor" href="#d-cache-and-i-cache" aria-hidden="true">#</a> D-cache and I-cache</h2><p>In a von Neumann architecture, a single cache is used for instruction and data (a unified cache). A modified Harvard architecture has separate instruction and data buses and therefore there are two caches, an instruction cache (I-cache) and a data cache (D-cache).</p><p>In the ARMv8 processors, there are distinct instruction and data L1 caches backed by a unified L2 cache.</p><h2 id="fundamental-structure-of-a-cache" tabindex="-1"><a class="header-anchor" href="#fundamental-structure-of-a-cache" aria-hidden="true">#</a> Fundamental structure of a cache</h2><p><img src="/vue_notebook/assets/img/cache_terminology.97d248cb.png" alt="CacheTerminology"></p><ul><li>A <strong>tag</strong> is the part of a memory address stored within the cache that identifies the main memory addr associated with a line of data</li><li><strong>cache line</strong> refers to the smallest loadable unit of a cache, a block of contiguous words from main memory</li><li>A <strong>way</strong> is a subdivision of a cache, each way being of equal size and indexed in the same fashion.</li><li>A <strong>set</strong> consists of the cache lines from all ways sharing a particular index</li></ul><h2 id="inclusive-cache-and-exclusive-cache" tabindex="-1"><a class="header-anchor" href="#inclusive-cache-and-exclusive-cache" aria-hidden="true">#</a> Inclusive cache and Exclusive cache</h2><p>In an <strong>inclusive cache model</strong>, where the same data can be present in both the L1 and L2 caches.</p><p>In an <strong>exclusive cache</strong>, data can be present in only one cache and an address cannot be found in both the L1 and L2 caches at the same time.</p><h2 id="cache-policies" tabindex="-1"><a class="header-anchor" href="#cache-policies" aria-hidden="true">#</a> Cache policies</h2><p>The cache policies enable us to describe when a line should be allocated to the data cache and what should happen when a store instruction is executed that hits in the data cache.</p><h3 id="cache-allocation-policies" tabindex="-1"><a class="header-anchor" href="#cache-allocation-policies" aria-hidden="true">#</a> Cache allocation policies</h3><ul><li>Write allocation</li><li>Read allocation</li></ul><h3 id="cache-update-policies" tabindex="-1"><a class="header-anchor" href="#cache-update-policies" aria-hidden="true">#</a> Cache update policies</h3><ul><li>Write-back</li><li>Write-through</li></ul><h2 id="shareability-memory-attributes" tabindex="-1"><a class="header-anchor" href="#shareability-memory-attributes" aria-hidden="true">#</a> Shareability memory attributes</h2><p>Memory caching can be separately controlled through <em>inner</em> and <em>outer</em> attributes, for multiple levels of cache.</p><p>The shareable attribute is used to define <strong>whether a location is shared</strong><strong>with multiple cores</strong>.</p><p>Marking a region an <strong>Non-shareable</strong> means it is only used by thie core, whereas marking it as <strong>inner shareable</strong> or <strong>outer shareable</strong>, or both, means that the location is shared with other observers, for example, a GPU or DMA device might be considered another observer.</p><ul><li>Non-shareable</li></ul><p>This represents memory accessible only by a single processor or other agent, so memory accesses never need to be synchronized with other processors. This domain is not typically used in SMP systems.</p><ul><li>Inner shareable</li></ul><p>This represents a shareability domain that can be <strong>shared by multiple</strong><strong>processors</strong>, but not necessarily all of the agents in the system.</p><p>A system might have multiple Inner Shareable domains. An operation that affacts one Inner Shareable domain does not affect other Inner Shareable domains in the system.</p><ul><li>Outer shareable</li></ul><p>An outer shareable domain re-orderis shared by multiple agents and can consist of one or more inner shareable domains. An operation that affects an outer shareable domain also implicity affects all inner shareable domains inside it.</p><p>Howevert, it does not otherwise behave as an inner shareable operation.</p><ul><li>Full system</li></ul><p>An operation on the full system (SY) affects all observers in the system.</p><h2 id="cache-coherency" tabindex="-1"><a class="header-anchor" href="#cache-coherency" aria-hidden="true">#</a> Cache Coherency</h2><p>Cache introduce a number of potential problems, mainly because:</p><ul><li>Memory accesses can occur at times other than when the programmer would expect them</li><li>A data item can be held in multiple physical locations</li></ul><h3 id="mesi-protocol" tabindex="-1"><a class="header-anchor" href="#mesi-protocol" aria-hidden="true">#</a> MESI protocol</h3><p>Cache line can be marked with one of</p><ul><li>M(modified): present only in the current cache, and is dirty.</li><li>E(exclusive): present only in the current cache, but is clean.</li><li>S(shared): indicates that this cache line may be stored in other caches of the machine and is clean.</li><li>I(invalid): indicates that this cache line is invalid.</li></ul><h2 id="tlb" tabindex="-1"><a class="header-anchor" href="#tlb" aria-hidden="true">#</a> TLB</h2><h3 id="asid-and-vmid" tabindex="-1"><a class="header-anchor" href="#asid-and-vmid" aria-hidden="true">#</a> ASID and VMID</h3><p>To reduce the need for TLB maintanance on context switches, the lookups from some translation regimes can be associated with an ASID, or with an ASID and a VMID.</p><h4 id="asid" tabindex="-1"><a class="header-anchor" href="#asid" aria-hidden="true">#</a> ASID</h4><p>For stage 1 of a translation regime that can support two VA ranges the VMSA can distinguish between Global pages and Process-specific pages. The ASID identifies pages associated with a specific process and provides a mechanism for changing process-specific tables without having to maintain the TLB structures.</p><p>In Linux, asid has type <code>u64</code>. The highest bits[63:asid_bits] is generation number, [asid_bits:0] is asid number which managed by a bitmap.</p><p>If bits of bitmap are used up, Linux will increment generation and clear the bitmap.</p><p>For stage 1 translations, each of <code>TTBR0_ELx</code> and <code>TTBR1_ELx</code> has a valid ASID field, and <code>TCR_ELx</code>.A1 determines which of these holds the current ASID.</p><p>The significant 16 bits are used to store an ASID.</p><h5 id="init-bitmap" tabindex="-1"><a class="header-anchor" href="#init-bitmap" aria-hidden="true">#</a> init bitmap</h5><p>bits of ASID is 8 or 16. Linux uses bitmap to manage ASID allocation.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">asids_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        asid_bits <span class="token operator">=</span> <span class="token function">get_cpu_asid_bits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
         * Expect allocation after rollover to fail if we don&#39;t have at least
         * one more ASID than CPUs. ASID #0 is reserved for init_mm.
         */</span>
        <span class="token function">WARN_ON</span><span class="token punctuation">(</span>NUM_USER_ASIDS <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">&lt;=</span> <span class="token function">num_possible_cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">atomic64_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>asid_generation<span class="token punctuation">,</span> ASID_FIRST_VERSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
        asid_map <span class="token operator">=</span> <span class="token function">kcalloc</span><span class="token punctuation">(</span><span class="token function">BITS_TO_LONGS</span><span class="token punctuation">(</span>NUM_USER_ASIDS<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>asid_map<span class="token punctuation">)</span><span class="token punctuation">,</span>
                           GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>asid_map<span class="token punctuation">)</span>
                <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to allocate bitmap for %lu ASIDs\n&quot;</span><span class="token punctuation">,</span>
                      NUM_USER_ASIDS<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">&quot;ASID allocator initialised with %lu entries\n&quot;</span><span class="token punctuation">,</span> NUM_USER_ASIDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">early_initcall</span><span class="token punctuation">(</span>asids_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h5 id="allocate-context-for-task" tabindex="-1"><a class="header-anchor" href="#allocate-context-for-task" aria-hidden="true">#</a> Allocate context for task</h5><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> u64 <span class="token function">new_context</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mm_struct</span> <span class="token operator">*</span>mm<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">static</span> u32 cur_idx <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        u64 asid <span class="token operator">=</span> <span class="token function">atomic64_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mm<span class="token operator">-&gt;</span>context<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        u64 generation <span class="token operator">=</span> <span class="token function">atomic64_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>asid_generation<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>asid <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                u64 newasid <span class="token operator">=</span> generation <span class="token operator">|</span> <span class="token punctuation">(</span>asid <span class="token operator">&amp;</span> <span class="token operator">~</span>ASID_MASK<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">/*
                 * If our current ASID was active during a rollover, we
                 * can continue to use it and this was just a false alarm.
                 */</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">check_update_reserved_asid</span><span class="token punctuation">(</span>asid<span class="token punctuation">,</span> newasid<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span> newasid<span class="token punctuation">;</span>

                <span class="token comment">/*
                 * We had a valid ASID in a previous life, so try to re-use
                 * it if possible.
                 */</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">__test_and_set_bit</span><span class="token punctuation">(</span><span class="token function">asid2idx</span><span class="token punctuation">(</span>asid<span class="token punctuation">)</span><span class="token punctuation">,</span> asid_map<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span> newasid<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/*
         * Allocate a free ASID. If we can&#39;t find one, take a note of the
         * currently active ASIDs and mark the TLBs as requiring flushes.  We
         * always count from ASID #2 (index 1), as we use ASID #0 when setting
         * a reserved TTBR0 for the init_mm and we allocate ASIDs in even/odd
         * pairs.
         */</span>
        asid <span class="token operator">=</span> <span class="token function">find_next_zero_bit</span><span class="token punctuation">(</span>asid_map<span class="token punctuation">,</span> NUM_USER_ASIDS<span class="token punctuation">,</span> cur_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>asid <span class="token operator">!=</span> NUM_USER_ASIDS<span class="token punctuation">)</span>
                <span class="token keyword">goto</span> set_asid<span class="token punctuation">;</span>

        <span class="token comment">/* We&#39;re out of ASIDs, so increment the global generation count */</span>
        generation <span class="token operator">=</span> <span class="token function">atomic64_add_return_relaxed</span><span class="token punctuation">(</span>ASID_FIRST_VERSION<span class="token punctuation">,</span>
                                                 <span class="token operator">&amp;</span>asid_generation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">flush_context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* We have more ASIDs than CPUs, so this will always succeed */</span>
        asid <span class="token operator">=</span> <span class="token function">find_next_zero_bit</span><span class="token punctuation">(</span>asid_map<span class="token punctuation">,</span> NUM_USER_ASIDS<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

set_asid<span class="token operator">:</span>
        <span class="token function">__set_bit</span><span class="token punctuation">(</span>asid<span class="token punctuation">,</span> asid_map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cur_idx <span class="token operator">=</span> asid<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">idx2asid</span><span class="token punctuation">(</span>asid<span class="token punctuation">)</span> <span class="token operator">|</span> generation<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><h5 id="switch-asid" tabindex="-1"><a class="header-anchor" href="#switch-asid" aria-hidden="true">#</a> switch asid</h5><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">check_and_switch_context</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mm_struct</span> <span class="token operator">*</span>mm<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cpu<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span>
        u64 asid<span class="token punctuation">,</span> old_active_asid<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">system_supports_cnp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token function">cpu_set_reserved_ttbr0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        asid <span class="token operator">=</span> <span class="token function">atomic64_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mm<span class="token operator">-&gt;</span>context<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
         * The memory ordering here is subtle.
         * If our active_asids is non-zero and the ASID matches the current
         * generation, then we update the active_asids entry with a relaxed
         * cmpxchg. Racing with a concurrent rollover means that either:
         *
         * - We get a zero back from the cmpxchg and end up waiting on the
         *   lock. Taking the lock synchronises with the rollover and so
         *   we are forced to see the updated generation.
         *
         * - We get a valid ASID back from the cmpxchg, which means the
         *   relaxed xchg in flush_context will treat us as reserved
         *   because atomic RmWs are totally ordered for a given location.
         */</span>
        old_active_asid <span class="token operator">=</span> <span class="token function">atomic64_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token function">per_cpu</span><span class="token punctuation">(</span>active_asids<span class="token punctuation">,</span> cpu<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>old_active_asid <span class="token operator">&amp;&amp;</span>
            <span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span>asid <span class="token operator">^</span> <span class="token function">atomic64_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>asid_generation<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> asid_bits<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token function">atomic64_cmpxchg_relaxed</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token function">per_cpu</span><span class="token punctuation">(</span>active_asids<span class="token punctuation">,</span> cpu<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                     old_active_asid<span class="token punctuation">,</span> asid<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">goto</span> switch_mm_fastpath<span class="token punctuation">;</span>

        <span class="token function">raw_spin_lock_irqsave</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cpu_asid_lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* Check that our ASID belongs to the current generation. */</span>
        asid <span class="token operator">=</span> <span class="token function">atomic64_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mm<span class="token operator">-&gt;</span>context<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// the generation of the asid is not matched with global generation,</span>
	<span class="token comment">// we generate a new asid</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>asid <span class="token operator">^</span> <span class="token function">atomic64_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>asid_generation<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> asid_bits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                asid <span class="token operator">=</span> <span class="token function">new_context</span><span class="token punctuation">(</span>mm<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">atomic64_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mm<span class="token operator">-&gt;</span>context<span class="token punctuation">.</span>id<span class="token punctuation">,</span> asid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// invalidate TLB for current CPU</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">cpumask_test_and_clear_cpu</span><span class="token punctuation">(</span>cpu<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tlb_flush_pending<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token function">local_flush_tlb_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">atomic64_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token function">per_cpu</span><span class="token punctuation">(</span>active_asids<span class="token punctuation">,</span> cpu<span class="token punctuation">)</span><span class="token punctuation">,</span> asid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">raw_spin_unlock_irqrestore</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cpu_asid_lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

switch_mm_fastpath<span class="token operator">:</span>

        <span class="token function">arm64_apply_bp_hardening</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
         * Defer TTBR0_EL1 setting for user threads to uaccess_enable() when
         * emulating PAN.
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">system_uses_ttbr0_pan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token function">cpu_switch_mm</span><span class="token punctuation">(</span>mm<span class="token operator">-&gt;</span>pgd<span class="token punctuation">,</span> mm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><h4 id="vmid" tabindex="-1"><a class="header-anchor" href="#vmid" aria-hidden="true">#</a> VMID</h4><p>When EL2 is enabled, the VMID identifies the current virtual machine, with its own independent ASID space.</p><h2 id="conceptual-points" tabindex="-1"><a class="header-anchor" href="#conceptual-points" aria-hidden="true">#</a> Conceptual points</h2><ul><li>Point of Unification (PoU)</li><li>Point of Coherency (PoC)</li><li>Point of Persistence (PoP)</li><li>Point of Persistence (PoDP)</li></ul><h2 id="cache-maintenance" tabindex="-1"><a class="header-anchor" href="#cache-maintenance" aria-hidden="true">#</a> Cache maintenance</h2><ul><li><p>Clean: causes the contents of the cache line to be writtern back to memory, but only if the cache line is &#39;dirty&#39;</p></li><li><p>invalidate: simply marks a cache line as &#39;invalid&#39;, meaning you won&#39;t hit upon</p></li><li><p>Cache clean by virtual address, <code>DC CVAC</code>, <code>DC CVAP</code>, and <code>DC CVAU</code></p></li><li><p>Cache invalidate by virtual address, <code>DC IVAC</code></p></li><li><p>Cache clean and invalidate by virtual address, <code>DC CIVAC</code></p></li></ul><h3 id="flush-icache" tabindex="-1"><a class="header-anchor" href="#flush-icache" aria-hidden="true">#</a> flush icache</h3><p><code>__flush_icache_range</code> and <code>__flush_cache_user_range</code> are used to flush icache.</p><h3 id="flush-dcache" tabindex="-1"><a class="header-anchor" href="#flush-dcache" aria-hidden="true">#</a> flush dcache</h3><p><code>__flush_dcache_area</code> clean and invalidate cache (kaddr, size).</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/*
 *      __flush_dcache_area(kaddr, size)
 *
 *      Ensure that any D-cache lines for the interval [kaddr, kaddr+size)
 *      are cleaned and invalidated to the PoC.
 *
 *      - kaddr   - kernel address
 *      - size    - size in question
 */</span>
<span class="token function">ENTRY</span><span class="token punctuation">(</span>__flush_dcache_area<span class="token punctuation">)</span>
        dcache_by_line_op civac<span class="token punctuation">,</span> sy<span class="token punctuation">,</span> x0<span class="token punctuation">,</span> x1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> x3
        ret
<span class="token function">ENDPIPROC</span><span class="token punctuation">(</span>__flush_dcache_area<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">7/21/2021, 6:55:34 AM</span></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: zhangjunyu.92@bytedance.com">Zhang Junyu</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"> ← <a href="/vue_notebook/kernel/memory/memory_order.html" class="nav-link" aria-label="Memory Ordering"><!--[--><!--]--> Memory Ordering <!--[--><!--]--></a></span><span class="next"><a href="/vue_notebook/kernel/memory/memory_tagging_extension.html" class="nav-link" aria-label="Memory Tagging Extension"><!--[--><!--]--> Memory Tagging Extension <!--[--><!--]--></a> → </span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script src="/vue_notebook/assets/js/runtime~app.47f1fcf0.js" defer></script><script src="/vue_notebook/assets/js/1812.154fe714.js" defer></script><script src="/vue_notebook/assets/js/app.1f287e75.js" defer></script>
  </body>
</html>
