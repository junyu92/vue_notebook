"use strict";(self.webpackChunknotebook=self.webpackChunknotebook||[]).push([[9397],{8449:(n,s,a)=>{a.r(s),a.d(s,{data:()=>e});const e={key:"v-90a713c6",path:"/kernel/interrupt/gic.html",title:"GIC",lang:"en-US",frontmatter:{},excerpt:"",headers:[{level:2,title:"Registers",slug:"registers",children:[{level:3,title:"Distributor (GICD_*)",slug:"distributor-gicd",children:[]},{level:3,title:"Redistributors (GICR_*)",slug:"redistributors-gicr",children:[]},{level:3,title:"CPU interfaces (ICC_*_ELn)",slug:"cpu-interfaces-icc-eln",children:[]}]},{level:2,title:"Lift cycle of an interrupt",slug:"lift-cycle-of-an-interrupt",children:[{level:3,title:"Level-sensitive interrupts",slug:"level-sensitive-interrupts",children:[]},{level:3,title:"Edge-sensitive interrupts",slug:"edge-sensitive-interrupts",children:[]},{level:3,title:"End of interrupt",slug:"end-of-interrupt",children:[]}]},{level:2,title:"Affinity",slug:"affinity",children:[]},{level:2,title:"Interrupt prioritization",slug:"interrupt-prioritization",children:[{level:3,title:"Preemption",slug:"preemption",children:[]}]},{level:2,title:"Virtualization (GIC part)",slug:"virtualization-gic-part",children:[{level:3,title:"GICv4(.1)",slug:"gicv4-1",children:[]},{level:3,title:"Direct injection of virtual interrupts (GICv4)",slug:"direct-injection-of-virtual-interrupts-gicv4",children:[]},{level:3,title:"Direct injection of virtual Software Generated Interrupts (SGIs)",slug:"direct-injection-of-virtual-software-generated-interrupts-sgis",children:[]}]},{level:2,title:"Virtualization (KVM part)",slug:"virtualization-kvm-part",children:[{level:3,title:"Forward an interrupt (Direct Injection)",slug:"forward-an-interrupt-direct-injection",children:[]}]}],filePathRelative:"kernel/interrupt/gic.md",git:{updatedTime:162997446e4,contributors:[{name:"Zhang Junyu",email:"zhangjunyu.92@bytedance.com",commits:9},{name:"Zhang Junyu",email:"junyu92@163.com",commits:1}]}}},7602:(n,s,a)=>{a.r(s),a.d(s,{default:()=>ks});var e=a(6252),t=a(8246);const o=(0,e._)("h1",{id:"gic",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#gic","aria-hidden":"true"},"#"),(0,e.Uk)(" GIC")],-1),l={class:"table-of-contents"},c=(0,e.Uk)("Registers"),p=(0,e.Uk)("Distributor (GICD_*)"),r=(0,e.Uk)("Redistributors (GICR_*)"),i=(0,e.Uk)("CPU interfaces (ICC_*_ELn)"),_=(0,e.Uk)("Lift cycle of an interrupt"),u=(0,e.Uk)("Level-sensitive interrupts"),k=(0,e.Uk)("Edge-sensitive interrupts"),b=(0,e.Uk)("End of interrupt"),U=(0,e.Uk)("Affinity"),d=(0,e.Uk)("Interrupt prioritization"),m=(0,e.Uk)("Preemption"),v=(0,e.Uk)("Virtualization (GIC part)"),h=(0,e.Uk)("GICv4(.1)"),f=(0,e.Uk)("Direct injection of virtual interrupts (GICv4)"),g=(0,e.Uk)("Direct injection of virtual Software Generated Interrupts (SGIs)"),y=(0,e.Uk)("Virtualization (KVM part)"),w=(0,e.Uk)("Forward an interrupt (Direct Injection)"),I=(0,e._)("h2",{id:"registers",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#registers","aria-hidden":"true"},"#"),(0,e.Uk)(" Registers")],-1),E=(0,e._)("h3",{id:"distributor-gicd",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#distributor-gicd","aria-hidden":"true"},"#"),(0,e.Uk)(" Distributor (GICD_*)")],-1),P=(0,e._)("h3",{id:"redistributors-gicr",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#redistributors-gicr","aria-hidden":"true"},"#"),(0,e.Uk)(" Redistributors (GICR_*)")],-1),D=(0,e._)("h3",{id:"cpu-interfaces-icc-eln",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#cpu-interfaces-icc-eln","aria-hidden":"true"},"#"),(0,e.Uk)(" CPU interfaces (ICC_*_ELn)")],-1),R=(0,e._)("h2",{id:"lift-cycle-of-an-interrupt",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#lift-cycle-of-an-interrupt","aria-hidden":"true"},"#"),(0,e.Uk)(" Lift cycle of an interrupt")],-1),T=(0,e._)("h3",{id:"level-sensitive-interrupts",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#level-sensitive-interrupts","aria-hidden":"true"},"#"),(0,e.Uk)(" Level-sensitive interrupts")],-1),q=(0,e._)("p",null,[(0,e.Uk)("For level-sensitive interrupts, a rising edge on the interrupt input causes the interrupt to become pending, and the interrupt is held asserted "),(0,e._)("strong",null,"until the peripheral de-asserts the interrupt signal"),(0,e.Uk)(".")],-1),C=(0,e._)("div",{class:"language-text ext-text line-numbers-mode"},[(0,e._)("pre",{class:"language-text"},[(0,e._)("code",null,"+-> Inactive\n|     |\n|     | interrupt source is asserted\n|     V\n|   Pending\n|     |\n|     | ack the irq by reading IAR\n|     V\n|   Active and Pending\n|     |\n|     | peripheral de-asserts the interrupt signal.\n|     | software writing to a status register in the periphsral.\n|     V\n|   Active\n|     |\n|     | writing to EOIR\n+-----+\n")]),(0,e._)("div",{class:"line-numbers"},[(0,e._)("span",{class:"line-number"},"1"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"2"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"3"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"4"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"5"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"6"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"7"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"8"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"9"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"10"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"11"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"12"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"13"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"14"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"15"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"16"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"17"),(0,e._)("br")])],-1),x=(0,e._)("h3",{id:"edge-sensitive-interrupts",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#edge-sensitive-interrupts","aria-hidden":"true"},"#"),(0,e.Uk)(" Edge-sensitive interrupts")],-1),G=(0,e._)("p",null,[(0,e.Uk)("For edge-sensitive interrupts, a rising edge on the interrupt input causes the interrupt to become pending, "),(0,e._)("strong",null,"but the interrupt is not held asserted"),(0,e.Uk)(".")],-1),V=(0,e._)("div",{class:"language-text ext-text line-numbers-mode"},[(0,e._)("pre",{class:"language-text"},[(0,e._)("code",null,"    Inactive\n      |\n      | interrupt source is asserted\n      V\n+-> Pending\n|     |\n|     | ack the irq by reading IAR\n|     V\n|   Active\n|     |\n|     | (Option) peripheral re-asserts the interrupt signal.\n|     V\n|   (Option) Active and pending\n|     |\n|     | writing to EOIR and GIC re-asserts the interrupt signal\n+-----+\n")]),(0,e._)("div",{class:"line-numbers"},[(0,e._)("span",{class:"line-number"},"1"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"2"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"3"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"4"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"5"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"6"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"7"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"8"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"9"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"10"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"11"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"12"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"13"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"14"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"15"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"16"),(0,e._)("br")])],-1),A=(0,e._)("h3",{id:"end-of-interrupt",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#end-of-interrupt","aria-hidden":"true"},"#"),(0,e.Uk)(" End of interrupt")],-1),N=(0,e._)("p",null,"Once the interrupt has been handled, software must inform the interrupt controller that the interrupt has been handled, so that the state machine can transition to the next state.",-1),L=(0,e._)("p",null,[(0,e._)("strong",null,"GICv3 treats this as two tasks")],-1),S=(0,e._)("ul",null,[(0,e._)("li",null,"Priority drop"),(0,e._)("li",null,"Deactivation")],-1),j=(0,e._)("p",null,[(0,e.Uk)("In the GICv3 architecture, priority drop and deactivation can happen together or separately. This is determined by the settings of "),(0,e._)("code",null,"ICC_CTLR_ELn.EOImode"),(0,e.Uk)(":")],-1),M=(0,e._)("ul",null,[(0,e._)("li",null,[(0,e.Uk)("EOImode == 0: A write to "),(0,e._)("code",null,"ICC_EOIR0_EL1"),(0,e.Uk)(" for Group 0 interrupts, or "),(0,e._)("code",null,"ICC_EOIR1_EL1"),(0,e.Uk)(" for Group 1 interrupts, performs both the priority drop and deactivation.")]),(0,e._)("li",null,[(0,e.Uk)("EOImode == 1: A write to "),(0,e._)("code",null,"ICC_EOIR0_EL1"),(0,e.Uk)(" for Group interrupts, or "),(0,e._)("code",null,"ICC_EOIR1_EL1"),(0,e.Uk)(" for Group 1 interrupts results in a priority drop. A seperate write to "),(0,e._)("code",null,"ICC_DIR_EL1"),(0,e.Uk)(" is required for deactivation. This mode is often used for virtualization purposes.")])],-1),O=(0,e._)("h2",{id:"affinity",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#affinity","aria-hidden":"true"},"#"),(0,e.Uk)(" Affinity")],-1),z=(0,e._)("p",null,[(0,e.Uk)("GICv3 uses affinity routing to identify connected PEs and to route interrupts to "),(0,e._)("strong",null,"a specific PE or group of PEs"),(0,e.Uk)(".")],-1),W=(0,e._)("p",null,"An affinity is a 32-bit value that is split into four fields:",-1),B=(0,e._)("div",{class:"language-text ext-text line-numbers-mode"},[(0,e._)("pre",{class:"language-text"},[(0,e._)("code",null,"<affinity level 3>.<affinity level 2>.<affinity level 1>.<affinity level 0>\n")]),(0,e._)("div",{class:"line-numbers"},[(0,e._)("span",{class:"line-number"},"1"),(0,e._)("br")])],-1),F=(0,e._)("p",null,"At affinity level 0 there is a Redistributor.",-1),Y=(0,e._)("p",null,[(0,e.Uk)("The affinity of a PE is reported in "),(0,e._)("code",null,"MPIDR_EL1"),(0,e.Uk)(".")],-1),H=(0,e._)("div",{class:"language-c ext-c line-numbers-mode"},[(0,e._)("pre",{class:"language-c"},[(0,e._)("code",null,[(0,e._)("span",{class:"token keyword"},"static"),(0,e.Uk)(" u64 "),(0,e._)("span",{class:"token function"},"gic_mpidr_to_affinity"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token keyword"},"unsigned"),(0,e.Uk)(),(0,e._)("span",{class:"token keyword"},"long"),(0,e.Uk)(" mpidr"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n"),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n        u64 aff"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        aff "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("u64"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token function"},"MPIDR_AFFINITY_LEVEL"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("mpidr"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e._)("span",{class:"token number"},"3"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"<<"),(0,e.Uk)(),(0,e._)("span",{class:"token number"},"32"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"|"),(0,e.Uk)("\n               "),(0,e._)("span",{class:"token function"},"MPIDR_AFFINITY_LEVEL"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("mpidr"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e._)("span",{class:"token number"},"2"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"<<"),(0,e.Uk)(),(0,e._)("span",{class:"token number"},"16"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"|"),(0,e.Uk)("\n               "),(0,e._)("span",{class:"token function"},"MPIDR_AFFINITY_LEVEL"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("mpidr"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e._)("span",{class:"token number"},"1"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"<<"),(0,e.Uk)(),(0,e._)("span",{class:"token number"},"8"),(0,e.Uk)("  "),(0,e._)("span",{class:"token operator"},"|"),(0,e.Uk)("\n               "),(0,e._)("span",{class:"token function"},"MPIDR_AFFINITY_LEVEL"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("mpidr"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e._)("span",{class:"token number"},"0"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        "),(0,e._)("span",{class:"token keyword"},"return"),(0,e.Uk)(" aff"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n"),(0,e._)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n")])]),(0,e._)("div",{class:"line-numbers"},[(0,e._)("span",{class:"line-number"},"1"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"2"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"3"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"4"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"5"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"6"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"7"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"8"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"9"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"10"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"11"),(0,e._)("br")])],-1),K=(0,e._)("p",null,[(0,e.Uk)("Router information stored in "),(0,e._)("code",null,"GICD_IROUTER"),(0,e.Uk)(" register.")],-1),Q=(0,e._)("p",null,[(0,e.Uk)("The SPI can be delivered to any connected PE that is participating in distribution of the interrupt group when "),(0,e._)("code",null,"GICD_IROUTERn.Interrupt_Routing_Mode == 1"),(0,e.Uk)(".")],-1),Z=(0,e._)("p",null,"The Distributor, rather than software, selects the target PE. The target can therefore vary each time the interrupt is signaled. This type of routing is referred to as 1-of-N.",-1),J=(0,e._)("div",{class:"language-c ext-c line-numbers-mode"},[(0,e._)("pre",{class:"language-c"},[(0,e._)("code",null,[(0,e._)("span",{class:"token function"},"gic_write_irouter"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("affinity"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" base "),(0,e._)("span",{class:"token operator"},"+"),(0,e.Uk)(" GICD_IROUTER "),(0,e._)("span",{class:"token operator"},"+"),(0,e.Uk)(" irqnr "),(0,e._)("span",{class:"token operator"},"*"),(0,e.Uk)(),(0,e._)("span",{class:"token number"},"8"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n")])]),(0,e._)("div",{class:"line-numbers"},[(0,e._)("span",{class:"line-number"},"1"),(0,e._)("br")])],-1),X=(0,e._)("h2",{id:"interrupt-prioritization",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#interrupt-prioritization","aria-hidden":"true"},"#"),(0,e.Uk)(" Interrupt prioritization")],-1),$=(0,e._)("p",null,"The Priority Mask register sets the minimum priority that an interrupt must have to be forwarded to the PE.",-1),nn=(0,e._)("p",null,"When a PE acknowledges an interrupt, its running priority becomes the same as the priority of the interrupt. The running priority returns to its former value when the PE writes to one of the End of Interrupt(EOI) registers.",-1),sn=(0,e._)("p",null,"Prioritization describes the",-1),an=(0,e._)("ul",null,[(0,e._)("li",null,"Configuration and control of interrupt priority"),(0,e._)("li",null,"Order of execution of pending interrupts"),(0,e._)("li",null,[(0,e.Uk)("Determination of when interrupts are visible to a target PE, including "),(0,e._)("ul",null,[(0,e._)("li",null,"Interrupt priority masking"),(0,e._)("li",null,"Priority grouping"),(0,e._)("li",null,"Preemption of an active interrupt")])])],-1),en=(0,e._)("p",null,"Priority values are an 8-bit unsigned binary number. 0x00 is the highest possible priority, and 0xFF is the lowest possible priority",-1),tn=(0,e._)("div",{class:"language-c ext-c line-numbers-mode"},[(0,e._)("pre",{class:"language-c"},[(0,e._)("code",null,[(0,e._)("span",{class:"token keyword"},"static"),(0,e.Uk)(),(0,e._)("span",{class:"token keyword"},"void"),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"gic_irq_set_prio"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"irq_data"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"*"),(0,e.Uk)("d"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" u8 prio"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n"),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"void"),(0,e.Uk)(" __iomem "),(0,e._)("span",{class:"token operator"},"*"),(0,e.Uk)("base "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"gic_dist_base"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("d"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        u32 offset"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" index"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        offset "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"convert_offset_index"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("d"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" GICD_IPRIORITYR"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"&"),(0,e.Uk)("index"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        "),(0,e._)("span",{class:"token function"},"writeb_relaxed"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("prio"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" base "),(0,e._)("span",{class:"token operator"},"+"),(0,e.Uk)(" offset "),(0,e._)("span",{class:"token operator"},"+"),(0,e.Uk)(" index"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n"),(0,e._)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n")])]),(0,e._)("div",{class:"line-numbers"},[(0,e._)("span",{class:"line-number"},"1"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"2"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"3"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"4"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"5"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"6"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"7"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"8"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"9"),(0,e._)("br")])],-1),on=(0,e._)("h3",{id:"preemption",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#preemption","aria-hidden":"true"},"#"),(0,e.Uk)(" Preemption")],-1),ln=(0,e._)("p",null,"A CPU interface supports signaling of higher priority pending interrupts to a target PE before an active interrupt completes.",-1),cn=(0,e._)("p",null,"A pending interrupt is only signaled if both:",-1),pn=(0,e._)("ul",null,[(0,e._)("li",null,"Its priority is higher than the priority mask for that CPU interface"),(0,e._)("li",null,"Its group prioirty is higher than of the running priority on the CPU interface")],-1),rn=(0,e._)("p",null,[(0,e._)("img",{src:t,alt:"Preemption"})],-1),_n=(0,e._)("p",null,[(0,e.Uk)("The Arm CoreLink GICv3 architecture allows software to control preemption by specifying the difference in priority required for preemption to occur. This is controlled through the Binary Point registers: "),(0,e._)("code",null,"ICC_BPRn_EL1"),(0,e.Uk)(".")],-1),un=(0,e._)("h2",{id:"virtualization-gic-part",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#virtualization-gic-part","aria-hidden":"true"},"#"),(0,e.Uk)(" Virtualization (GIC part)")],-1),kn=(0,e._)("h3",{id:"gicv4-1",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#gicv4-1","aria-hidden":"true"},"#"),(0,e.Uk)(" GICv4(.1)")],-1),bn=(0,e._)("p",null,[(0,e.Uk)("GICv4 supports direct injection of vLPIs. With this feature, physical events "),(0,e._)("code",null,"(EventID, DeviceID)"),(0,e.Uk)(" can be mapped to virtual interrupts.")],-1),Un=(0,e._)("p",null,[(0,e._)("strong",null,"If the vPE targeted by interrupt is running, the virtual interrupt can be"),(0,e._)("strong",null,"forwarded without the need to first enter the hypervisor.")],-1),dn=(0,e._)("h4",{id:"registers-1",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#registers-1","aria-hidden":"true"},"#"),(0,e.Uk)(" Registers")],-1),mn=(0,e._)("p",null,"The redistributors have two extra registers to support direct injection.",-1),vn=(0,e._)("ul",null,[(0,e._)("li",null,[(0,e._)("p",null,[(0,e._)("code",null,"GICR_VPROPBASER"),(0,e.Uk)(": the address of the virtual LPI Configuration table. The configuration of vLPIs is global to all vPEs in the same VM.")])]),(0,e._)("li",null,[(0,e._)("p",null,[(0,e._)("code",null,"GICR_VPENDBASER"),(0,e.Uk)(": the address of virtual LPI Pending table. As with the physical LPI Pending table, the VPT records the pending state of the vLPIs. "),(0,e._)("strong",null,"Each vPE has its own private VPT"),(0,e.Uk)(".")])])],-1),hn=(0,e._)("h4",{id:"vpe-and-resident-a-vpe",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#vpe-and-resident-a-vpe","aria-hidden":"true"},"#"),(0,e.Uk)(" vPE and resident a vPE")],-1),fn=(0,e._)("p",null,"Multiple vPEs might be hosted by a single physical PE, with the hypervisor context switching between them. The currently running vPE is referred to to as being scheduled.",-1),gn=(0,e._)("p",null,[(0,e.Uk)("Invoke "),(0,e._)("code",null,"its_make_vpe_resident"),(0,e.Uk)(" to schedule a vPE. More details are provided in the following section.")],-1),yn=(0,e._)("p",null,"Virtual interrupts for the scheduled vPE can be directly injected. If the target vPE is not scheduled, the virtual interrupt is recorded as being pending in the appropriate VPT.",-1),wn=(0,e._)("h4",{id:"virtual-lpi-pending-table-vpt",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#virtual-lpi-pending-table-vpt","aria-hidden":"true"},"#"),(0,e.Uk)(" virtual LPI Pending table (VPT)")],-1),In=(0,e._)("p",null,[(0,e._)("code",null,"GICR_VPENDBASER"),(0,e.Uk)(" bits[51:16] contains the physical address of the virtual LPI Pending table.")],-1),En=(0,e._)("div",{class:"language-c ext-c line-numbers-mode"},[(0,e._)("pre",{class:"language-c"},[(0,e._)("code",null,[(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"its_vpe"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"page"),(0,e.Uk)("             "),(0,e._)("span",{class:"token operator"},"*"),(0,e.Uk)("vpt_page"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token comment"},"// ..."),(0,e.Uk)("\n"),(0,e._)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n")])]),(0,e._)("div",{class:"line-numbers"},[(0,e._)("span",{class:"line-number"},"1"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"2"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"3"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"4"),(0,e._)("br")])],-1),Pn=(0,e._)("h4",{id:"its-commands-for-direct-injetion",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#its-commands-for-direct-injetion","aria-hidden":"true"},"#"),(0,e.Uk)(" ITS commands for direct injetion")],-1),Dn=(0,e._)("ol",null,[(0,e._)("li",null,[(0,e.Uk)("Mapingp a tuple "),(0,e._)("code",null,"(EventID, DeviceID)"),(0,e.Uk)(" to "),(0,e._)("code",null,"vINTID"),(0,e.Uk)(" for a specific vPE")])],-1),Rn=(0,e._)("p",null,[(0,e.Uk)("Two command can be used to map "),(0,e._)("code",null,"(EventID, DeviceID)"),(0,e.Uk)(" to a "),(0,e._)("code",null,"vINTID"),(0,e.Uk)(" and "),(0,e._)("code",null,"vPE"),(0,e.Uk)(".")],-1),Tn=(0,e._)("ul",null,[(0,e._)("li",null,[(0,e.Uk)("The "),(0,e._)("code",null,"VMAPI"),(0,e.Uk)(" command is used when the EventID and vINTID are the same "),(0,e._)("code",null,"VMAPI <DeviceID>, <EventID>, <Doorbell pINTID>, <vPE ID>")]),(0,e._)("li",null,[(0,e.Uk)("The "),(0,e._)("code",null,"VMAPTI"),(0,e.Uk)(" command is used then the EventID and vINTID are different "),(0,e._)("code",null,"VMAPTI <DeviceID>, <EventID>, <vINTID>, <pINTID>, <vPE ID>")])],-1),qn=(0,e._)("p",null,[(0,e.Uk)("The ITS must be aware of which physical PE a vPE will be scheduled on when it is running. The "),(0,e._)("code",null,"VMAPP"),(0,e.Uk)(" maps a vPE to a physical redistributor.")],-1),Cn=(0,e._)("p",null,[(0,e._)("code",null,"VMAPP <vPE ID>, <RDADDR>, <VPT>, <VPT size>")],-1),xn=(0,e._)("ul",null,[(0,e._)("li",null,[(0,e._)("code",null,"<RDADDR>"),(0,e.Uk)(" is the target redistributor.")])],-1),Gn=(0,e._)("ol",{start:"2"},[(0,e._)("li",null,"Mapping a vPE to a physical Redistributor")],-1),Vn=(0,e._)("p",null,[(0,e.Uk)("If a hypervisor maps a vPE to a different physical PE, the ITS mappings must be updated so that virtual interrupts are sent to the correct physical PE. The ITS mappings are updated using the "),(0,e._)("code",null,"VMOVP"),(0,e.Uk)(" command, followed by "),(0,e._)("code",null,"VSYNC"),(0,e.Uk)(" to synchronize the context.")],-1),An=(0,e._)("div",{class:"language-c ext-c line-numbers-mode"},[(0,e._)("pre",{class:"language-c"},[(0,e._)("code",null,[(0,e._)("span",{class:"token keyword"},"static"),(0,e.Uk)(),(0,e._)("span",{class:"token keyword"},"void"),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"its_send_vmovp"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"its_vpe"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"*"),(0,e.Uk)("vpe"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n")])]),(0,e._)("div",{class:"line-numbers"},[(0,e._)("span",{class:"line-number"},"1"),(0,e._)("br")])],-1),Nn=(0,e._)("h3",{id:"direct-injection-of-virtual-interrupts-gicv4",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#direct-injection-of-virtual-interrupts-gicv4","aria-hidden":"true"},"#"),(0,e.Uk)(" Direct injection of virtual interrupts (GICv4)")],-1),Ln=(0,e._)("p",null,[(0,e.Uk)("GICv4 adds support for the direct injection of virtual LPIs (vLPIs). This feature allows software to describe to the ITS how physical events "),(0,e._)("code",null,"(EventID, DeviceID)"),(0,e.Uk)(" map to "),(0,e._)("code",null,"virtual interrupts"),(0,e.Uk)(".")],-1),Sn=(0,e._)("p",null,"If the vPE targeted by interrupt is running, the virtual interrupt can be forwarded without the need to first enter the hypervisor. This can reduce the overhead associated with virtualized interrupts.",-1),jn=(0,e._)("h4",{id:"mapping-eventid-and-deviceid-to-virtual-interrupts",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#mapping-eventid-and-deviceid-to-virtual-interrupts","aria-hidden":"true"},"#"),(0,e.Uk)(" Mapping EventID and DeviceID to virtual interrupts")],-1),Mn=(0,e._)("p",null,[(0,e.Uk)("To map "),(0,e._)("code",null,"(EventID, DeviceID) -> virtual interrupt"),(0,e.Uk)(", "),(0,e._)("code",null,"its_map_vlpi"),(0,e.Uk)(" should be invoked.")],-1),On=(0,e._)("div",{class:"language-c ext-c line-numbers-mode"},[(0,e._)("pre",{class:"language-c"},[(0,e._)("code",null,[(0,e._)("span",{class:"token keyword"},"int"),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"its_map_vlpi"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token keyword"},"int"),(0,e.Uk)(" irq"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"its_vlpi_map"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"*"),(0,e.Uk)("map"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n"),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"its_cmd_info"),(0,e.Uk)(" info "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("cmd_type "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(" MAP_VLPI"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n                        "),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("map      "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(" map"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token punctuation"},"}"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token punctuation"},"}"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"int"),(0,e.Uk)(" ret"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        "),(0,e._)("span",{class:"token comment"},"/*\n         * The host will never see that interrupt firing again, so it\n         * is vital that we don't do any lazy masking.\n         */"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token function"},"irq_set_status_flags"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("irq"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" IRQ_DISABLE_UNLAZY"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        ret "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"irq_set_vcpu_affinity"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("irq"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"&"),(0,e.Uk)("info"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"if"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("ret"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token function"},"irq_clear_status_flags"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("irq"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" IRQ_DISABLE_UNLAZY"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        "),(0,e._)("span",{class:"token keyword"},"return"),(0,e.Uk)(" ret"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n"),(0,e._)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n")])]),(0,e._)("div",{class:"line-numbers"},[(0,e._)("span",{class:"line-number"},"1"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"2"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"3"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"4"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"5"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"6"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"7"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"8"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"9"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"10"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"11"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"12"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"13"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"14"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"15"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"16"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"17"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"18"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"19"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"20"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"21"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"22"),(0,e._)("br")])],-1),zn=(0,e._)("div",{class:"language-c ext-c line-numbers-mode"},[(0,e._)("pre",{class:"language-c"},[(0,e._)("code",null,[(0,e._)("span",{class:"token keyword"},"static"),(0,e.Uk)(),(0,e._)("span",{class:"token keyword"},"int"),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"its_vlpi_map"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"irq_data"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"*"),(0,e.Uk)("d"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"its_cmd_info"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"*"),(0,e.Uk)("info"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n"),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"its_device"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"*"),(0,e.Uk)("its_dev "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"irq_data_get_irq_chip_data"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("d"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        u32 event "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"its_get_event_id"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("d"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"int"),(0,e.Uk)(" ret "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token number"},"0"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        "),(0,e._)("span",{class:"token keyword"},"if"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token operator"},"!"),(0,e.Uk)("info"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("map"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token keyword"},"return"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"-"),(0,e.Uk)("EINVAL"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        "),(0,e._)("span",{class:"token function"},"mutex_lock"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token operator"},"&"),(0,e.Uk)("its_dev"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("event_map"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("vlpi_lock"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        "),(0,e._)("span",{class:"token keyword"},"if"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token operator"},"!"),(0,e.Uk)("its_dev"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("event_map"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("vm"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"its_vlpi_map"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"*"),(0,e.Uk)("maps"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n                maps "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"kcalloc"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("its_dev"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("event_map"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("nr_lpis"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e._)("span",{class:"token keyword"},"sizeof"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token operator"},"*"),(0,e.Uk)("maps"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)("\n                               GFP_KERNEL"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token keyword"},"if"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token operator"},"!"),(0,e.Uk)("maps"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n                        ret "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"-"),(0,e.Uk)("ENOMEM"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n                        "),(0,e._)("span",{class:"token keyword"},"goto"),(0,e.Uk)(" out"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n\n                its_dev"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("event_map"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("vm "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(" info"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("map"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("vm"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n                its_dev"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("event_map"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("vlpi_maps "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(" maps"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token punctuation"},"}"),(0,e.Uk)(),(0,e._)("span",{class:"token keyword"},"else"),(0,e.Uk)(),(0,e._)("span",{class:"token keyword"},"if"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("its_dev"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("event_map"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("vm "),(0,e._)("span",{class:"token operator"},"!="),(0,e.Uk)(" info"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("map"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("vm"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n                ret "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"-"),(0,e.Uk)("EINVAL"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token keyword"},"goto"),(0,e.Uk)(" out"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n\n        "),(0,e._)("span",{class:"token comment"},"/* Get our private copy of the mapping information */"),(0,e.Uk)("\n        its_dev"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("event_map"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("vlpi_maps"),(0,e._)("span",{class:"token punctuation"},"["),(0,e.Uk)("event"),(0,e._)("span",{class:"token punctuation"},"]"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"*"),(0,e.Uk)("info"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("map"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        "),(0,e._)("span",{class:"token keyword"},"if"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token function"},"irqd_is_forwarded_to_vcpu"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("d"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token comment"},"/* Already mapped, move it around */"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token function"},"its_send_vmovi"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("its_dev"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" event"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token punctuation"},"}"),(0,e.Uk)(),(0,e._)("span",{class:"token keyword"},"else"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token comment"},"/* Ensure all the VPEs are mapped on this ITS */"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token function"},"its_map_vm"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("its_dev"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("its"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" info"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("map"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("vm"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n                "),(0,e._)("span",{class:"token comment"},"/*\n                 * Flag the interrupt as forwarded so that we can\n                 * start poking the virtual property table.\n                 */"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token function"},"irqd_set_forwarded_to_vcpu"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("d"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n                "),(0,e._)("span",{class:"token comment"},"/* Write out the property to the prop table */"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token function"},"lpi_write_config"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("d"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e._)("span",{class:"token number"},"0xff"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" info"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("map"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("properties"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n                "),(0,e._)("span",{class:"token comment"},"/* Drop the physical mapping */"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token function"},"its_send_discard"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("its_dev"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" event"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n                "),(0,e._)("span",{class:"token comment"},"/* and install the virtual one */"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token function"},"its_send_vmapti"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("its_dev"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" event"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n                "),(0,e._)("span",{class:"token comment"},"/* Increment the number of VLPIs */"),(0,e.Uk)("\n                its_dev"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("event_map"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("nr_vlpis"),(0,e._)("span",{class:"token operator"},"++"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n\nout"),(0,e._)("span",{class:"token operator"},":"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token function"},"mutex_unlock"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token operator"},"&"),(0,e.Uk)("its_dev"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("event_map"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("vlpi_lock"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"return"),(0,e.Uk)(" ret"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n"),(0,e._)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n")])]),(0,e._)("div",{class:"line-numbers"},[(0,e._)("span",{class:"line-number"},"1"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"2"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"3"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"4"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"5"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"6"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"7"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"8"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"9"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"10"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"11"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"12"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"13"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"14"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"15"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"16"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"17"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"18"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"19"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"20"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"21"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"22"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"23"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"24"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"25"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"26"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"27"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"28"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"29"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"30"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"31"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"32"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"33"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"34"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"35"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"36"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"37"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"38"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"39"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"40"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"41"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"42"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"43"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"44"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"45"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"46"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"47"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"48"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"49"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"50"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"51"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"52"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"53"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"54"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"55"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"56"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"57"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"58"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"59"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"60"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"61"),(0,e._)("br")])],-1),Wn=(0,e._)("p",null,[(0,e.Uk)("The core function is "),(0,e._)("code",null,"its_send_vmapti"),(0,e.Uk)(".")],-1),Bn=(0,e._)("div",{class:"language-c ext-c line-numbers-mode"},[(0,e._)("pre",{class:"language-c"},[(0,e._)("code",null,[(0,e._)("span",{class:"token keyword"},"static"),(0,e.Uk)(),(0,e._)("span",{class:"token keyword"},"void"),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"its_send_vmapti"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"its_device"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"*"),(0,e.Uk)("dev"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" u32 id"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n"),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"its_vlpi_map"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"*"),(0,e.Uk)("map "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"&"),(0,e.Uk)("dev"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("event_map"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("vlpi_maps"),(0,e._)("span",{class:"token punctuation"},"["),(0,e.Uk)("id"),(0,e._)("span",{class:"token punctuation"},"]"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"its_cmd_desc"),(0,e.Uk)(" desc"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        desc"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("its_vmapti_cmd"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("vpe "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(" map"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("vpe"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        desc"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("its_vmapti_cmd"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("dev "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(" dev"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        desc"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("its_vmapti_cmd"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("virt_id "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(" map"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("vintid"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        desc"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("its_vmapti_cmd"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("event_id "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(" id"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        desc"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("its_vmapti_cmd"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("db_enabled "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(" map"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("db_enabled"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        "),(0,e._)("span",{class:"token function"},"its_send_single_vcommand"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("dev"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("its"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" its_build_vmapti_cmd"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"&"),(0,e.Uk)("desc"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n"),(0,e._)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n")])]),(0,e._)("div",{class:"line-numbers"},[(0,e._)("span",{class:"line-number"},"1"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"2"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"3"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"4"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"5"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"6"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"7"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"8"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"9"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"10"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"11"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"12"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"13"),(0,e._)("br")])],-1),Fn=(0,e._)("h4",{id:"scheduled-virtual-pe",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#scheduled-virtual-pe","aria-hidden":"true"},"#"),(0,e.Uk)(" Scheduled virtual PE")],-1),Yn=(0,e._)("p",null,"Virtual interrupts for the scheduled vPE can be directly injected. If the target vPE is not scheduled, the virtual interrupt is recorded as being pending in the appropriate VPT.",-1),Hn=(0,e._)("p",null,"When performing a context swith between vPEs, a hypervisor must update the Redistributor registers. This means that the hypervisor must:",-1),Kn=(0,e._)("ul",null,[(0,e._)("li",null,[(0,e.Uk)("Clear "),(0,e._)("code",null,"GICR_VPENDBASER.Valid")]),(0,e._)("li",null,[(0,e.Uk)("Poll "),(0,e._)("code",null,"GICR_BPENDBASER.Dirty"),(0,e.Uk)(" until it reads 0")]),(0,e._)("li",null,[(0,e.Uk)("Update "),(0,e._)("code",null,"GICR_VPROPBASER")]),(0,e._)("li",null,[(0,e.Uk)("Update "),(0,e._)("code",null,"GICR_VPROPBASER"),(0,e.Uk)(", setting Valid==1 in the process")])],-1),Qn=(0,e._)("div",{class:"language-c ext-c line-numbers-mode"},[(0,e._)("pre",{class:"language-c"},[(0,e._)("code",null,[(0,e._)("span",{class:"token keyword"},"int"),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"its_make_vpe_resident"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"its_vpe"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"*"),(0,e.Uk)("vpe"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" bool g0en"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" bool g1en"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n"),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"its_cmd_info"),(0,e.Uk)(" info "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"}"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"int"),(0,e.Uk)(" ret"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        "),(0,e._)("span",{class:"token function"},"WARN_ON"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token function"},"preemptible"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        info"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("cmd_type "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(" SCHEDULE_VPE"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"if"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token function"},"has_v4_1"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n                info"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("g0en "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(" g0en"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n                info"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("g1en "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(" g1en"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token punctuation"},"}"),(0,e.Uk)(),(0,e._)("span",{class:"token keyword"},"else"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token comment"},"/* Disabled the doorbell, as we're about to enter the guest */"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token function"},"disable_irq_nosync"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("vpe"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("irq"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n\n        ret "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"its_send_vpe_cmd"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("vpe"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"&"),(0,e.Uk)("info"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"if"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token operator"},"!"),(0,e.Uk)("ret"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n                vpe"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("resident "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(" true"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        "),(0,e._)("span",{class:"token keyword"},"return"),(0,e.Uk)(" ret"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n"),(0,e._)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n")])]),(0,e._)("div",{class:"line-numbers"},[(0,e._)("span",{class:"line-number"},"1"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"2"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"3"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"4"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"5"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"6"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"7"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"8"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"9"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"10"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"11"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"12"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"13"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"14"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"15"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"16"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"17"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"18"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"19"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"20"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"21"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"22"),(0,e._)("br")])],-1),Zn=(0,e._)("p",null,[(0,e.Uk)("The core function is "),(0,e._)("code",null,"its_send_vpe_cmd"),(0,e.Uk)(" which sends "),(0,e._)("code",null,"SCHEDULE_VPE"),(0,e.Uk)(" cmd.")],-1),Jn=(0,e._)("div",{class:"language-c ext-c line-numbers-mode"},[(0,e._)("pre",{class:"language-c"},[(0,e._)("code",null,[(0,e._)("span",{class:"token keyword"},"static"),(0,e.Uk)(),(0,e._)("span",{class:"token keyword"},"void"),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"its_vpe_4_1_schedule"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"its_vpe"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"*"),(0,e.Uk)("vpe"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)("\n                                 "),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"its_cmd_info"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"*"),(0,e.Uk)("info"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n"),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"void"),(0,e.Uk)(" __iomem "),(0,e._)("span",{class:"token operator"},"*"),(0,e.Uk)("vlpi_base "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"gic_data_rdist_vlpi_base"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        u64 val "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token number"},"0"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        "),(0,e._)("span",{class:"token comment"},"/* Schedule the VPE */"),(0,e.Uk)("\n        val "),(0,e._)("span",{class:"token operator"},"|="),(0,e.Uk)(" GICR_VPENDBASER_Valid"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        val "),(0,e._)("span",{class:"token operator"},"|="),(0,e.Uk)(" info"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("g0en "),(0,e._)("span",{class:"token operator"},"?"),(0,e.Uk)(" GICR_VPENDBASER_4_1_VGRP0EN "),(0,e._)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e._)("span",{class:"token number"},"0"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        val "),(0,e._)("span",{class:"token operator"},"|="),(0,e.Uk)(" info"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("g1en "),(0,e._)("span",{class:"token operator"},"?"),(0,e.Uk)(" GICR_VPENDBASER_4_1_VGRP1EN "),(0,e._)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e._)("span",{class:"token number"},"0"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        val "),(0,e._)("span",{class:"token operator"},"|="),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"FIELD_PREP"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("GICR_VPENDBASER_4_1_VPEID"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" vpe"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("vpe_id"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        "),(0,e._)("span",{class:"token function"},"gicr_write_vpendbaser"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("val"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" vlpi_base "),(0,e._)("span",{class:"token operator"},"+"),(0,e.Uk)(" GICR_VPENDBASER"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n"),(0,e._)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n")])]),(0,e._)("div",{class:"line-numbers"},[(0,e._)("span",{class:"line-number"},"1"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"2"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"3"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"4"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"5"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"6"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"7"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"8"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"9"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"10"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"11"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"12"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"13"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"14"),(0,e._)("br")])],-1),Xn=(0,e._)("p",null,[(0,e.Uk)("It writes "),(0,e._)("code",null,"VPENDBASER"),(0,e.Uk)(" as above.")],-1),$n=(0,e._)("h4",{id:"inject-interrupts",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#inject-interrupts","aria-hidden":"true"},"#"),(0,e.Uk)(" Inject interrupts")],-1),ns=(0,e._)("p",null,[(0,e.Uk)("When a peripheral writes to "),(0,e._)("code",null,"GITS_TRANSLATER")],-1),ss=(0,e._)("ol",null,[(0,e._)("li",null,"The ITS uses the DeviceID to select the appropriate entry from the Device table. This entry identifies the Interrupt translation table to use."),(0,e._)("li",null,"The ITS uses the EventID to select the appropriate entry from the Interrupt translation table. This will return either: a. A pINTID and Collection ID b. A vINTID and vPE ID, and optionally a pINTID as a door-bell interrupt"),(0,e._)("li",null,[(0,e.Uk)("The ITS uses the vPE ID to select the required entry in the vPE table and the vPE table "),(0,e._)("strong",null,"returns the target Redistributor and the address of the VPT of the vPE"),(0,e.Uk)(".")]),(0,e._)("li",null,"The ITS forwards the vINTID, a door-bell interrupt and VPT address to the target Redistributor."),(0,e._)("li",null,[(0,e.Uk)("The Redistributor compares the VPT address from the ITS against the current "),(0,e._)("code",null,"GICR_BPENDBASER"),(0,e.Uk)(" a. if the VPT address and current "),(0,e._)("code",null,"GICR_BPENDBASER"),(0,e.Uk)(" match, the vPE is scheduled, and the vINTID is forwarded to the virtual CPU interface. b. if the VPT address and current "),(0,e._)("code",null,"GICR_BPENDBASER"),(0,e.Uk)(" do not match, the vPE is not scheduled. The vINTID is set as pending in the VPT. If a door-bell interrupt was provided, the pINTID is forwarded to the physical CPU interface.")])],-1),as=(0,e._)("h3",{id:"direct-injection-of-virtual-software-generated-interrupts-sgis",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#direct-injection-of-virtual-software-generated-interrupts-sgis","aria-hidden":"true"},"#"),(0,e.Uk)(" Direct injection of virtual Software Generated Interrupts (SGIs)")],-1),es=(0,e._)("p",null,"GICv4.1 supports direct injection of SGIs which allows SGIs to be directly injected via the ITS. This mechanism still requires a trap to the hypervisor on the sending PE but removes the need for a trap to the hypervisor on the receiving PE(s).",-1),ts=(0,e._)("div",{class:"language-c ext-c line-numbers-mode"},[(0,e._)("pre",{class:"language-c"},[(0,e._)("code",null,[(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"its_vpe"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"union"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token comment"},"/* GICv4.0 implementations */"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token comment"},"//"),(0,e.Uk)("\n\n                "),(0,e._)("span",{class:"token comment"},"/* GICv4.1 implementations */"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n                        "),(0,e._)("span",{class:"token comment"},"//"),(0,e.Uk)("\n                        "),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"irq_domain"),(0,e.Uk)("       "),(0,e._)("span",{class:"token operator"},"*"),(0,e.Uk)("sgi_domain"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n                        "),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n                                u8              priority"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n                                bool            enabled"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n                                bool            group"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n                        "),(0,e._)("span",{class:"token punctuation"},"}"),(0,e.Uk)("                       sgi_config"),(0,e._)("span",{class:"token punctuation"},"["),(0,e._)("span",{class:"token number"},"16"),(0,e._)("span",{class:"token punctuation"},"]"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n                        "),(0,e._)("span",{class:"token comment"},"//"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n"),(0,e._)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n")])]),(0,e._)("div",{class:"line-numbers"},[(0,e._)("span",{class:"line-number"},"1"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"2"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"3"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"4"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"5"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"6"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"7"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"8"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"9"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"10"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"11"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"12"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"13"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"14"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"15"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"16"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"17"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"18"),(0,e._)("br")])],-1),os=(0,e._)("div",{class:"language-c ext-c line-numbers-mode"},[(0,e._)("pre",{class:"language-c"},[(0,e._)("code",null,[(0,e._)("span",{class:"token keyword"},"static"),(0,e.Uk)(),(0,e._)("span",{class:"token keyword"},"int"),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"its_alloc_vcpu_sgis"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"its_vpe"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"*"),(0,e.Uk)("vpe"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e._)("span",{class:"token keyword"},"int"),(0,e.Uk)(" idx"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n"),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"char"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"*"),(0,e.Uk)("name"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"int"),(0,e.Uk)(" sgi_base"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        "),(0,e._)("span",{class:"token keyword"},"if"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token operator"},"!"),(0,e._)("span",{class:"token function"},"has_v4_1_sgi"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token keyword"},"return"),(0,e.Uk)(),(0,e._)("span",{class:"token number"},"0"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        name "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"kasprintf"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("GFP_KERNEL"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e._)("span",{class:"token string"},'"GICv4-sgi-%d"'),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"task_pid_nr"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("current"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"if"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token operator"},"!"),(0,e.Uk)("name"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token keyword"},"goto"),(0,e.Uk)(" err"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        vpe"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("fwnode "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"irq_domain_alloc_named_id_fwnode"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("name"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" idx"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"if"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token operator"},"!"),(0,e.Uk)("vpe"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("fwnode"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token keyword"},"goto"),(0,e.Uk)(" err"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        "),(0,e._)("span",{class:"token function"},"kfree"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("name"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        name "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token constant"},"NULL"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        vpe"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("sgi_domain "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"irq_domain_create_linear"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("vpe"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("fwnode"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e._)("span",{class:"token number"},"16"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)("\n                                                   sgi_domain_ops"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" vpe"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"if"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token operator"},"!"),(0,e.Uk)("vpe"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("sgi_domain"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token keyword"},"goto"),(0,e.Uk)(" err"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        sgi_base "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"__irq_domain_alloc_irqs"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("vpe"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("sgi_domain"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"-"),(0,e._)("span",{class:"token number"},"1"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e._)("span",{class:"token number"},"16"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)("\n                                               NUMA_NO_NODE"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" vpe"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)("\n                                               false"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e._)("span",{class:"token constant"},"NULL"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"if"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("sgi_base "),(0,e._)("span",{class:"token operator"},"<="),(0,e.Uk)(),(0,e._)("span",{class:"token number"},"0"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token keyword"},"goto"),(0,e.Uk)(" err"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        "),(0,e._)("span",{class:"token keyword"},"return"),(0,e.Uk)(),(0,e._)("span",{class:"token number"},"0"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\nerr"),(0,e._)("span",{class:"token operator"},":"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"if"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("vpe"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("sgi_domain"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token function"},"irq_domain_remove"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("vpe"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("sgi_domain"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"if"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("vpe"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("fwnode"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token function"},"irq_domain_free_fwnode"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("vpe"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("fwnode"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token function"},"kfree"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("name"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"return"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"-"),(0,e.Uk)("ENOMEM"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n"),(0,e._)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n")])]),(0,e._)("div",{class:"line-numbers"},[(0,e._)("span",{class:"line-number"},"1"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"2"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"3"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"4"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"5"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"6"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"7"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"8"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"9"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"10"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"11"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"12"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"13"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"14"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"15"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"16"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"17"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"18"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"19"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"20"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"21"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"22"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"23"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"24"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"25"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"26"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"27"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"28"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"29"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"30"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"31"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"32"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"33"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"34"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"35"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"36"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"37"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"38"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"39"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"40"),(0,e._)("br")])],-1),ls=(0,e._)("p",null,[(0,e.Uk)("kvm enables vsgis via "),(0,e._)("code",null,"vgic_v4_configure_vsgis"),(0,e.Uk)(".")],-1),cs=(0,e._)("div",{class:"language-c ext-c line-numbers-mode"},[(0,e._)("pre",{class:"language-c"},[(0,e._)("code",null,[(0,e._)("span",{class:"token comment"},"/* Must be called with the kvm lock held */"),(0,e.Uk)("\n"),(0,e._)("span",{class:"token keyword"},"void"),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"vgic_v4_configure_vsgis"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"kvm"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"*"),(0,e.Uk)("kvm"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n"),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"vgic_dist"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"*"),(0,e.Uk)("dist "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"&"),(0,e.Uk)("kvm"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("arch"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("vgic"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"kvm_vcpu"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"*"),(0,e.Uk)("vcpu"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"int"),(0,e.Uk)(" i"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        "),(0,e._)("span",{class:"token function"},"kvm_arm_halt_guest"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("kvm"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        "),(0,e._)("span",{class:"token function"},"kvm_for_each_vcpu"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("i"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" vcpu"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" kvm"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token keyword"},"if"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("dist"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("nassgireq"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n                        "),(0,e._)("span",{class:"token function"},"vgic_v4_enable_vsgis"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("vcpu"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token keyword"},"else"),(0,e.Uk)("\n                        "),(0,e._)("span",{class:"token function"},"vgic_v4_disable_vsgis"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("vcpu"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n\n        "),(0,e._)("span",{class:"token function"},"kvm_arm_resume_guest"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("kvm"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n"),(0,e._)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n\n"),(0,e._)("span",{class:"token keyword"},"static"),(0,e.Uk)(),(0,e._)("span",{class:"token keyword"},"void"),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"vgic_v4_enable_vsgis"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"kvm_vcpu"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"*"),(0,e.Uk)("vcpu"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n"),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"its_vpe"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"*"),(0,e.Uk)("vpe "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"&"),(0,e.Uk)("vcpu"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("arch"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("vgic_cpu"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("vgic_v3"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("its_vpe"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"int"),(0,e.Uk)(" i"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        "),(0,e._)("span",{class:"token comment"},"/*\n         * With GICv4.1, every virtual SGI can be directly injected. So\n         * let's pretend that they are HW interrupts, tied to a host\n         * IRQ. The SGI code will do its magic.\n         */"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"for"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("i "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token number"},"0"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)(" i "),(0,e._)("span",{class:"token operator"},"<"),(0,e.Uk)(" VGIC_NR_SGIS"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)(" i"),(0,e._)("span",{class:"token operator"},"++"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"vgic_irq"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"*"),(0,e.Uk)("irq "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"vgic_get_irq"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("vcpu"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("kvm"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" vcpu"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" i"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"irq_desc"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"*"),(0,e.Uk)("desc"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token keyword"},"unsigned"),(0,e.Uk)(),(0,e._)("span",{class:"token keyword"},"long"),(0,e.Uk)(" flags"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token keyword"},"int"),(0,e.Uk)(" ret"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n                "),(0,e._)("span",{class:"token function"},"raw_spin_lock_irqsave"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token operator"},"&"),(0,e.Uk)("irq"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("irq_lock"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" flags"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n                "),(0,e._)("span",{class:"token keyword"},"if"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("irq"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("hw"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n                        "),(0,e._)("span",{class:"token keyword"},"goto"),(0,e.Uk)(" unlock"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n                irq"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("hw "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(" true"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n                irq"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("host_irq "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"irq_find_mapping"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("vpe"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("sgi_domain"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" i"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n                "),(0,e._)("span",{class:"token comment"},"/* Transfer the full irq state to the vPE */"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token function"},"vgic_v4_sync_sgi_config"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("vpe"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" irq"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n                desc "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"irq_to_desc"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("irq"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("host_irq"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n                ret "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"irq_domain_activate_irq"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token function"},"irq_desc_get_irq_data"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("desc"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)("\n                                              false"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token keyword"},"if"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token operator"},"!"),(0,e._)("span",{class:"token function"},"WARN_ON"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("ret"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n                        "),(0,e._)("span",{class:"token comment"},"/* Transfer pending state */"),(0,e.Uk)("\n                        ret "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"irq_set_irqchip_state"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("irq"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("host_irq"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)("\n                                                    IRQCHIP_STATE_PENDING"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)("\n                                                    irq"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("pending_latch"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n                        "),(0,e._)("span",{class:"token function"},"WARN_ON"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("ret"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n                        irq"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("pending_latch "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(" false"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n        unlock"),(0,e._)("span",{class:"token operator"},":"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token function"},"raw_spin_unlock_irqrestore"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token operator"},"&"),(0,e.Uk)("irq"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("irq_lock"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" flags"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token function"},"vgic_put_irq"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("vcpu"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("kvm"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" irq"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n"),(0,e._)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n")])]),(0,e._)("div",{class:"line-numbers"},[(0,e._)("span",{class:"line-number"},"1"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"2"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"3"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"4"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"5"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"6"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"7"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"8"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"9"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"10"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"11"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"12"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"13"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"14"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"15"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"16"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"17"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"18"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"19"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"20"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"21"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"22"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"23"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"24"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"25"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"26"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"27"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"28"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"29"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"30"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"31"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"32"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"33"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"34"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"35"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"36"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"37"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"38"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"39"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"40"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"41"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"42"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"43"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"44"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"45"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"46"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"47"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"48"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"49"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"50"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"51"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"52"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"53"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"54"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"55"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"56"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"57"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"58"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"59"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"60"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"61"),(0,e._)("br")])],-1),ps=(0,e._)("h2",{id:"virtualization-kvm-part",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#virtualization-kvm-part","aria-hidden":"true"},"#"),(0,e.Uk)(" Virtualization (KVM part)")],-1),rs=(0,e._)("p",null,"In this section, we are going to talk about how KVM interact with (v)GIC.",-1),is=(0,e._)("h3",{id:"forward-an-interrupt-direct-injection",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#forward-an-interrupt-direct-injection","aria-hidden":"true"},"#"),(0,e.Uk)(" Forward an interrupt (Direct Injection)")],-1),_s=(0,e._)("div",{class:"language-c ext-c line-numbers-mode"},[(0,e._)("pre",{class:"language-c"},[(0,e._)("code",null,[(0,e._)("span",{class:"token keyword"},"int"),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"kvm_vgic_v4_set_forwarding"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"kvm"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"*"),(0,e.Uk)("kvm"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e._)("span",{class:"token keyword"},"int"),(0,e.Uk)(" virq"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)("\n                               "),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"kvm_kernel_irq_routing_entry"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"*"),(0,e.Uk)("irq_entry"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n"),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"vgic_its"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"*"),(0,e.Uk)("its"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"vgic_irq"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"*"),(0,e.Uk)("irq"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"its_vlpi_map"),(0,e.Uk)(" map"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"unsigned"),(0,e.Uk)(),(0,e._)("span",{class:"token keyword"},"long"),(0,e.Uk)(" flags"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"int"),(0,e.Uk)(" ret"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        "),(0,e._)("span",{class:"token keyword"},"if"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token operator"},"!"),(0,e._)("span",{class:"token function"},"vgic_supports_direct_msis"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("kvm"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token keyword"},"return"),(0,e.Uk)(),(0,e._)("span",{class:"token number"},"0"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        "),(0,e._)("span",{class:"token comment"},"/*\n         * Get the ITS, and escape early on error (not a valid\n         * doorbell for any of our vITSs).\n         */"),(0,e.Uk)("\n        its "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"vgic_get_its"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("kvm"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" irq_entry"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"if"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token function"},"IS_ERR"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("its"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token keyword"},"return"),(0,e.Uk)(),(0,e._)("span",{class:"token number"},"0"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        "),(0,e._)("span",{class:"token function"},"mutex_lock"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token operator"},"&"),(0,e.Uk)("its"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("its_lock"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        "),(0,e._)("span",{class:"token comment"},"/* Perform the actual DevID/EventID -> LPI translation. */"),(0,e.Uk)("\n        ret "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"vgic_its_resolve_lpi"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("kvm"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" its"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" irq_entry"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("msi"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("devid"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)("\n                                   irq_entry"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("msi"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("data"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"&"),(0,e.Uk)("irq"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"if"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("ret"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token keyword"},"goto"),(0,e.Uk)(" out"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n")])]),(0,e._)("div",{class:"line-numbers"},[(0,e._)("span",{class:"line-number"},"1"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"2"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"3"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"4"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"5"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"6"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"7"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"8"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"9"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"10"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"11"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"12"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"13"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"14"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"15"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"16"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"17"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"18"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"19"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"20"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"21"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"22"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"23"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"24"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"25"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"26"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"27"),(0,e._)("br")])],-1),us=(0,e._)("div",{class:"language-c ext-c line-numbers-mode"},[(0,e._)("pre",{class:"language-c"},[(0,e._)("code",null,[(0,e.Uk)("        "),(0,e._)("span",{class:"token comment"},"/*\n         * Emit the mapping request. If it fails, the ITS probably\n         * isn't v4 compatible, so let's silently bail out. Holding\n         * the ITS lock should ensure that nothing can modify the\n         * target vcpu.\n         */"),(0,e.Uk)("\n        map "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"its_vlpi_map"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("vm             "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"&"),(0,e.Uk)("kvm"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("arch"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("vgic"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("its_vm"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("vpe            "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"&"),(0,e.Uk)("irq"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("target_vcpu"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("arch"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("vgic_cpu"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("vgic_v3"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("its_vpe"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("vintid         "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(" irq"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("intid"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("properties     "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("irq"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("priority "),(0,e._)("span",{class:"token operator"},"&"),(0,e.Uk)(),(0,e._)("span",{class:"token number"},"0xfc"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"|"),(0,e.Uk)("\n                                   "),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("irq"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("enabled "),(0,e._)("span",{class:"token operator"},"?"),(0,e.Uk)(" LPI_PROP_ENABLED "),(0,e._)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e._)("span",{class:"token number"},"0"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"|"),(0,e.Uk)("\n                                   LPI_PROP_GROUP1"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("db_enabled     "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(" true"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token punctuation"},"}"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        ret "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"its_map_vlpi"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("virq"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"&"),(0,e.Uk)("map"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"if"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("ret"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token keyword"},"goto"),(0,e.Uk)(" out"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        irq"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("hw         "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(" true"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        irq"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("host_irq   "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(" virq"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token function"},"atomic_inc"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token operator"},"&"),(0,e.Uk)("map"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("vpe"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("vlpi_count"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n        "),(0,e._)("span",{class:"token comment"},"/* Transfer pending state */"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token function"},"raw_spin_lock_irqsave"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token operator"},"&"),(0,e.Uk)("irq"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("irq_lock"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" flags"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"if"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("irq"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("pending_latch"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n                ret "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"irq_set_irqchip_state"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("irq"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("host_irq"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)("\n                                            IRQCHIP_STATE_PENDING"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)("\n                                            irq"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("pending_latch"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token function"},"WARN_RATELIMIT"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("ret"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e._)("span",{class:"token string"},'"IRQ %d"'),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" irq"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("host_irq"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n                "),(0,e._)("span",{class:"token comment"},"/*\n                 * Clear pending_latch and communicate this state\n                 * change via vgic_queue_irq_unlock.\n                 */"),(0,e.Uk)("\n                irq"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("pending_latch "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(" false"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token function"},"vgic_queue_irq_unlock"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("kvm"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" irq"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" flags"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token punctuation"},"}"),(0,e.Uk)(),(0,e._)("span",{class:"token keyword"},"else"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n                "),(0,e._)("span",{class:"token function"},"raw_spin_unlock_irqrestore"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token operator"},"&"),(0,e.Uk)("irq"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("irq_lock"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" flags"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n\nout"),(0,e._)("span",{class:"token operator"},":"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token function"},"mutex_unlock"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token operator"},"&"),(0,e.Uk)("its"),(0,e._)("span",{class:"token operator"},"->"),(0,e.Uk)("its_lock"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"return"),(0,e.Uk)(" ret"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n"),(0,e._)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n")])]),(0,e._)("div",{class:"line-numbers"},[(0,e._)("span",{class:"line-number"},"1"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"2"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"3"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"4"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"5"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"6"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"7"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"8"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"9"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"10"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"11"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"12"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"13"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"14"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"15"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"16"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"17"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"18"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"19"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"20"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"21"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"22"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"23"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"24"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"25"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"26"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"27"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"28"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"29"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"30"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"31"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"32"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"33"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"34"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"35"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"36"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"37"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"38"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"39"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"40"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"41"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"42"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"43"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"44"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"45"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"46"),(0,e._)("br")])],-1),ks={render:function(n,s){const a=(0,e.up)("RouterLink");return(0,e.wg)(),(0,e.iD)(e.HY,null,[o,(0,e._)("nav",l,[(0,e._)("ul",null,[(0,e._)("li",null,[(0,e.Wm)(a,{to:"#registers"},{default:(0,e.w5)((()=>[c])),_:1}),(0,e._)("ul",null,[(0,e._)("li",null,[(0,e.Wm)(a,{to:"#distributor-gicd"},{default:(0,e.w5)((()=>[p])),_:1})]),(0,e._)("li",null,[(0,e.Wm)(a,{to:"#redistributors-gicr"},{default:(0,e.w5)((()=>[r])),_:1})]),(0,e._)("li",null,[(0,e.Wm)(a,{to:"#cpu-interfaces-icc-eln"},{default:(0,e.w5)((()=>[i])),_:1})])])]),(0,e._)("li",null,[(0,e.Wm)(a,{to:"#lift-cycle-of-an-interrupt"},{default:(0,e.w5)((()=>[_])),_:1}),(0,e._)("ul",null,[(0,e._)("li",null,[(0,e.Wm)(a,{to:"#level-sensitive-interrupts"},{default:(0,e.w5)((()=>[u])),_:1})]),(0,e._)("li",null,[(0,e.Wm)(a,{to:"#edge-sensitive-interrupts"},{default:(0,e.w5)((()=>[k])),_:1})]),(0,e._)("li",null,[(0,e.Wm)(a,{to:"#end-of-interrupt"},{default:(0,e.w5)((()=>[b])),_:1})])])]),(0,e._)("li",null,[(0,e.Wm)(a,{to:"#affinity"},{default:(0,e.w5)((()=>[U])),_:1})]),(0,e._)("li",null,[(0,e.Wm)(a,{to:"#interrupt-prioritization"},{default:(0,e.w5)((()=>[d])),_:1}),(0,e._)("ul",null,[(0,e._)("li",null,[(0,e.Wm)(a,{to:"#preemption"},{default:(0,e.w5)((()=>[m])),_:1})])])]),(0,e._)("li",null,[(0,e.Wm)(a,{to:"#virtualization-gic-part"},{default:(0,e.w5)((()=>[v])),_:1}),(0,e._)("ul",null,[(0,e._)("li",null,[(0,e.Wm)(a,{to:"#gicv4-1"},{default:(0,e.w5)((()=>[h])),_:1})]),(0,e._)("li",null,[(0,e.Wm)(a,{to:"#direct-injection-of-virtual-interrupts-gicv4"},{default:(0,e.w5)((()=>[f])),_:1})]),(0,e._)("li",null,[(0,e.Wm)(a,{to:"#direct-injection-of-virtual-software-generated-interrupts-sgis"},{default:(0,e.w5)((()=>[g])),_:1})])])]),(0,e._)("li",null,[(0,e.Wm)(a,{to:"#virtualization-kvm-part"},{default:(0,e.w5)((()=>[y])),_:1}),(0,e._)("ul",null,[(0,e._)("li",null,[(0,e.Wm)(a,{to:"#forward-an-interrupt-direct-injection"},{default:(0,e.w5)((()=>[w])),_:1})])])])])]),I,E,P,D,R,T,q,C,x,G,V,A,N,L,S,j,M,O,z,W,B,F,Y,H,K,Q,Z,J,X,$,nn,sn,an,en,tn,on,ln,cn,pn,rn,_n,un,kn,bn,Un,dn,mn,vn,hn,fn,gn,yn,wn,In,En,Pn,Dn,Rn,Tn,qn,Cn,xn,Gn,Vn,An,Nn,Ln,Sn,jn,Mn,On,zn,Wn,Bn,Fn,Yn,Hn,Kn,Qn,Zn,Jn,Xn,$n,ns,ss,as,es,ts,os,ls,cs,ps,rs,is,_s,us],64)}}},8246:(n,s,a)=>{n.exports=a.p+"assets/img/preemption.6f1d5554.png"}}]);