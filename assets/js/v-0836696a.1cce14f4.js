"use strict";(self.webpackChunknotebook=self.webpackChunknotebook||[]).push([[483],{2867:(n,s,a)=>{a.r(s),a.d(s,{data:()=>e});const e={key:"v-0836696a",path:"/kernel/boot/entry.html",title:"Kernel entry point",lang:"en-US",frontmatter:{},excerpt:"",headers:[{level:2,title:"stext",slug:"stext",children:[]},{level:2,title:"el2_setup",slug:"el2-setup",children:[]},{level:2,title:"__cpu_setup",slug:"cpu-setup",children:[]},{level:2,title:"create page tables",slug:"create-page-tables",children:[{level:3,title:"compute_indices",slug:"compute-indices",children:[]},{level:3,title:"populate page table",slug:"populate-page-table",children:[]},{level:3,title:"map_memory",slug:"map-memory",children:[]},{level:3,title:"__create_page_tables",slug:"create-page-tables-1",children:[]}]},{level:2,title:"__primary_switch",slug:"primary-switch",children:[]},{level:2,title:"__primary_switched",slug:"primary-switched",children:[]},{level:2,title:"Reference",slug:"reference",children:[]}],filePathRelative:"kernel/boot/entry.md",git:{updatedTime:1627555525e3,contributors:[{name:"Zhang Junyu",email:"zhangjunyu.92@bytedance.com",commits:1}]}}},6394:(n,s,a)=>{a.r(s),a.d(s,{default:()=>p});const e=(0,a(6252).uE)('<h1 id="kernel-entry-point" tabindex="-1"><a class="header-anchor" href="#kernel-entry-point" aria-hidden="true">#</a> Kernel entry point</h1><h2 id="stext" tabindex="-1"><a class="header-anchor" href="#stext" aria-hidden="true">#</a> stext</h2><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token function">ENTRY</span><span class="token punctuation">(</span>stext<span class="token punctuation">)</span>\n        bl      preserve_boot_args\n        bl      el2_setup                       <span class="token comment">// Drop to EL1, w0=cpu_boot_mode</span>\n        adrp    x23<span class="token punctuation">,</span> __PHYS_OFFSET\n        and     x23<span class="token punctuation">,</span> x23<span class="token punctuation">,</span> MIN_KIMG_ALIGN <span class="token operator">-</span> <span class="token number">1</span>    <span class="token comment">// KASLR offset, defaults to 0</span>\n        bl      set_cpu_boot_mode_flag\n        bl      __create_page_tables\n        <span class="token comment">/*\n         * The following calls CPU setup code, see arch/arm64/mm/proc.S for\n         * details.\n         * On return, the CPU will be ready for the MMU to be turned on and\n         * the TCR will have been set.\n         */</span>\n        bl      __cpu_setup                     <span class="token comment">// initialise processor</span>\n        b       __primary_switch\n<span class="token function">ENDPROC</span><span class="token punctuation">(</span>stext<span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="el2-setup" tabindex="-1"><a class="header-anchor" href="#el2-setup" aria-hidden="true">#</a> el2_setup</h2><p>read <code>CurrentEL</code> register to find out the current exception level.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token function">ENTRY</span><span class="token punctuation">(</span>el2_setup<span class="token punctuation">)</span>\n        msr     SPsel<span class="token punctuation">,</span> #<span class="token number">1</span>                       <span class="token comment">// We want to use SP_EL{1,2}</span>\n        mrs     x0<span class="token punctuation">,</span> CurrentEL\n        cmp     x0<span class="token punctuation">,</span> #CurrentEL_EL2\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>If it is booting in EL1, setup <code>sctlr_el1</code> register and return.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCTLR_EL1_RES1</span>  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">_BITUL</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token function">_BITUL</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token function">_BITUL</span><span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token function">_BITUL</span><span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> </span><span class="token punctuation">\\</span>\n                         <span class="token expression"><span class="token punctuation">(</span><span class="token function">_BITUL</span><span class="token punctuation">(</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>        b<span class="token punctuation">.</span>eq    <span class="token number">1f</span>\n        mov_q   x0<span class="token punctuation">,</span> <span class="token punctuation">(</span>SCTLR_EL1_RES1 <span class="token operator">|</span> ENDIAN_SET_EL1<span class="token punctuation">)</span>\n        msr     sctlr_el1<span class="token punctuation">,</span> x0\n        mov     w0<span class="token punctuation">,</span> #BOOT_CPU_MODE_EL1          <span class="token comment">// This cpu booted in EL1</span>\n        isb\n        ret\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>If it is booting in EL2. setup <code>sctlr_el2</code>.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token number">1</span><span class="token operator">:</span>      mov_q   x0<span class="token punctuation">,</span> <span class="token punctuation">(</span>SCTLR_EL2_RES1 <span class="token operator">|</span> ENDIAN_SET_EL2<span class="token punctuation">)</span>\n        msr     sctlr_el2<span class="token punctuation">,</span> x0\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Read bits[11:8] of <code>id_aa64mmfr1_el1</code> register to find out whether the processor supports VHE.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_ARM64_VHE</span></span>\n        <span class="token comment">/*\n         * Check for VHE being present. For the rest of the EL2 setup,\n         * x2 being non-zero indicates that we do have VHE, and that the\n         * kernel is intended to run at EL2.\n         */</span>\n        mrs     x2<span class="token punctuation">,</span> id_aa64mmfr1_el1\n        ubfx    x2<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> #ID_AA64MMFR1_VHE_SHIFT<span class="token punctuation">,</span> #<span class="token number">4</span>\n<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>\n        mov     x2<span class="token punctuation">,</span> xzr\n<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>If the processor supports VHE, write <code>hcr_el2</code> to <code>HCR_HOST_VHE_FLAGS</code>, otherwise <code>HCR_HOST_NVHE_FLAGS</code>.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// Trap General Exceptions</span>\n<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HCR_TGE</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token function">UL</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">27</span><span class="token punctuation">)</span></span></span>\n\n<span class="token comment">// The Execution state for EL1 is AArch64</span>\n<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HCR_RW_SHIFT</span>    <span class="token expression"><span class="token number">31</span></span></span>\n<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HCR_RW</span>          <span class="token expression"><span class="token punctuation">(</span><span class="token function">UL</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> HCR_RW_SHIFT<span class="token punctuation">)</span></span></span>\n\n<span class="token comment">// EL2 Host. Enables a configuration where a Host Operating</span>\n<span class="token comment">// System is running in EL2, and the Host Operating System&#39;s</span>\n<span class="token comment">// applications are running in EL0.</span>\n<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HCR_E2H</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token function">UL</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">34</span><span class="token punctuation">)</span></span></span>\n\n<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HCR_HOST_VHE_FLAGS</span> <span class="token expression"><span class="token punctuation">(</span>HCR_RW <span class="token operator">|</span> HCR_TGE <span class="token operator">|</span> HCR_E2H<span class="token punctuation">)</span></span></span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>        <span class="token comment">/* Hyp configuration. */</span>\n        mov_q   x0<span class="token punctuation">,</span> HCR_HOST_NVHE_FLAGS\n        cbz     x2<span class="token punctuation">,</span> set_hcr\n        mov_q   x0<span class="token punctuation">,</span> HCR_HOST_VHE_FLAGS\nset_hcr<span class="token operator">:</span>\n        msr     hcr_el2<span class="token punctuation">,</span> x0\n        isb\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>If NVHE is enabled, setup <code>cnthctl_el2</code> register so that accessing physical timer and counter is allowed.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>        <span class="token comment">/*\n         * Allow Non-secure EL1 and EL0 to access physical timer and counter.\n         * This is not necessary for VHE, since the host kernel runs in EL2,\n         * and EL0 accesses are configured in the later stage of boot process.\n         * Note that when HCR_EL2.E2H == 1, CNTHCTL_EL2 has the same bit layout\n         * as CNTKCTL_EL1, and CNTKCTL_EL1 accessing instructions are redefined\n         * to access CNTHCTL_EL2. This allows the kernel designed to run at EL1\n         * to transparently mess with the EL0 bits via CNTKCTL_EL1 access in\n         * EL2.\n         */</span>\n        cbnz    x2<span class="token punctuation">,</span> <span class="token number">1f</span>\n        mrs     x0<span class="token punctuation">,</span> cnthctl_el2\n        orr     x0<span class="token punctuation">,</span> x0<span class="token punctuation">,</span> #<span class="token number">3</span>                      <span class="token comment">// Enable EL1 physical timers</span>\n        msr     cnthctl_el2<span class="token punctuation">,</span> x0\n<span class="token number">1</span><span class="token operator">:</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>        msr     cntvoff_el2<span class="token punctuation">,</span> xzr                <span class="token comment">// Clear virtual offset</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>Read bits[24:4] of <code>id_aa64pfr0_el1</code> register.</p><p>Value 0 means <em>GIC CPU interface system registers not implemented</em>, jump to <code>3f</code>.</p><p>Value not 0 means <em>System register interface to versions 3.0, 4.0 or 4.1 of the GIC CPU interface is supported</em>. In this case, setup <code>SYS_ICC_SRE_EL2</code>.</p><ul><li><code>ICC_SRE_EL2_ENABLE</code>: EL1 accesses to <code>ICC_SRE_EL1</code> do not trap to EL2.</li><li><code>ICC_SRE_EL2_SRE</code>: The System register interface to the ICH_* registers and the EL1 and EL2 ICC_* registers is enabled for EL2.</li></ul><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_ARM_GIC_V3</span></span>\n        <span class="token comment">/* GICv3 system register access */</span>\n        mrs     x0<span class="token punctuation">,</span> id_aa64pfr0_el1\n        ubfx    x0<span class="token punctuation">,</span> x0<span class="token punctuation">,</span> #ID_AA64PFR0_GIC_SHIFT<span class="token punctuation">,</span> #<span class="token number">4</span>\n        cbz     x0<span class="token punctuation">,</span> <span class="token number">3f</span>\n\n        mrs_s   x0<span class="token punctuation">,</span> SYS_ICC_SRE_EL2\n        orr     x0<span class="token punctuation">,</span> x0<span class="token punctuation">,</span> #ICC_SRE_EL2_SRE        <span class="token comment">// Set ICC_SRE_EL2.SRE==1</span>\n        orr     x0<span class="token punctuation">,</span> x0<span class="token punctuation">,</span> #ICC_SRE_EL2_ENABLE     <span class="token comment">// Set ICC_SRE_EL2.Enable==1</span>\n        msr_s   SYS_ICC_SRE_EL2<span class="token punctuation">,</span> x0\n        isb                                     <span class="token comment">// Make sure SRE is now set</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>Double check, if failed to set <code>SYS_ICC_SRE_EL2</code>, reset <code>SYS_ICH_HCR_EL2</code>.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>        mrs_s   x0<span class="token punctuation">,</span> SYS_ICC_SRE_EL2             <span class="token comment">// Read SRE back,</span>\n        tbz     x0<span class="token punctuation">,</span> #<span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3f</span>                      <span class="token comment">// and check that it sticks</span>\n        msr_s   SYS_ICH_HCR_EL2<span class="token punctuation">,</span> xzr            <span class="token comment">// Reset ICC_HCR_EL2 to defaults</span>\n\n<span class="token number">3</span><span class="token operator">:</span>\n<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>Read <code>midr_el1</code> register which provides identification information for the PE, including an implementer code for the device and a device ID number.</p><p>Read <code>mpidr_el1</code> which provides an additional PE identification mechanism for scheduling purposes.</p><p>These are useful, see <code>__sysreg_save_el1_state</code> for more details.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>        <span class="token comment">/* Populate ID registers. */</span>\n        mrs     x0<span class="token punctuation">,</span> midr_el1\n        mrs     x1<span class="token punctuation">,</span> mpidr_el1\n        msr     vpidr_el2<span class="token punctuation">,</span> x0\n        msr     vmpidr_el2<span class="token punctuation">,</span> x1\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_COMPAT</span></span>\n        msr     hstr_el2<span class="token punctuation">,</span> xzr                   <span class="token comment">// Disable CP15 traps to EL2</span>\n<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Read bits[11:8] of <code>id_aa64dfr0_el1</code> register to get the version of pmu. Read bits[35:32] of <code>id_aa64dfr0_el1</code> register to get the version of Statistical Profiling Extension.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>        <span class="token comment">/* EL2 debug */</span>\n        mrs     x1<span class="token punctuation">,</span> id_aa64dfr0_el1\n        sbfx    x0<span class="token punctuation">,</span> x1<span class="token punctuation">,</span> #ID_AA64DFR0_PMUVER_SHIFT<span class="token punctuation">,</span> #<span class="token number">4</span>\n        cmp     x0<span class="token punctuation">,</span> #<span class="token number">1</span>\n        b<span class="token punctuation">.</span>lt    <span class="token number">4f</span>                              <span class="token comment">// Skip if no PMU present</span>\n        mrs     x0<span class="token punctuation">,</span> pmcr_el0                    <span class="token comment">// Disable debug access traps</span>\n        ubfx    x0<span class="token punctuation">,</span> x0<span class="token punctuation">,</span> #<span class="token number">11</span><span class="token punctuation">,</span> #<span class="token number">5</span>                 <span class="token comment">// to EL2 and allow access to</span>\n<span class="token number">4</span><span class="token operator">:</span>\n        csel    x3<span class="token punctuation">,</span> xzr<span class="token punctuation">,</span> x0<span class="token punctuation">,</span> lt                 <span class="token comment">// all PMU counters from EL1</span>\n\n        <span class="token comment">/* Statistical profiling */</span>\n        ubfx    x0<span class="token punctuation">,</span> x1<span class="token punctuation">,</span> #ID_AA64DFR0_PMSVER_SHIFT<span class="token punctuation">,</span> #<span class="token number">4</span>\n        cbz     x0<span class="token punctuation">,</span> <span class="token number">7f</span>                          <span class="token comment">// Skip if SPE not present</span>\n        cbnz    x2<span class="token punctuation">,</span> <span class="token number">6f</span>                          <span class="token comment">// VHE?</span>\n        mrs_s   x4<span class="token punctuation">,</span> SYS_PMBIDR_EL1              <span class="token comment">// If SPE available at EL2,</span>\n        and     x4<span class="token punctuation">,</span> x4<span class="token punctuation">,</span> #<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> SYS_PMBIDR_EL1_P_SHIFT<span class="token punctuation">)</span>\n        cbnz    x4<span class="token punctuation">,</span> <span class="token number">5f</span>                          <span class="token comment">// then permit sampling of physical</span>\n        mov     x4<span class="token punctuation">,</span> #<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> SYS_PMSCR_EL2_PCT_SHIFT <span class="token operator">|</span> \\\n                      <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> SYS_PMSCR_EL2_PA_SHIFT<span class="token punctuation">)</span>\n        msr_s   SYS_PMSCR_EL2<span class="token punctuation">,</span> x4               <span class="token comment">// addresses and physical counter</span>\n<span class="token number">5</span><span class="token operator">:</span>\n        mov     x1<span class="token punctuation">,</span> #<span class="token punctuation">(</span>MDCR_EL2_E2PB_MASK <span class="token operator">&lt;&lt;</span> MDCR_EL2_E2PB_SHIFT<span class="token punctuation">)</span>\n        orr     x3<span class="token punctuation">,</span> x3<span class="token punctuation">,</span> x1                      <span class="token comment">// If we don&#39;t have VHE, then</span>\n        b       <span class="token number">7f</span>                              <span class="token comment">// use EL1&amp;0 translation.</span>\n<span class="token number">6</span><span class="token operator">:</span>                                              <span class="token comment">// For VHE, use EL2 translation</span>\n        orr     x3<span class="token punctuation">,</span> x3<span class="token punctuation">,</span> #MDCR_EL2_TPMS          <span class="token comment">// and disable access from EL1</span>\n<span class="token number">7</span><span class="token operator">:</span>\n        msr     mdcr_el2<span class="token punctuation">,</span> x3                    <span class="token comment">// Configure debug traps</span>\n```c\n\nRead bits<span class="token punctuation">[</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">16</span><span class="token punctuation">]</span> of `id_aa64mmfr1_el1` <span class="token keyword">register</span> which indicates support\n<span class="token keyword">for</span> LORegions<span class="token punctuation">.</span>\n\n```c\n        <span class="token comment">/* LORegions */</span>\n        mrs     x1<span class="token punctuation">,</span> id_aa64mmfr1_el1\n        ubfx    x0<span class="token punctuation">,</span> x1<span class="token punctuation">,</span> #ID_AA64MMFR1_LOR_SHIFT<span class="token punctuation">,</span> <span class="token number">4</span>\n        cbz     x0<span class="token punctuation">,</span> <span class="token number">1f</span>\n        msr_s   SYS_LORC_EL1<span class="token punctuation">,</span> xzr\n<span class="token number">1</span><span class="token operator">:</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>Clear <code>vttbr_el2</code> register.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>        <span class="token comment">/* Stage-2 translation */</span>\n        msr     vttbr_el2<span class="token punctuation">,</span> xzr\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>If NVHE is enabled, early init EL2. otherwise we directly return. See the following comment for more details.</p><div class="custom-container danger"><p class="custom-container-title">DANGER</p><p>If VHE is enabled, the last instruction is <code>ret</code>; otherwise <code>eret</code>.</p></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>        cbz     x2<span class="token punctuation">,</span> install_el2_stub\n\n        mov     w0<span class="token punctuation">,</span> #BOOT_CPU_MODE_EL2          <span class="token comment">// This CPU booted in EL2</span>\n        isb\n        ret\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>install_el2_stub<span class="token operator">:</span>\n        <span class="token comment">/*\n         * When VHE is not in use, early init of EL2 and EL1 needs to be\n         * done here.\n         * When VHE _is_ in use, EL1 will not be used in the host and\n         * requires no configuration, and all non-hyp-specific EL2 setup\n         * will be done via the _EL1 system register aliases in __cpu_setup.\n         */</span>\n        mov_q   x0<span class="token punctuation">,</span> <span class="token punctuation">(</span>SCTLR_EL1_RES1 <span class="token operator">|</span> ENDIAN_SET_EL1<span class="token punctuation">)</span>\n        msr     sctlr_el1<span class="token punctuation">,</span> x0\n\n        <span class="token comment">/* Coprocessor traps. */</span>\n        mov     x0<span class="token punctuation">,</span> #<span class="token number">0x33ff</span>\n        msr     cptr_el2<span class="token punctuation">,</span> x0                    <span class="token comment">// Disable copro. traps to EL2</span>\n\n        <span class="token comment">/* SVE register access */</span>\n        mrs     x1<span class="token punctuation">,</span> id_aa64pfr0_el1\n        ubfx    x1<span class="token punctuation">,</span> x1<span class="token punctuation">,</span> #ID_AA64PFR0_SVE_SHIFT<span class="token punctuation">,</span> #<span class="token number">4</span>\n        cbz     x1<span class="token punctuation">,</span> <span class="token number">7f</span>\n\n        bic     x0<span class="token punctuation">,</span> x0<span class="token punctuation">,</span> #CPTR_EL2_TZ            <span class="token comment">// Also disable SVE traps</span>\n        msr     cptr_el2<span class="token punctuation">,</span> x0                    <span class="token comment">// Disable copro. traps to EL2</span>\n        isb\n        mov     x1<span class="token punctuation">,</span> #ZCR_ELx_LEN_MASK           <span class="token comment">// SVE: Enable full vector</span>\n        msr_s   SYS_ZCR_EL2<span class="token punctuation">,</span> x1                 <span class="token comment">// length for EL1.</span>\n\n        <span class="token comment">/* Hypervisor stub */</span>\n<span class="token number">7</span><span class="token operator">:</span>      adr_l   x0<span class="token punctuation">,</span> __hyp_stub_vectors\n        msr     vbar_el2<span class="token punctuation">,</span> x0\n\n        <span class="token comment">/* spsr */</span>\n        mov     x0<span class="token punctuation">,</span> #<span class="token punctuation">(</span>PSR_F_BIT <span class="token operator">|</span> PSR_I_BIT <span class="token operator">|</span> PSR_A_BIT <span class="token operator">|</span> PSR_D_BIT <span class="token operator">|</span>\\\n                      PSR_MODE_EL1h<span class="token punctuation">)</span>\n        msr     spsr_el2<span class="token punctuation">,</span> x0\n        msr     elr_el2<span class="token punctuation">,</span> lr\n        mov     w0<span class="token punctuation">,</span> #BOOT_CPU_MODE_EL2          <span class="token comment">// This CPU booted in EL2</span>\n        eret\n<span class="token function">ENDPROC</span><span class="token punctuation">(</span>el2_setup<span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h2 id="cpu-setup" tabindex="-1"><a class="header-anchor" href="#cpu-setup" aria-hidden="true">#</a> __cpu_setup</h2><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token function">ENTRY</span><span class="token punctuation">(</span>__cpu_setup<span class="token punctuation">)</span>\n        tlbi    vmalle1                         <span class="token comment">// Invalidate local TLB</span>\n        dsb     nsh\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Dont trap accessing the Advanced SIMD and floating-point registers.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>        mov     x0<span class="token punctuation">,</span> #<span class="token number">3</span> <span class="token operator">&lt;&lt;</span> <span class="token number">20</span>\n        msr     cpacr_el1<span class="token punctuation">,</span> x0                   <span class="token comment">// Enable FP/ASIMD</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>EL0 accesses to the AArch64 DCC registers are trapped.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>        mov     x0<span class="token punctuation">,</span> #<span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">12</span>                    <span class="token comment">// Reset mdscr_el1 and disable</span>\n        msr     mdscr_el1<span class="token punctuation">,</span> x0                   <span class="token comment">// access to the DCC from EL0</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>        isb                                     <span class="token comment">// Unmask debug exceptions now,</span>\n        enable_dbg                              <span class="token comment">// since this is per-cpu</span>\n        reset_pmuserenr_el0 x0                  <span class="token comment">// Disable PMU access from EL0</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><code>mair_el1</code> provides the memory attribute encodings corresponding to the possible AttrIndx values in a Long-descriptor format translation table entry for stage 1 translations at EL1.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>        <span class="token comment">/*\n         * Memory region attributes for LPAE:\n         *\n         *   n = AttrIndx[2:0]\n         *                      n       MAIR\n         *   DEVICE_nGnRnE      000     00000000\n         *   DEVICE_nGnRE       001     00000100\n         *   DEVICE_GRE         010     00001100\n         *   NORMAL_NC          011     01000100\n         *   NORMAL             100     11111111\n         *   NORMAL_WT          101     10111011\n         */</span>\n        ldr     x5<span class="token punctuation">,</span> <span class="token operator">=</span><span class="token function">MAIR</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> MT_DEVICE_nGnRnE<span class="token punctuation">)</span> <span class="token operator">|</span> \\\n                     <span class="token function">MAIR</span><span class="token punctuation">(</span><span class="token number">0x04</span><span class="token punctuation">,</span> MT_DEVICE_nGnRE<span class="token punctuation">)</span> <span class="token operator">|</span> \\\n                     <span class="token function">MAIR</span><span class="token punctuation">(</span><span class="token number">0x0c</span><span class="token punctuation">,</span> MT_DEVICE_GRE<span class="token punctuation">)</span> <span class="token operator">|</span> \\\n                     <span class="token function">MAIR</span><span class="token punctuation">(</span><span class="token number">0x44</span><span class="token punctuation">,</span> MT_NORMAL_NC<span class="token punctuation">)</span> <span class="token operator">|</span> \\\n                     <span class="token function">MAIR</span><span class="token punctuation">(</span><span class="token number">0xff</span><span class="token punctuation">,</span> MT_NORMAL<span class="token punctuation">)</span> <span class="token operator">|</span> \\\n                     <span class="token function">MAIR</span><span class="token punctuation">(</span><span class="token number">0xbb</span><span class="token punctuation">,</span> MT_NORMAL_WT<span class="token punctuation">)</span>\n        msr     mair_el1<span class="token punctuation">,</span> x5\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>        <span class="token comment">/*\n         * Prepare SCTLR\n         */</span>\n        mov_q   x0<span class="token punctuation">,</span> SCTLR_EL1_SET\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>setup <code>tcr_el1</code> which is the control register for stage 1 of the EL1&amp;0 translation regime.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>        <span class="token comment">/*\n         * Set/prepare TCR and TTBR. We use 512GB (39-bit) address range for\n         * both user and kernel.\n         */</span>\n        ldr     x10<span class="token punctuation">,</span> <span class="token operator">=</span><span class="token function">TCR_TxSZ</span><span class="token punctuation">(</span>VA_BITS<span class="token punctuation">)</span> <span class="token operator">|</span> TCR_CACHE_FLAGS <span class="token operator">|</span> TCR_SMP_FLAGS <span class="token operator">|</span> \\\n                        TCR_TG_FLAGS <span class="token operator">|</span> TCR_KASLR_FLAGS <span class="token operator">|</span> TCR_ASID16 <span class="token operator">|</span> \\\n                        TCR_TBI0 <span class="token operator">|</span> TCR_A1 <span class="token operator">|</span> TCR_KASAN_FLAGS\n\n<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_ARM64_USER_VA_BITS_52</span></span>\n        ldr_l           x9<span class="token punctuation">,</span> vabits_user\n        sub             x9<span class="token punctuation">,</span> xzr<span class="token punctuation">,</span> x9\n        add             x9<span class="token punctuation">,</span> x9<span class="token punctuation">,</span> #<span class="token number">64</span>\n<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>\n        ldr_l           x9<span class="token punctuation">,</span> idmap_t0sz\n<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>\n        tcr_set_t0sz    x10<span class="token punctuation">,</span> x9\n\n        <span class="token comment">/*\n         * Set the IPS bits in TCR_EL1.\n         */</span>\n        tcr_compute_pa_size x10<span class="token punctuation">,</span> #TCR_IPS_SHIFT<span class="token punctuation">,</span> x5<span class="token punctuation">,</span> x6\n<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_ARM64_HW_AFDBM</span></span>\n        <span class="token comment">/*\n         * Enable hardware update of the Access Flags bit.\n         * Hardware dirty bit management is enabled later,\n         * via capabilities.\n         */</span>\n        mrs     x9<span class="token punctuation">,</span> ID_AA64MMFR1_EL1\n        and     x9<span class="token punctuation">,</span> x9<span class="token punctuation">,</span> #<span class="token number">0xf</span>\n        cbz     x9<span class="token punctuation">,</span> <span class="token number">1f</span>\n        orr     x10<span class="token punctuation">,</span> x10<span class="token punctuation">,</span> #TCR_HA               <span class="token comment">// hardware Access flag update</span>\n<span class="token number">1</span><span class="token operator">:</span>\n<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  <span class="token comment">/* CONFIG_ARM64_HW_AFDBM */</span></span>\n        msr     tcr_el1<span class="token punctuation">,</span> x10\n        ret                                     <span class="token comment">// return to head.S</span>\n<span class="token function">ENDPROC</span><span class="token punctuation">(</span>__cpu_setup<span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h2 id="create-page-tables" tabindex="-1"><a class="header-anchor" href="#create-page-tables" aria-hidden="true">#</a> create page tables</h2><p><code>__create_page_tables</code> creates initial page tables.</p><p>There are many kinds of page tables:</p><ul><li><code>idmap_pg_dir</code> identity mapping, va = pa, will be saved in <code>ttbr0_el1</code></li><li><code>init_pg_dir</code>, will be saved in <code>ttbr1_el1</code>. This page table will be freed in <code>paging_init</code> function.</li><li><code>swapper_pg_dir</code></li></ul><p>Why we need idmap:</p><blockquote><p>If the PA of the software that enables or disables a particular stage of address translation differs from its VA, speculative instruction fetching can cause complications. ARM strongly recommends that the PA and VA of any software that enables or disables a stage of address translation are identical if that stage of translation controls translations that apply to the software currently being executed.</p></blockquote><h3 id="compute-indices" tabindex="-1"><a class="header-anchor" href="#compute-indices" aria-hidden="true">#</a> compute_indices</h3><div class="custom-container warning"><p class="custom-container-title">WARNING</p><p>The comment of code is not correct.</p></div><p>return value:</p><p>istart = (vstart&gt;&gt;shift) &amp; (ptrs-1), the index of page table to vstart. iend = ((vend&gt;&gt;shift) &amp; (ptrs-1)) + (count * ptrs), the index of page table to vend. count = how many extra entries required for next page table level.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/*\n * Compute indices of table entries from virtual address range. If multiple entries\n * were needed in the previous page table level then the next page table level is assumed\n * to be composed of multiple pages. (This effectively scales the end index).\n *\n *      vstart: virtual address of start of range\n *      vend:   virtual address of end of range\n *      shift:  shift used to transform virtual address into index\n *      ptrs:   number of entries in page table\n *      istart: index in table corresponding to vstart\n *      iend:   index in table corresponding to vend\n *      count:  On entry: how many extra entries were required in previous level, scales\n *                        our end index.\n *              On exit: returns how many extra entries required for next page table level\n *\n * Preserves:   vstart, vend, shift, ptrs\n * Returns:     istart, iend, count\n */</span>\n        <span class="token punctuation">.</span>macro compute_indices<span class="token punctuation">,</span> vstart<span class="token punctuation">,</span> vend<span class="token punctuation">,</span> shift<span class="token punctuation">,</span> ptrs<span class="token punctuation">,</span> istart<span class="token punctuation">,</span> iend<span class="token punctuation">,</span> count\n        lsr     \\iend<span class="token punctuation">,</span> \\vend<span class="token punctuation">,</span> \\shift\n        mov     \\istart<span class="token punctuation">,</span> \\ptrs\n        sub     \\istart<span class="token punctuation">,</span> \\istart<span class="token punctuation">,</span> #<span class="token number">1</span>\n        and     \\iend<span class="token punctuation">,</span> \\iend<span class="token punctuation">,</span> \\istart   <span class="token comment">// iend = (vend &gt;&gt; shift) &amp; (ptrs - 1)</span>\n        mov     \\istart<span class="token punctuation">,</span> \\ptrs\n        mul     \\istart<span class="token punctuation">,</span> \\istart<span class="token punctuation">,</span> \\count\n        add     \\iend<span class="token punctuation">,</span> \\iend<span class="token punctuation">,</span> \\istart   <span class="token comment">// iend += (count - 1) * ptrs</span>\n                                        <span class="token comment">// our entries span multiple tables</span>\n\n        lsr     \\istart<span class="token punctuation">,</span> \\vstart<span class="token punctuation">,</span> \\shift\n        mov     \\count<span class="token punctuation">,</span> \\ptrs\n        sub     \\count<span class="token punctuation">,</span> \\count<span class="token punctuation">,</span> #<span class="token number">1</span>\n        and     \\istart<span class="token punctuation">,</span> \\istart<span class="token punctuation">,</span> \\count\n\n        sub     \\count<span class="token punctuation">,</span> \\iend<span class="token punctuation">,</span> \\istart\n        <span class="token punctuation">.</span>endm\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h3 id="populate-page-table" tabindex="-1"><a class="header-anchor" href="#populate-page-table" aria-hidden="true">#</a> populate page table</h3><p>The function allocates <code>eindex-index</code> the next level page tables (which is a page) and fills page table entries.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token operator">*</span>\n <span class="token operator">*</span> Macro to populate page table entries<span class="token punctuation">,</span> these entries can be pointers to the next level\n <span class="token operator">*</span> or last level entries pointing to physical memory<span class="token punctuation">.</span>\n <span class="token operator">*</span>\n <span class="token operator">*</span>      tbl<span class="token operator">:</span>    page table address\n <span class="token operator">*</span>      rtbl<span class="token operator">:</span>   pointer to page table or physical memory\n <span class="token operator">*</span>      index<span class="token operator">:</span>  start index to write\n <span class="token operator">*</span>      eindex<span class="token operator">:</span> end index to write <span class="token operator">-</span> <span class="token punctuation">[</span>index<span class="token punctuation">,</span> eindex<span class="token punctuation">]</span> written to\n <span class="token operator">*</span>      flags<span class="token operator">:</span>  flags <span class="token keyword">for</span> pagetable entry to or in\n <span class="token operator">*</span>      inc<span class="token operator">:</span>    increment to rtbl between each entry\n <span class="token operator">*</span>      tmp1<span class="token operator">:</span>   temporary variable\n <span class="token operator">*</span>\n <span class="token operator">*</span> Preserves<span class="token operator">:</span>   tbl<span class="token punctuation">,</span> eindex<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> inc\n <span class="token operator">*</span> Corrupts<span class="token operator">:</span>    index<span class="token punctuation">,</span> tmp1\n <span class="token operator">*</span> Returns<span class="token operator">:</span>     rtbl\n <span class="token operator">*</span><span class="token operator">/</span>\n        <span class="token punctuation">.</span>macro populate_entries<span class="token punctuation">,</span> tbl<span class="token punctuation">,</span> rtbl<span class="token punctuation">,</span> index<span class="token punctuation">,</span> eindex<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> inc<span class="token punctuation">,</span> tmp1\n<span class="token punctuation">.</span>Lpe\\@<span class="token operator">:</span> phys_to_pte \\tmp1<span class="token punctuation">,</span> \\rtbl\n        orr     \\tmp1<span class="token punctuation">,</span> \\tmp1<span class="token punctuation">,</span> \\flags    <span class="token comment">// tmp1 = table entry</span>\n        str     \\tmp1<span class="token punctuation">,</span> <span class="token punctuation">[</span>\\tbl<span class="token punctuation">,</span> \\index<span class="token punctuation">,</span> lsl #<span class="token number">3</span><span class="token punctuation">]</span>\n        add     \\rtbl<span class="token punctuation">,</span> \\rtbl<span class="token punctuation">,</span> \\inc      <span class="token comment">// rtbl = pa next level</span>\n        add     \\index<span class="token punctuation">,</span> \\index<span class="token punctuation">,</span> #<span class="token number">1</span>\n        cmp     \\index<span class="token punctuation">,</span> \\eindex\n        b<span class="token punctuation">.</span>ls    <span class="token punctuation">.</span>Lpe\\@\n        <span class="token punctuation">.</span>endm\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h3 id="map-memory" tabindex="-1"><a class="header-anchor" href="#map-memory" aria-hidden="true">#</a> map_memory</h3><p><code>map_memory</code> maps <code>[vstart, vend]</code> to <code>[phys, vend-vstart+phys]</code>.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/*\n * Map memory for specified virtual address range. Each level of page table needed supports\n * multiple entries. If a level requires n entries the next page table level is assumed to be\n * formed from n pages.\n *\n *      tbl:    location of page table\n *      rtbl:   address to be used for first level page table entry (typically tbl + PAGE_SIZE)\n *      vstart: start address to map\n *      vend:   end address to map - we map [vstart, vend]\n *      flags:  flags to use to map last level entries\n *      phys:   physical address corresponding to vstart - physical memory is contiguous\n *      pgds:   the number of pgd entries\n *\n * Temporaries: istart, iend, tmp, count, sv - these need to be different registers\n * Preserves:   vstart, vend, flags\n * Corrupts:    tbl, rtbl, istart, iend, tmp, count, sv\n */</span>\n        <span class="token punctuation">.</span>macro map_memory<span class="token punctuation">,</span> tbl<span class="token punctuation">,</span> rtbl<span class="token punctuation">,</span> vstart<span class="token punctuation">,</span> vend<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> phys<span class="token punctuation">,</span> pgds<span class="token punctuation">,</span> istart<span class="token punctuation">,</span> iend<span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> count<span class="token punctuation">,</span> sv\n        add \\rtbl<span class="token punctuation">,</span> \\tbl<span class="token punctuation">,</span> #PAGE_SIZE\n        mov \\sv<span class="token punctuation">,</span> \\rtbl\n        mov \\count<span class="token punctuation">,</span> #<span class="token number">0</span>\n        compute_indices \\vstart<span class="token punctuation">,</span> \\vend<span class="token punctuation">,</span> #PGDIR_SHIFT<span class="token punctuation">,</span> \\pgds<span class="token punctuation">,</span> \\istart<span class="token punctuation">,</span> \\iend<span class="token punctuation">,</span> \\count\n        populate_entries \\tbl<span class="token punctuation">,</span> \\rtbl<span class="token punctuation">,</span> \\istart<span class="token punctuation">,</span> \\iend<span class="token punctuation">,</span> #PMD_TYPE_TABLE<span class="token punctuation">,</span> #PAGE_SIZE<span class="token punctuation">,</span> \\tmp\n        mov \\tbl<span class="token punctuation">,</span> \\sv\n        mov \\sv<span class="token punctuation">,</span> \\rtbl\n\n<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">SWAPPER_PGTABLE_LEVELS <span class="token operator">&gt;</span> <span class="token number">3</span></span></span>\n        compute_indices \\vstart<span class="token punctuation">,</span> \\vend<span class="token punctuation">,</span> #PUD_SHIFT<span class="token punctuation">,</span> #PTRS_PER_PUD<span class="token punctuation">,</span> \\istart<span class="token punctuation">,</span> \\iend<span class="token punctuation">,</span> \\count\n        populate_entries \\tbl<span class="token punctuation">,</span> \\rtbl<span class="token punctuation">,</span> \\istart<span class="token punctuation">,</span> \\iend<span class="token punctuation">,</span> #PMD_TYPE_TABLE<span class="token punctuation">,</span> #PAGE_SIZE<span class="token punctuation">,</span> \\tmp\n        mov \\tbl<span class="token punctuation">,</span> \\sv\n        mov \\sv<span class="token punctuation">,</span> \\rtbl\n<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>\n\n<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">SWAPPER_PGTABLE_LEVELS <span class="token operator">&gt;</span> <span class="token number">2</span></span></span>\n        compute_indices \\vstart<span class="token punctuation">,</span> \\vend<span class="token punctuation">,</span> #SWAPPER_TABLE_SHIFT<span class="token punctuation">,</span> #PTRS_PER_PMD<span class="token punctuation">,</span> \\istart<span class="token punctuation">,</span> \\iend<span class="token punctuation">,</span> \\count\n        populate_entries \\tbl<span class="token punctuation">,</span> \\rtbl<span class="token punctuation">,</span> \\istart<span class="token punctuation">,</span> \\iend<span class="token punctuation">,</span> #PMD_TYPE_TABLE<span class="token punctuation">,</span> #PAGE_SIZE<span class="token punctuation">,</span> \\tmp\n        mov \\tbl<span class="token punctuation">,</span> \\sv\n<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>\n\n        compute_indices \\vstart<span class="token punctuation">,</span> \\vend<span class="token punctuation">,</span> #SWAPPER_BLOCK_SHIFT<span class="token punctuation">,</span> #PTRS_PER_PTE<span class="token punctuation">,</span> \\istart<span class="token punctuation">,</span> \\iend<span class="token punctuation">,</span> \\count\n        <span class="token comment">// mask physical address with (#SWAPPER_BLOCK_SIZE - 1) and store in count</span>\n        bic \\count<span class="token punctuation">,</span> \\phys<span class="token punctuation">,</span> #SWAPPER_BLOCK_SIZE <span class="token operator">-</span> <span class="token number">1</span>\n        populate_entries \\tbl<span class="token punctuation">,</span> \\count<span class="token punctuation">,</span> \\istart<span class="token punctuation">,</span> \\iend<span class="token punctuation">,</span> \\flags<span class="token punctuation">,</span> #SWAPPER_BLOCK_SIZE<span class="token punctuation">,</span> \\tmp\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><h3 id="create-page-tables-1" tabindex="-1"><a class="header-anchor" href="#create-page-tables-1" aria-hidden="true">#</a> __create_page_tables</h3><p><code>__create_page_tables</code> creates two mapping:</p><ol><li><code>[__idmap_text_start, __idmap_text_end]</code> to <code>[__idmap_text_start, __idmap_text_end]</code> in page table <code>idmap_pg_dir</code></li><li><code>[KIMAGE_VADDR + TEXT_OFFSET + kaslr, KIMAGE_VADDR + TEXT_OFFSET + kaslr + _end - _text]</code> to <code>[_text, _end]</code> in page table <code>init_pg_dir</code></li></ol><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>__create_page_tables:\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>        mov     x28, lr\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>        /*\n         * Invalidate the init page tables to avoid potential dirty cache lines\n         * being evicted. Other page tables are allocated in rodata as part of\n         * the kernel image, and thus are clean to the PoC per the boot\n         * protocol.\n         */\n        adrp    x0, init_pg_dir\n        adrp    x1, init_pg_end\n        sub     x1, x1, x0\n        bl      __inval_dcache_area\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>invalidate dcache from <code>init_pg_dir</code> to <code>init_pg_end</code>.</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>        /*\n         * Clear the init page tables.\n         */\n        adrp    x0, init_pg_dir\n        adrp    x1, init_pg_end\n        sub     x1, x1, x0\n1:      stp     xzr, xzr, [x0], #16\n        stp     xzr, xzr, [x0], #16\n        stp     xzr, xzr, [x0], #16\n        stp     xzr, xzr, [x0], #16\n        subs    x1, x1, #64\n        b.ne    1b\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>zero out from <code>init_pg_dir</code> to <code>init_pg_end</code>. It&#39;s a loop, each iteration clear 64bytes.</p><p>Now we are goint to create page tables.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>        mov     x7<span class="token punctuation">,</span> SWAPPER_MM_MMUFLAGS\n\n        <span class="token comment">/*\n         * Create the identity mapping.\n         */</span>\n        adrp    x0<span class="token punctuation">,</span> idmap_pg_dir\n        adrp    x3<span class="token punctuation">,</span> __idmap_text_start          <span class="token comment">// __pa(__idmap_text_start)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>The following code handles va bit extension</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>#ifdef CONFIG_ARM64_VA_BITS_52\n        mrs_s   x6, SYS_ID_AA64MMFR2_EL1\n        and     x6, x6, #(0xf &lt;&lt; ID_AA64MMFR2_LVA_SHIFT)\n        mov     x5, #52\n        cbnz    x6, 1f\n#endif\n        mov     x5, #VA_BITS_MIN\n1:\n        adr_l   x6, vabits_actual\n        str     x5, [x6]\n        dmb     sy\n        dc      ivac, x6                // Invalidate potentially stale cache line\n\n        /*\n         * VA_BITS may be too small to allow for an ID mapping to be created\n         * that covers system RAM if that is located sufficiently high in the\n         * physical address space. So for the ID map, use an extended virtual\n         * range in that case, and configure an additional translation level\n         * if needed.\n         *\n         * Calculate the maximum allowed value for TCR_EL1.T0SZ so that the\n         * entire ID map region can be mapped. As T0SZ == (64 - #bits used),\n         * this number conveniently equals the number of leading zeroes in\n         * the physical address of __idmap_text_end.\n         */\n        adrp    x5, __idmap_text_end\n        clz     x5, x5\n        cmp     x5, TCR_T0SZ(VA_BITS)   // default T0SZ small enough?\n        b.ge    1f                      // .. then skip VA range extension\n\n        adr_l   x6, idmap_t0sz\n        str     x5, [x6]\n        dmb     sy\n        dc      ivac, x6                // Invalidate potentially stale cache line\n\n#if (VA_BITS &lt; 48)\n#define EXTRA_SHIFT     (PGDIR_SHIFT + PAGE_SHIFT - 3)\n#define EXTRA_PTRS      (1 &lt;&lt; (PHYS_MASK_SHIFT - EXTRA_SHIFT))\n\n        /*\n         * If VA_BITS &lt; 48, we have to configure an additional table level.\n         * First, we have to verify our assumption that the current value of\n         * VA_BITS was chosen such that all translation levels are fully\n         * utilised, and that lowering T0SZ will always result in an additional\n         * translation level to be configured.\n         */\n#if VA_BITS != EXTRA_SHIFT\n#error &quot;Mismatch between VA_BITS and page size/number of translation levels&quot;\n#endif\n\n        mov     x4, EXTRA_PTRS\n        create_table_entry x0, x3, EXTRA_SHIFT, x4, x5, x6\n#else\n        /*\n         * If VA_BITS == 48, we don&#39;t have to configure an additional\n         * translation level, but the top-level table has more entries.\n         */\n        mov     x4, #1 &lt;&lt; (PHYS_MASK_SHIFT - PGDIR_SHIFT)\n        str_l   x4, idmap_ptrs_per_pgd, x5\n#endif\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token number">1</span><span class="token operator">:</span>\n        ldr_l   x4<span class="token punctuation">,</span> idmap_ptrs_per_pgd\n        mov     x5<span class="token punctuation">,</span> x3                          <span class="token comment">// __pa(__idmap_text_start)</span>\n        adr_l   x6<span class="token punctuation">,</span> __idmap_text_end            <span class="token comment">// __pa(__idmap_text_end)</span>\n\n        map_memory x0<span class="token punctuation">,</span> x1<span class="token punctuation">,</span> x3<span class="token punctuation">,</span> x6<span class="token punctuation">,</span> x7<span class="token punctuation">,</span> x3<span class="token punctuation">,</span> x4<span class="token punctuation">,</span> x10<span class="token punctuation">,</span> x11<span class="token punctuation">,</span> x12<span class="token punctuation">,</span> x13<span class="token punctuation">,</span> x14\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>Mapping kernel image in <code>init_pg_dir</code> page table.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>        <span class="token comment">/*\n         * Map the kernel image (starting with PHYS_OFFSET).\n         */</span>\n        adrp    x0<span class="token punctuation">,</span> init_pg_dir\n        mov_q   x5<span class="token punctuation">,</span> KIMAGE_VADDR <span class="token operator">+</span> TEXT_OFFSET  <span class="token comment">// compile time __va(_text)</span>\n        add     x5<span class="token punctuation">,</span> x5<span class="token punctuation">,</span> x23                     <span class="token comment">// add KASLR displacement</span>\n        mov     x4<span class="token punctuation">,</span> PTRS_PER_PGD\n        adrp    x6<span class="token punctuation">,</span> _end                        <span class="token comment">// runtime __pa(_end)</span>\n        adrp    x3<span class="token punctuation">,</span> _text                       <span class="token comment">// runtime __pa(_text)</span>\n        sub     x6<span class="token punctuation">,</span> x6<span class="token punctuation">,</span> x3                      <span class="token comment">// _end - _text</span>\n        add     x6<span class="token punctuation">,</span> x6<span class="token punctuation">,</span> x5                      <span class="token comment">// runtime __va(_end)</span>\n\n        map_memory x0<span class="token punctuation">,</span> x1<span class="token punctuation">,</span> x5<span class="token punctuation">,</span> x6<span class="token punctuation">,</span> x7<span class="token punctuation">,</span> x3<span class="token punctuation">,</span> x4<span class="token punctuation">,</span> x10<span class="token punctuation">,</span> x11<span class="token punctuation">,</span> x12<span class="token punctuation">,</span> x13<span class="token punctuation">,</span> x14\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>flushing <code>[idmap_pg_dir, init_pg_end]</code>.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>        <span class="token comment">/*\n         * Since the page tables have been populated with non-cacheable\n         * accesses (MMU disabled), invalidate the idmap and swapper page\n         * tables again to remove any speculatively loaded cache lines.\n         */</span>\n        adrp    x0<span class="token punctuation">,</span> idmap_pg_dir\n        adrp    x1<span class="token punctuation">,</span> init_pg_end\n        sub     x1<span class="token punctuation">,</span> x1<span class="token punctuation">,</span> x0\n        dmb     sy\n        bl      __inval_dcache_area\n\n        ret     x28\n<span class="token function">ENDPROC</span><span class="token punctuation">(</span>__create_page_tables<span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="primary-switch" tabindex="-1"><a class="header-anchor" href="#primary-switch" aria-hidden="true">#</a> __primary_switch</h2><div class="custom-container warning"><p class="custom-container-title">WARNING</p><p>We removed some code related to kaslr, see KASLR chapter for more details.</p></div><p>This function enables mmu and jump to <code>__primary_switched</code>.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>__primary_switch<span class="token operator">:</span>\n        adrp    x1<span class="token punctuation">,</span> init_pg_dir\n        bl      __enable_mmu\n\n        ldr     x8<span class="token punctuation">,</span> <span class="token operator">=</span>__primary_switched\n        adrp    x0<span class="token punctuation">,</span> __PHYS_OFFSET\n        br      x8\n<span class="token function">ENDPROC</span><span class="token punctuation">(</span>__primary_switch<span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="primary-switched" tabindex="-1"><a class="header-anchor" href="#primary-switched" aria-hidden="true">#</a> __primary_switched</h2><div class="custom-container warning"><p class="custom-container-title">WARNING</p><p>We removed some code related to kaslr, see KASLR chapter for more details.</p></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>__primary_switched<span class="token operator">:</span>\n        adrp    x4<span class="token punctuation">,</span> init_thread_union\n        add     sp<span class="token punctuation">,</span> x4<span class="token punctuation">,</span> #THREAD_SIZE\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>points current <code>SP</code> to <code>init_thread_union + #THREAD_SIZE</code>.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>        adr_l   x5<span class="token punctuation">,</span> init_task\n        msr     sp_el0<span class="token punctuation">,</span> x5                      <span class="token comment">// Save thread_info</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><code>sp_el0</code> points to <code>init_task</code>.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>        adr_l   x8<span class="token punctuation">,</span> vectors                     <span class="token comment">// load VBAR_EL1 with virtual</span>\n        msr     vbar_el1<span class="token punctuation">,</span> x8                    <span class="token comment">// vector table address</span>\n        isb\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>setup exception vectors (see kernel/entry.S).</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>        stp     xzr<span class="token punctuation">,</span> x30<span class="token punctuation">,</span> <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token operator">!</span>\n        mov     x29<span class="token punctuation">,</span> sp\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>        str_l   x21<span class="token punctuation">,</span> __fdt_pointer<span class="token punctuation">,</span> x5          <span class="token comment">// Save FDT pointer</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>Save the addres of dbt into <code>__fdt_pointer</code> for <code>kaslr_early_init</code>, we ignore it here.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>        ldr_l   x4<span class="token punctuation">,</span> kimage_vaddr                <span class="token comment">// Save the offset between</span>\n        sub     x4<span class="token punctuation">,</span> x4<span class="token punctuation">,</span> x0                      <span class="token comment">// the kernel virtual and</span>\n        str_l   x4<span class="token punctuation">,</span> kimage_voffset<span class="token punctuation">,</span> x5          <span class="token comment">// physical mappings</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>save <code>kimage_vaddr - __PHYS_OFFSET</code> into <code>kimage_voffset</code>. The offset between the kernel virtual and physical mappings. Used to translate virtual to physical addresses.</p><p>See <code>Documentation/admin-guide/kdump/vmcoreinfo.rst</code>.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>        <span class="token comment">// Clear BSS</span>\n        adr_l   x0<span class="token punctuation">,</span> __bss_start\n        mov     x1<span class="token punctuation">,</span> xzr\n        adr_l   x2<span class="token punctuation">,</span> __bss_stop\n        sub     x2<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> x0\n        bl      __pi_memset\n        dsb     ishst                           <span class="token comment">// Make zero page visible to PTW</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>clears bss section.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>        add     sp<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> #<span class="token number">16</span>\n        mov     x29<span class="token punctuation">,</span> #<span class="token number">0</span>\n        mov     x30<span class="token punctuation">,</span> #<span class="token number">0</span>\n        b       start_kernel\n<span class="token function">ENDPROC</span><span class="token punctuation">(</span>__primary_switched<span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>jumps to <code>start_kernel</code>.</p><h2 id="reference" tabindex="-1"><a class="header-anchor" href="#reference" aria-hidden="true">#</a> Reference</h2><blockquote><p>https://evsio0n.com/archives/316/</p></blockquote><blockquote><p>http://gngshn.github.io/2017/11/30/arm64-linux启动流程分析08-正式跳入内核空间虚拟地址段运行/</p></blockquote><blockquote><p>Documentation/admin-guide/kdump/vmcoreinfo.rst</p></blockquote>',112),p={render:function(n,s){return e}}}}]);