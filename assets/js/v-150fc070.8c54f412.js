"use strict";(self.webpackChunknotebook=self.webpackChunknotebook||[]).push([[2483],{2824:(n,s,a)=>{a.r(s),a.d(s,{data:()=>p});const p={key:"v-150fc070",path:"/kernel/trace/lockup.html",title:"lockup detection",lang:"en-US",frontmatter:{},excerpt:"",headers:[{level:2,title:"Soft lockup",slug:"soft-lockup",children:[{level:3,title:"detect",slug:"detect",children:[]},{level:3,title:"timeout",slug:"timeout",children:[]}]},{level:2,title:"Hard lockup",slug:"hard-lockup",children:[{level:3,title:"initialize",slug:"initialize",children:[]},{level:3,title:"feed",slug:"feed",children:[]},{level:3,title:"timeout",slug:"timeout-1",children:[]},{level:3,title:"detect",slug:"detect-1",children:[]}]}],filePathRelative:"kernel/trace/lockup.md",git:{updatedTime:1626850534e3,contributors:[{name:"Zhang Junyu",email:"zhangjunyu.92@bytedance.com",commits:1}]}}},1849:(n,s,a)=>{a.r(s),a.d(s,{default:()=>t});const p=(0,a(6252).uE)('<h1 id="lockup-detection" tabindex="-1"><a class="header-anchor" href="#lockup-detection" aria-hidden="true">#</a> lockup detection</h1><p>The linux kernel can act as a watchdog to detect both soft and hard lockups.</p><ul><li>soft lockup: bug that cuases the kernel to loop in kernel mode for more than 20 seconds, without giving other tasks a chance to run</li><li>hard lockup: bug that causes the CPU to loop in kernel mode for more than 10 seconds, without letting other interrupts have a chance to run</li></ul><p>Soft lockup is built upon hrtimer, hard lockup is built upon nmi.</p><h2 id="soft-lockup" tabindex="-1"><a class="header-anchor" href="#soft-lockup" aria-hidden="true">#</a> Soft lockup</h2><p>The watchdog task is a high priority kernel thread that updates a timestamp every time it is scheduled. If that timestamp is not updated for 2*watchdog_thresh seconds (the softlockup threshold) the &#39;softlockup detector&#39; (coded inside the hrtimer callback function) will dump useful debug information to the system log, after which it will call panic if it was instructed to do so or resume execution of other kernel code.</p><h3 id="detect" tabindex="-1"><a class="header-anchor" href="#detect" aria-hidden="true">#</a> detect</h3><p>Soft lockup is detected within the handler of hrtimer.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">enum</span> <span class="token class-name">hrtimer_restart</span> <span class="token function">watchdog_timer_fn</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">hrtimer</span> <span class="token operator">*</span>hrtimer<span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> touch_ts <span class="token operator">=</span> <span class="token function">__this_cpu_read</span><span class="token punctuation">(</span>watchdog_touch_ts<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">struct</span> <span class="token class-name">pt_regs</span> <span class="token operator">*</span>regs <span class="token operator">=</span> <span class="token function">get_irq_regs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">int</span> duration<span class="token punctuation">;</span>\n        <span class="token keyword">int</span> softlockup_all_cpu_backtrace <span class="token operator">=</span> sysctl_softlockup_all_cpu_backtrace<span class="token punctuation">;</span>\n\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>watchdog_enabled<span class="token punctuation">)</span>\n                <span class="token keyword">return</span> HRTIMER_NORESTART<span class="token punctuation">;</span>\n\n        <span class="token comment">/* kick the hardlockup detector */</span>\n        <span class="token function">watchdog_interrupt_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token comment">/* kick the softlockup detector */</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">completion_done</span><span class="token punctuation">(</span><span class="token function">this_cpu_ptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>softlockup_completion<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token function">reinit_completion</span><span class="token punctuation">(</span><span class="token function">this_cpu_ptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>softlockup_completion<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token function">stop_one_cpu_nowait</span><span class="token punctuation">(</span><span class="token function">smp_processor_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n                                softlockup_fn<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>\n                                <span class="token function">this_cpu_ptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>softlockup_stop_work<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token comment">/* .. and repeat */</span>\n        <span class="token function">hrtimer_forward_now</span><span class="token punctuation">(</span>hrtimer<span class="token punctuation">,</span> <span class="token function">ns_to_ktime</span><span class="token punctuation">(</span>sample_period<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>touch_ts <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token function">__this_cpu_read</span><span class="token punctuation">(</span>softlockup_touch_sync<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                        <span class="token comment">/*\n                         * If the time stamp was touched atomically\n                         * make sure the scheduler tick is up to date.\n                         */</span>\n                        <span class="token function">__this_cpu_write</span><span class="token punctuation">(</span>softlockup_touch_sync<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                        <span class="token function">sched_clock_tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token punctuation">}</span>\n\n                <span class="token comment">/* Clear the guest paused flag on watchdog reset */</span>\n                <span class="token function">kvm_check_and_clear_guest_paused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token function">__touch_watchdog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token keyword">return</span> HRTIMER_RESTART<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token comment">/* check for a softlockup\n         * This is done by making sure a high priority task is\n         * being scheduled.  The task touches the watchdog to\n         * indicate it is getting cpu time.  If it hasn&#39;t then\n         * this is a good indication some task is hogging the cpu\n         */</span>\n        duration <span class="token operator">=</span> <span class="token function">is_softlockup</span><span class="token punctuation">(</span>touch_ts<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token comment">/*\n                 * If a virtual machine is stopped by the host it can look to\n                 * the watchdog like a soft lockup, check to see if the host\n                 * stopped the vm before we issue the warning\n                 */</span>\n                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">kvm_check_and_clear_guest_paused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n                        <span class="token keyword">return</span> HRTIMER_RESTART<span class="token punctuation">;</span>\n\n                <span class="token comment">/* only warn once */</span>\n                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__this_cpu_read</span><span class="token punctuation">(</span>soft_watchdog_warn<span class="token punctuation">)</span> <span class="token operator">==</span> true<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                        <span class="token comment">/*\n                         * When multiple processes are causing softlockups the\n                         * softlockup detector only warns on the first one\n                         * because the code relies on a full quiet cycle to\n                         * re-arm.  The second process prevents the quiet cycle\n                         * and never gets reported.  Use task pointers to detect\n                         * this.\n                         */</span>\n                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__this_cpu_read</span><span class="token punctuation">(</span>softlockup_task_ptr_saved<span class="token punctuation">)</span> <span class="token operator">!=</span>\n                            current<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                                <span class="token function">__this_cpu_write</span><span class="token punctuation">(</span>soft_watchdog_warn<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                                <span class="token function">__touch_watchdog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                        <span class="token punctuation">}</span>\n                        <span class="token keyword">return</span> HRTIMER_RESTART<span class="token punctuation">;</span>\n                <span class="token punctuation">}</span>\n\n                <span class="token keyword">if</span> <span class="token punctuation">(</span>softlockup_all_cpu_backtrace<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                        <span class="token comment">/* Prevent multiple soft-lockup reports if one cpu is already\n                         * engaged in dumping cpu back traces\n                         */</span>\n                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">test_and_set_bit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>soft_lockup_nmi_warn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                                <span class="token comment">/* Someone else will report us. Let&#39;s give up */</span>\n                                <span class="token function">__this_cpu_write</span><span class="token punctuation">(</span>soft_watchdog_warn<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                                <span class="token keyword">return</span> HRTIMER_RESTART<span class="token punctuation">;</span>\n                        <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n\n                <span class="token function">pr_emerg</span><span class="token punctuation">(</span><span class="token string">&quot;BUG: soft lockup - CPU#%d stuck for %us! [%s:%d]\\n&quot;</span><span class="token punctuation">,</span>\n                        <span class="token function">smp_processor_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> duration<span class="token punctuation">,</span>\n                        current<span class="token operator">-&gt;</span>comm<span class="token punctuation">,</span> <span class="token function">task_pid_nr</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token function">__this_cpu_write</span><span class="token punctuation">(</span>softlockup_task_ptr_saved<span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token function">print_modules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token function">print_irqtrace_events</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token keyword">if</span> <span class="token punctuation">(</span>regs<span class="token punctuation">)</span>\n                        <span class="token function">show_regs</span><span class="token punctuation">(</span>regs<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token keyword">else</span>\n                        <span class="token function">dump_stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n                <span class="token keyword">if</span> <span class="token punctuation">(</span>softlockup_all_cpu_backtrace<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                        <span class="token comment">/* Avoid generating two back traces for current\n                         * given that one is already made above\n                         */</span>\n                        <span class="token function">trigger_allbutself_cpu_backtrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n                        <span class="token function">clear_bit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>soft_lockup_nmi_warn<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                        <span class="token comment">/* Barrier to sync with other cpus */</span>\n                        <span class="token function">smp_mb__after_atomic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token punctuation">}</span>\n\n                <span class="token function">add_taint</span><span class="token punctuation">(</span>TAINT_SOFTLOCKUP<span class="token punctuation">,</span> LOCKDEP_STILL_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token keyword">if</span> <span class="token punctuation">(</span>softlockup_panic<span class="token punctuation">)</span>\n                        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;softlockup: hung tasks&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token function">__this_cpu_write</span><span class="token punctuation">(</span>soft_watchdog_warn<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span>\n                <span class="token function">__this_cpu_write</span><span class="token punctuation">(</span>soft_watchdog_warn<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">return</span> HRTIMER_RESTART<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br></div></div><h3 id="timeout" tabindex="-1"><a class="header-anchor" href="#timeout" aria-hidden="true">#</a> timeout</h3><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">is_softlockup</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> touch_ts<span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token function">get_timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>watchdog_enabled <span class="token operator">&amp;</span> SOFT_WATCHDOG_ENABLED<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> watchdog_thresh<span class="token punctuation">)</span><span class="token punctuation">{</span>\n                <span class="token comment">/* Warn about unreasonable delays. */</span>\n                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">time_after</span><span class="token punctuation">(</span>now<span class="token punctuation">,</span> touch_ts <span class="token operator">+</span> <span class="token function">get_softlockup_thresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n                        <span class="token keyword">return</span> now <span class="token operator">-</span> touch_ts<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="hard-lockup" tabindex="-1"><a class="header-anchor" href="#hard-lockup" aria-hidden="true">#</a> Hard lockup</h2><p>A periodic hrtimer runs to generate interrupts and kick the watchdog task. An NMI perf event is generated every &quot;watchdog_thresh&quot; (compile-time initialized to 10 and configurable through sysctl of the same name) seconds to check for hardlockups. If any CPU in the system does not receive any hrtimer interrupt during that time the &#39;hardlockup detector&#39; (the handler for the NMI perf event) will generate a kernel warning or call panic, depending on the configuration.</p><h3 id="initialize" tabindex="-1"><a class="header-anchor" href="#initialize" aria-hidden="true">#</a> initialize</h3><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">hardlockup_detector_event_create</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cpu <span class="token operator">=</span> <span class="token function">smp_processor_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">struct</span> <span class="token class-name">perf_event_attr</span> <span class="token operator">*</span>wd_attr<span class="token punctuation">;</span>\n        <span class="token keyword">struct</span> <span class="token class-name">perf_event</span> <span class="token operator">*</span>evt<span class="token punctuation">;</span>\n\n        wd_attr <span class="token operator">=</span> <span class="token operator">&amp;</span>wd_hw_attr<span class="token punctuation">;</span>\n        wd_attr<span class="token operator">-&gt;</span>sample_period <span class="token operator">=</span> <span class="token function">hw_nmi_get_sample_period</span><span class="token punctuation">(</span>watchdog_thresh<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token comment">/* Try to register using hardware perf events */</span>\n        evt <span class="token operator">=</span> <span class="token function">perf_event_create_kernel_counter</span><span class="token punctuation">(</span>wd_attr<span class="token punctuation">,</span> cpu<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>\n                                               watchdog_overflow_callback<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">&quot;Perf event create on CPU %d failed with %ld\\n&quot;</span><span class="token punctuation">,</span> cpu<span class="token punctuation">,</span>\n                         <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token function">this_cpu_write</span><span class="token punctuation">(</span>watchdog_ev<span class="token punctuation">,</span> evt<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="feed" tabindex="-1"><a class="header-anchor" href="#feed" aria-hidden="true">#</a> feed</h3><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">watchdog_interrupt_count</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n        <span class="token function">__this_cpu_inc</span><span class="token punctuation">(</span>hrtimer_interrupts<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">/* watchdog kicker functions */</span>\n<span class="token keyword">static</span> <span class="token keyword">enum</span> <span class="token class-name">hrtimer_restart</span> <span class="token function">watchdog_timer_fn</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">hrtimer</span> <span class="token operator">*</span>hrtimer<span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> touch_ts <span class="token operator">=</span> <span class="token function">__this_cpu_read</span><span class="token punctuation">(</span>watchdog_touch_ts<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">struct</span> <span class="token class-name">pt_regs</span> <span class="token operator">*</span>regs <span class="token operator">=</span> <span class="token function">get_irq_regs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">int</span> duration<span class="token punctuation">;</span>\n        <span class="token keyword">int</span> softlockup_all_cpu_backtrace <span class="token operator">=</span> sysctl_softlockup_all_cpu_backtrace<span class="token punctuation">;</span>\n\n        <span class="token comment">// ...</span>\n\n        <span class="token comment">/* kick the hardlockup detector */</span>\n        <span class="token function">watchdog_interrupt_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n\t<span class="token comment">// ...</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="timeout-1" tabindex="-1"><a class="header-anchor" href="#timeout-1" aria-hidden="true">#</a> timeout</h3><p>If the <code>hrtimer_interrupts</code> was not updated, a hard lockup happended.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* watchdog detector functions */</span>\nbool <span class="token function">is_hardlockup</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> hrint <span class="token operator">=</span> <span class="token function">__this_cpu_read</span><span class="token punctuation">(</span>hrtimer_interrupts<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__this_cpu_read</span><span class="token punctuation">(</span>hrtimer_interrupts_saved<span class="token punctuation">)</span> <span class="token operator">==</span> hrint<span class="token punctuation">)</span>\n                <span class="token keyword">return</span> true<span class="token punctuation">;</span>\n\n        <span class="token function">__this_cpu_write</span><span class="token punctuation">(</span>hrtimer_interrupts_saved<span class="token punctuation">,</span> hrint<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> false<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="detect-1" tabindex="-1"><a class="header-anchor" href="#detect-1" aria-hidden="true">#</a> detect</h3><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">watchdog_overflow_callback</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">perf_event</span> <span class="token operator">*</span>event<span class="token punctuation">,</span>\n                                       <span class="token keyword">struct</span> <span class="token class-name">perf_sample_data</span> <span class="token operator">*</span>data<span class="token punctuation">,</span>\n                                       <span class="token keyword">struct</span> <span class="token class-name">pt_regs</span> <span class="token operator">*</span>regs<span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n        <span class="token comment">/* Ensure the watchdog never gets throttled */</span>\n        event<span class="token operator">-&gt;</span>hw<span class="token punctuation">.</span>interrupts <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__this_cpu_read</span><span class="token punctuation">(</span>watchdog_nmi_touch<span class="token punctuation">)</span> <span class="token operator">==</span> true<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token function">__this_cpu_write</span><span class="token punctuation">(</span>watchdog_nmi_touch<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token keyword">return</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">watchdog_check_timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n                <span class="token keyword">return</span><span class="token punctuation">;</span>\n\n        <span class="token comment">/* check for a hardlockup\n         * This is done by making sure our timer interrupt\n         * is incrementing.  The timer interrupt should have\n         * fired multiple times before we overflow&#39;d.  If it hasn&#39;t\n         * then this is a good indication the cpu is stuck\n         */</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_hardlockup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token keyword">int</span> this_cpu <span class="token operator">=</span> <span class="token function">smp_processor_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n                <span class="token comment">/* only print hardlockups once */</span>\n                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__this_cpu_read</span><span class="token punctuation">(</span>hard_watchdog_warn<span class="token punctuation">)</span> <span class="token operator">==</span> true<span class="token punctuation">)</span>\n                        <span class="token keyword">return</span><span class="token punctuation">;</span>\n\n                <span class="token function">pr_emerg</span><span class="token punctuation">(</span><span class="token string">&quot;Watchdog detected hard LOCKUP on cpu %d\\n&quot;</span><span class="token punctuation">,</span>\n                         this_cpu<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token function">print_modules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token function">print_irqtrace_events</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token keyword">if</span> <span class="token punctuation">(</span>regs<span class="token punctuation">)</span>\n                        <span class="token function">show_regs</span><span class="token punctuation">(</span>regs<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token keyword">else</span>\n                        <span class="token function">dump_stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n                <span class="token comment">/*\n                 * Perform all-CPU dump only once to avoid multiple hardlockups\n                 * generating interleaving traces\n                 */</span>\n                <span class="token keyword">if</span> <span class="token punctuation">(</span>sysctl_hardlockup_all_cpu_backtrace <span class="token operator">&amp;&amp;</span>\n                                <span class="token operator">!</span><span class="token function">test_and_set_bit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hardlockup_allcpu_dumped<span class="token punctuation">)</span><span class="token punctuation">)</span>\n                        <span class="token function">trigger_allbutself_cpu_backtrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n                <span class="token keyword">if</span> <span class="token punctuation">(</span>hardlockup_panic<span class="token punctuation">)</span>\n                        <span class="token function">nmi_panic</span><span class="token punctuation">(</span>regs<span class="token punctuation">,</span> <span class="token string">&quot;Hard LOCKUP&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n                <span class="token function">__this_cpu_write</span><span class="token punctuation">(</span>hard_watchdog_warn<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token keyword">return</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token function">__this_cpu_write</span><span class="token punctuation">(</span>hard_watchdog_warn<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div>',22),t={render:function(n,s){return p}}}}]);